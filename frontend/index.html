
 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>NEUROBUDDYY.ai</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  
  <!-- ========== FIREBASE INTEGRATION ========== -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs,getDoc, query, where, updateDoc, doc, serverTimestamp, orderBy, limit, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ‚úÖ ADD THIS LINE - Firebase Authentication
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDnsuheauVnhqUcIhCyEXCNSNBdS1PQkII",
      authDomain: "neurobuddyy-ai-7f500.firebaseapp.com",
      projectId: "neurobuddyy-ai-7f500",
      storageBucket: "neurobuddyy-ai-7f500.firebasestorage.app",
      messagingSenderId: "965241116528",
      appId: "1:965241116528:web:ce58e789433a5a5d3b61b5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // Make Firebase available globally
    window.firebaseDB = db;
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firestoreFunctions = { collection, addDoc, getDocs,getDoc, query, where, updateDoc, doc, serverTimestamp, orderBy, limit, deleteDoc, onSnapshot };
    window.authFunctions = {
    createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential
    };

    console.log("‚úÖ Firebase initialized successfully!");
    console.log("√∞≈∏‚Äú≈† Firestore Auth ready:", auth);
    
  </script>
  <!-- ========== END FIREBASE INTEGRATION ========== -->

  


  <style>
    /* [KEEP ALL YOUR EXISTING CSS - NO CHANGES] */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f0f4f8;
    }

    .topbar {
      background: #060000;
      color: #fff;
      text-align: center;
      font-size: 1.7rem;
      font-weight: bold;
      padding: 17px;
      position: relative;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .hamburger {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.8rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    .container {
      flex: 1;
      display: flex;
      height:calc(100vh - 60px);
    }

    .leftbar {
      width: 0;
      background: #d4faff;
      border-right: 8px solid #a8ebf9;
      overflow-y: auto;
      transition: width 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .leftbar.open {
      width: 220px;
      padding: 15px;
    }

    .menu {
      list-style: none;
      padding: 0;
    }

    .menu li {
      padding: 10px;
      margin-bottom: 8px;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 500;
    }

    .menu li:hover {
      background: #7a9fef;
      color: #fff;
    }

    .settings {
      margin-top: auto;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
    }

    .settings:hover {
      background: #7a9adf;
      color: rgb(255, 255, 255);
    }

    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f9fafb;
      position: relative;
    }

    .chat-window {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .chat-window div {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 15px;
      line-height: 1.4;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }

    .bot-msg {
      background: #2575d6;
      color: #ffffff;
      text-align: left;
    }

    .user-msg {
      background:linear-gradient(rgb(144, 179, 214) 0%,rgb(168, 242, 161) 20%);
      color: rgb(0, 0, 0);
      text-align: right;
      margin-left: auto;
    }

    .top-typing-box {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 20px;
      margin: 10px 16px;
      border-radius: 15px;
      display: none;
      min-height: 60px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      animation: slideDown 0.4s ease;
    }

    .top-typing-box.active {
      display: block;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .typing-title {
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 8px;
      opacity: 0.8;
      text-transform: uppercase;
    }

    #topTypingContent {
      font-size: 1.1rem;
      line-height: 1.5;
      font-weight: 500;
    }

    .suggestions-box {
      background: #ffffff;
      border-top: 3px solid #2563eb;
      border-bottom: 3px solid #2563eb;
      padding: 12px 16px;
      display: none;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .suggestions-box.active {
      display: block;
    }

    .suggestions-title {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .suggestion-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
      transition: all 0.2s;
      border-radius: 5px;
      margin-bottom: 5px;
      background: #f9fafb;
      font-size: 0.9rem;
    }

    .suggestion-item:hover {
      background: #2563eb;
      color: white;
      transform: translateX(5px);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .no-suggestions {
      text-align: center;
      color: #999;
      padding: 15px;
      font-style: italic;
      font-size: 0.9rem;
    }

    .search-bar {
      flex:0 0 60px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-top: 5px solid #ffffff;
      background: white;
      padding: 12px;
    }

    .search-bar input {
      flex: 1;
      border: 2px solid #9fbff0c1;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.95rem;
      outline: none;
    }

    .btn{
      display:flex;
      gap:10px;
      padding: 10px 12px;
      border-radius: 8px;
      color: rgb(236, 223, 215);
      font-weight: bold;
      cursor: pointer;
      border: 2px solid;
      transition: 0.1s;
    }

    .btn:hover { transform: scale(1.05); }
    .mic { background: #95b1ea; }
    .upload { background: #fef8df; }
    .send { background: #6b7280; }

    .rightbar {
      width: 25%;
      background: white;
      border-left: 8px solid #ffffff;
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .emergency {
      background: #dc2626;
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 12px;
      cursor: pointer;
      border: none;
    }
    .emergency:hover { background: #b91c1c; }

    .connect-doctor {
      background: #2563eb;
      color: white;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      border: none;
      transition: 0.2s;
    }
    .connect-doctor:hover { background: #1d4ed8; }
    /* Patient notification badge */
.patient-count-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #ef4444;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: bold;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
  animation: pulse 2s infinite;
}


    #doctorListContainer {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-in-out;
      background: #f0f4f8;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    #doctorListContainer.expanded {
      min-height: 300px !important;
      max-height: none !important;
      height: 300px !important;
      padding: 15px;
      border: 2px solid #2563eb;
      overflow-y:auto;
      overflow-x:hidden;
      margin-bottom: 20px;
      animation :slideDown 0.4s ease-out ;
    }

    .doctor-card {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #doctorList {
    }

    .doctor-card:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      background:  linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .doctor-info {
      flex-grow: 1;
    }

    .doctor-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 3px;
      font-size: 0.95rem;
    }

    .doctor-specialty {
      font-size: 0.8rem;
      color: #666;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 10px;
    }

    .status-available {
      background: #10b981;
      box-shadow: 0 0 8px #10b981;
      animation: pulse 2s infinite;
    }

    .status-engaged {
      background: #ef4444;
      box-shadow: 0 0 8px #ef4444;
      animation:pulse 8s infinite;
    }

    .status-offline {
      background: #9ca3af;
    }
    @keyframes slideDowm{
      from {
        opacity : 0;
        transform: translateY(-20px);
      }
      to{
        opacity :1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-doctors {
      text-align: center;
      color: #666;
      padding: 20px;
      font-style: italic;
    }

    .hospital-section {
      margin-top: 20px;
    }

    .location-title {
      font-size: 1rem;
      color: rgb(42, 106, 255);
      margin-bottom: 15px;
      font-weight: bold;
    }

    .location-form {
      background: #f0f4f8;
      padding: 15px;
      border-radius: 10px;
      border: 2px solid #cbd5e1;
    }

    .location-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 2px solid #cbd5e1;
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
      cursor: pointer;
    }

    .location-input:disabled {
      background: #f3f4f6;
      cursor: not-allowed;
    }

    .location-input:focus {
      outline: none;
      border-color: #2563eb;
    }

    .save-location-btn {
      width: 100%;
      padding: 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .save-location-btn:hover {
      background: #059669;
      transform: scale(1.02);
    }

    /* Chat History Styles */
    #chatHistoryPanel {
      width: 0;
      background: white;
      border-right: 8px solid #e5e7eb;
      overflow-y: auto;
      transition: width 0.3s ease;
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    #chatHistoryPanel.open {
      width: 300px;
      padding: 15px;
    }

    .history-header {
      font-size: 1.1rem;
      font-weight: bold;
      color: #2563eb;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e5e7eb;
    }

    .history-item {
      background: #f9fafb;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      cursor: pointer;
      transition: 0.2s;
    }

    .history-item:hover {
      background: #e0f2fe;
      border-color: #2563eb;
      transform: translateX(5px);
    }

    .history-title {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .history-time {
      font-size: 0.75rem;
      color: #666;
    }

    .no-history {
      text-align: center;
      color: #999;
      padding: 20px;
      font-style: italic;
    }

    .clear-history-btn {
      background: #dc2626;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      font-size: 0.85rem;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: 0.2s;
    }

    .clear-history-btn:hover {
      background: #b91c1c;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    /* Modal System */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.75);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 15px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: #f3f4f6;
  border: none;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  font-size: 1.3rem;
  cursor: pointer;
  transition: 0.2s;
  color: #666;
}

.modal-close:hover {
  background: #e5e7eb;
  color: #333;
  transform: rotate(90deg);
}

/* Role Selection Modal */
.role-modal {
  text-align: center;
  padding: 40px;
}

.role-modal h2 {
  color: #2563eb;
  margin-bottom: 10px;
  font-size: 1.8rem;
}

.role-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 30px;
}

.btn-role {
  padding: 18px 30px;
  font-size: 1.2rem;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.btn-doctor {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
}

.btn-guest {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  color: white;
}

.btn-role:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

/* Form Styles */
.doctor-form-modal {
  max-width: 550px;
}

.form-group {
  margin-bottom: 20px;
  text-align: left;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
  font-size: 0.95rem;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-buttons {
  display: flex;
  gap: 10px;
  margin-top: 25px;
}

.btn-submit {
  flex: 1;
  padding: 14px;
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.3s;
}

.btn-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}

.btn-cancel {
  flex: 1;
  padding: 14px;
  background: #6b7280;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.3s;
}

.btn-cancel:hover {
  background: #4b5563;
}

.form-footer {
  text-align: center;
  margin-top: 20px;
  color: #6b7280;
  font-size: 0.95rem;
}

.form-footer a {
  color: #2563eb;
  text-decoration: none;
  font-weight: 600;
}

.form-footer a:hover {
  text-decoration: underline;
}

/* Doctor Dashboard */
.doctor-dashboard {
  max-width: 600px;
}

.doctor-profile {
  padding: 20px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 25px;
  padding-bottom: 25px;
  border-bottom: 2px solid #e5e7eb;
}

.profile-avatar {
  font-size: 4rem;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  width: 90px;
  height: 90px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.profile-info h3 {
  margin: 0 0 8px 0;
  color: #111827;
  font-size: 1.5rem;
}

.profile-info p {
  margin: 5px 0;
  color: #6b7280;
  font-size: 0.95rem;
}

.status-selector {
  margin: 25px 0;
}

.status-selector label {
  display: block;
  margin-bottom: 10px;
  font-weight: 600;
  color: #374151;
}

.status-selector select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
}

.dashboard-actions {
  margin-top: 25px;
}

.btn-logout {
  width: 100%;
  padding: 12px;
  background: #dc2626;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.3s;
}

.btn-logout:hover {
  background: #b91c1c;
  transform: translateY(-2px);
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes modalSlideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}






  </style>
</head>
<body>

  <header class="topbar">
    <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
    üéÄ NEURO BUDDYY
  </header>

<!-- Role Selection Modal - First Visit -->
<div id="roleModal" class="modal-overlay" style="display: none;">
  <div class="modal-content role-modal">
    <h2>Welcome to NEUROBUDDYY.AI</h2>
    <p style="font-size: 1.1rem; color: #666; margin: 20px 0;">Are you a healthcare professional or a patient?</p>
    
    <div class="role-buttons">
      <!-- Doctor Option -->
      <button class="btn-role btn-doctor" onclick="showDoctorLogin()">
       üë®‚Äç‚öïÔ∏è I'm a Doctor
      </button>
      
      <!-- Patient Login Option -->
      <button class="btn-role" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="showPatientAuth()">
       üßë‚Äçü§ù‚Äçüßë I'm a Patient (Login/Register)
      </button>
      
      <!-- Guest Option -->
      <button class="btn-role btn-guest" onclick="continueAsGuest()">
        üë§Continue as Guest (No Login Required)
      </button>
    </div>
    
    <p style="margin-top: 20px; font-size: 0.9rem; color: #999;">
      <strong>Benefits of Creating an Account:</strong><br>
      ~ Access consultation history from any device<br>
      ~ Save chat history permanently<br>
      ~ Faster future consultations (no need to re-enter details)
    </p>
  </div>
</div>

<!-- ‚úÖ PATIENT LOGIN/REGISTER MODAL -->
<div id="patientAuthModal" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-form-modal">
    <button class="modal-close" onclick="closePatientAuth()">‚ùå</button>
    
    <!-- Login Form -->
    <div id="patientLoginForm">
      <h2>Patient Login</h2>
      <p style="color: #666; margin-bottom: 20px;">Access your consultation history</p>
      
      <form onsubmit="loginPatient(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="patientLoginEmail" placeholder="you@example.com" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="patientLoginPassword" placeholder="Enter your password" required>
          <p style="text-align: right; margin-top: -10px; margin-bottom: 15px;">
            <a href="#" onclick="showPatientPasswordReset(); event.preventDefault();" style="color: #2563eb; font-size: 0.9rem; text-decoration: none; font-weight: 600;">
              Forgot Password?
            </a>
          </p>
        </div>
        
        <div class="form-buttons">
          <button type="submit" class="btn-submit">
            <span id="patientLoginBtnText">Login</span>
            <span id="patientLoginBtnLoader" style="display: none;">Logging in...</span>
          </button>
          <button type="button" class="btn-cancel" onclick="closePatientAuth()">Cancel</button>
        </div>
      </form>
      
      <p class="form-footer">
        Don't have an account? 
        <a href="#" onclick="showPatientRegister(); event.preventDefault();">Register here</a>
      </p>
    </div>
    
    <!-- Register Form -->
    <div id="patientRegisterForm" style="display: none;">
      <h2>Patient Registration</h2>
      <p style="color: #666; margin-bottom: 20px;">Create your account</p>
      
      <form onsubmit="registerPatient(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="patientRegName" placeholder="John Doe" required>
        </div>
        
        <div class="form-group">
          <label>Age</label>
          <input type="number" id="patientRegAge" placeholder="25" min="1" max="120" required>
        </div>
        
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="patientRegEmail" placeholder="you@example.com" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="patientRegPassword" placeholder="Minimum 6 characters" required minlength="6">
        </div>
        
        <div class="form-buttons">
          <button type="submit" class="btn-submit">
            <span id="patientRegBtnText">Register</span>
            <span id="patientRegBtnLoader" style="display: none;">Processing...</span>
          </button>
          <button type="button" class="btn-cancel" onclick="closePatientAuth()">Cancel</button>
        </div>
      </form>
      
      <p class="form-footer">
        Already have an account? 
        <a href="#" onclick="showPatientLogin(); event.preventDefault();">Login here</a>
      </p>
    </div>
    
    <!-- Forgot Password Form -->
    <div id="patientPasswordResetForm" style="display: none;">
      <h2>Reset Password</h2>
      <p style="color: #666; margin-bottom: 20px;">Enter your email to receive a password reset link</p>
      
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="patientResetEmail" placeholder="you@example.com">
      </div>
      
      <button class="btn-submit" onclick="sendPatientPasswordReset()">Send Reset Link</button>
      
      <p class="form-footer">
        <a href="#" onclick="showPatientLogin(); event.preventDefault();">Back to Login</a>
      </p>
    </div>
  </div>
</div>


<!-- Doctor Registration Modal -->
<div id="doctorRegModal" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-form-modal">
    <button class="modal-close" onclick="closeDoctorRegister()">‚ùå‚Ä¢</button>
    <h2>ü™™ Doctor Registration</h2>
    <p style="color: #666; margin-bottom: 20px;">Join our network of healthcare professionals</p>
    
    <form id="doctorRegForm" onsubmit="registerDoctor(event)">
      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="docName" placeholder="Dr. John Doe" required>
      </div>
      
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="docEmail" placeholder="doctor@example.com" required>
      </div>
      
      <div class="form-group">
        <label>Password *</label>
        <input type="password" id="docPassword" placeholder="Minimum 6 characters" required minlength="6">
      </div>
      
      <div class="form-group">
        <label>Specialty *</label>
        <select id="docSpecialty" required>
          <option value="">Select Specialty</option>
          <option value="Neurologist">Neurologist</option>
          <option value="Psychiatrist">Psychiatrist</option>
          <option value="Neurosurgeon">Neurosurgeon</option>
          <option value="Neurophysiologist">Neurophysiologist</option>
          <option value="Neuroradiologist">Neuroradiologist</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Phone Number *</label>
        <input type="tel" id="docPhone" placeholder="+91-XXXXXXXXXX" required>
      </div>
      
      <div class="form-group">
        <label>Medical License Number *</label>
        <input type="text" id="docLicense" placeholder="MCI Registration Number" required>
      </div>
      
      <div class="form-buttons">
        <button type="submit" class="btn-submit">
          <span id="regBtnText">Register</span>
          <span id="regBtnLoader" style="display: none;">‚è≥ Processing...</span>
        </button>
        <button type="button" class="btn-cancel" onclick="closeDoctorRegister()">Cancel</button>
      </div>
    </form>
    
    <p class="form-footer">
      Already registered? <a href="#" onclick="showDoctorLogin(); event.preventDefault();">Login here</a>
    </p>
  </div>
</div>

<!-- Doctor Login Modal -->
<div id="doctorLoginModal" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-form-modal">
    <button class="modal-close" onclick="closeDoctorLogin()">‚ùå‚Äì</button>
    <h2>ü™™ Doctor Login</h2>
    <p style="color: #666; margin-bottom: 20px;">Access your professional dashboard</p>
    
    <form id="doctorLoginForm" onsubmit="loginDoctor(event)">
      <div class="form-group">
        <label>Email *</label>
        <input type="email" id="loginEmail" placeholder="doctor@example.com" required>
      </div>
      
      <div class="form-group">
        <label>Password *</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>

        <!-- Forgot password link (keep only this one) -->
        <p style="text-align: right; margin-top: -10px; margin-bottom: 15px;">
          <a href="#" onclick="showPasswordReset(); event.preventDefault();" 
             style="color: #2563eb; font-size: 0.9rem; text-decoration: none; font-weight: 600;">
           üî¥ Forgot Password?
          </a>
        </p>
      </div>
      
      <div class="form-buttons">
        <button type="submit" class="btn-submit">
          <span id="loginBtnText">Login</span>
          <span id="loginBtnLoader" style="display: none;">√¢¬è¬≥ Logging in...</span>
        </button>
        <button type="button" class="btn-cancel" onclick="closeDoctorLogin()">Cancel</button>
      </div>
    </form>
    
    <p class="form-footer">
      Don't have an account? 
      <a href="#" onclick="showDoctorRegister(); event.preventDefault();">Register here</a>
    </p>
  </div>
</div>

<!-- ‚úÖ DOCTOR PASSWORD RESET MODAL (SIMPLIFIED) -->
<div id="passwordResetModal" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-form-modal">
    <button class="modal-close" onclick="closePasswordReset()">‚úñÔ∏è</button>
    <h2>Reset Password</h2>
    
    <p style="color: #666; margin-bottom: 20px;">
      Enter your email address and we'll send you a secure link to reset your password.
    </p>
    
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="resetEmail" placeholder="doctor@example.com">
    </div>
    
    <div class="form-buttons">
      <button class="btn-submit" onclick="requestResetCode()">
        Send Reset Link
      </button>
      <button class="btn-cancel" onclick="closePasswordReset()">
        Cancel
      </button>
    </div>
    
    <p class="form-footer">
      <a href="#" onclick="showDoctorLogin(); event.preventDefault();">
        Back to Login
      </a>
    </p>
  </div>
</div>

<!-- ‚úÖ ENHANCED SYMPTOM DETAILS MODAL -->
<div id="symptomModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 600px;">
    <button class="modal-close" onclick="closeSymptomModal()">‚úñÔ∏è</button>
    
    <!-- Image Section -->
    <div style="text-align: center; margin-bottom: 20px;">
      <img id="symptomImage" src="" alt="Symptom" 
        style="width: 100%; max-width: 400px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
    </div>
    
    <!-- Title -->
    <h2 id="symptomTitle" style="color: #2563eb; margin: 0 0 15px 0;">Symptom Name</h2>
    
    <!-- Category Badge -->
    <div style="margin-bottom: 15px;">
      <span id="symptomCategory" 
        style="background: #dbeafe; color: #1e40af; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">
        Category
      </span>
    </div>
    
    <!-- Description -->
    <div id="symptomDescription" 
      style="color: #374151; line-height: 1.8; font-size: 1rem; margin-bottom: 20px;">
      Description will appear here...
    </div>
    
    <!-- Additional Info -->
    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb;">
      <strong style="color: #1e40af;"> When to Seek Help:</strong>
      <p id="symptomAdvice" style="margin: 10px 0 0 0; color: #1e40af; font-size: 0.95rem;">
        Advice will appear here...
      </p>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
      <button class="btn-submit" onclick="closeSymptomModal()">Close</button>
    </div>
  </div>
</div>

<!-- ‚úÖ CALL INVITATION MODAL (For patient receiving call) -->
<div id="callInvitationModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 450px; text-align: center;">
    <h2 style="color: #2563eb; margin: 0 0 15px 0;">üìû Incoming Call</h2>
    
    <div style="font-size: 4rem; margin: 20px 0;">üë®‚Äç‚öïÔ∏è</div>
    
    <p style="font-size: 1.2rem; font-weight: bold; margin: 10px 0;" id="callerName">
      Dr. John Doe
    </p>
    
    <p style="color: #666; margin: 10px 0;" id="callType">
      Voice Call
    </p>
    
    <div style="display: flex; gap: 15px; margin-top: 30px;">
      <button onclick="declineCall()" 
        style="flex: 1; padding: 15px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
        ‚ùó Decline
      </button>
      <button onclick="acceptCall()" 
        style="flex: 1; padding: 15px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer;">
        ‚úÖ Accept
      </button>
    </div>
  </div>
</div>

<!-- ‚úÖ ACTIVE CALL MODAL -->
<div id="activeCallModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 800px; background: #1f2937;">
    
    <!-- Call Header -->
    <div style="background: #374151; padding: 15px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h3 style="color: white; margin: 0;" id="activeCallTitle">Dr. John Doe</h3>
        <p style="color: #9ca3af; margin: 5px 0 0 0; font-size: 0.9rem;" id="callDuration">00:00</p>
      </div>
      <div style="background: #ef4444; padding: 8px 15px; border-radius: 20px;">
        <span style="color: white; font-weight: bold;">üü¢ LIVE</span>
      </div>
    </div>
    
    <!-- Video Container -->
    <div style="position: relative; background: #111827; padding: 20px; min-height: 400px;">
      
      <!-- Remote Video (other person) -->
      <video id="remoteVideo" autoplay playsinline 
        style="width: 100%; max-height: 500px; border-radius: 10px; background: #000;">
      </video>
      
      <!-- Local Video (yourself - small overlay) -->
      <video id="localVideo" autoplay muted playsinline 
        style="position: absolute; top: 30px; right: 30px; width: 200px; height: 150px; border-radius: 10px; border: 3px solid white; background: #000;">
      </video>
      
      <!-- Audio Only Indicator -->
      <div id="audioOnlyIndicator" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
        <div style="font-size: 6rem;">‚òéÔ∏è</div>
        <p style="color: white; font-size: 1.5rem; margin-top: 20px;">Audio Call</p>
      </div>
    </div>
    
    <!-- Call Controls -->
    <div style="background: #374151; padding: 20px; border-radius: 0 0 10px 10px; display: flex; justify-content: center; gap: 15px;">
      
      <!-- Mute Audio Button -->
      <button id="muteBtn" onclick="toggleMute()" 
        style="padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 1.5rem;">
       üîá
      </button>
      
      <!-- Toggle Video Button (only for video calls) -->
      <button id="videoBtn" onclick="toggleVideo()" 
        style="display: none; padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 1.5rem;">
       üìπ
      </button>
      
      <!-- End Call Button -->
      <button onclick="endCall()" 
        style="padding: 15px 20px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; font-size: 1.5rem;">
       üìû
      </button>
    </div>
  </div>
</div>

<!-- ‚úÖ ENHANCED PROFILE MODAL (Replace existing userProfileModal) -->
<div id="userProfileModal" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-dashboard">
    <button class="modal-close" onclick="closeUserProfile()">√ó</button>
    
    <div class="doctor-profile">
      <div class="profile-header">
        <div class="profile-avatar">üë§</div>
        <div class="profile-info">
          <h3 id="profileName">Loading...</h3>
          <p id="profileEmail">loading@example.com</p>
          <span id="profileRoleBadge" style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
            User
          </span>
        </div>
      </div>

      <!-- ‚¨áÔ∏è NEW: DOCTOR SPECIFIC DETAILS SECTION ‚¨áÔ∏è -->
      <div id="doctorProfileDetails" style="display: none; margin-bottom: 20px; text-align: left; background: #f9fafb; padding: 15px; border-radius: 8px;">
        
        <div class="form-group">
          <label style="font-size:0.85rem; color:#666;">üÜî Doctor ID (Unique)</label>
          <input type="text" id="profileDocId" readonly style="background:#e5e7eb; cursor:not-allowed;">
        </div>

        <div class="form-group">
          <label style="font-size:0.85rem; color:#666;">üì± Phone Number</label>
          <input type="text" id="profilePhone" readonly style="background:#e5e7eb; cursor:not-allowed;">
        </div>

        <div class="form-group">
          <label style="font-size:0.85rem; color:#666;">ü©∫ Specialty (Editable)</label>
          <select id="profileSpecialty" onchange="updateDoctorSpecialty()">
            <option value="Neurologist">Neurologist</option>
            <option value="Psychiatrist">Psychiatrist</option>
            <option value="Neurosurgeon">Neurosurgeon</option>
            <option value="Neurophysiologist">Neurophysiologist</option>
            <option value="Neuroradiologist">Neuroradiologist</option>
            <option value="General">General Physician</option>
          </select>
        </div>

        <div class="status-selector">
          <label>üü¢ Current Status</label>
          <select id="doctorStatusSelect" onchange="updateDoctorStatus(this.value)">
            <option value="available">‚úÖ Available</option>
            <option value="busy">üî¥ Busy / Engaged</option>
            <option value="offline">‚ö´ Offline</option>
          </select>
        </div>
      </div>
      <!-- ‚¨ÜÔ∏è END DOCTOR DETAILS ‚¨ÜÔ∏è -->

      <div class="dashboard-actions">
        <button class="btn-logout" onclick="logoutUser()">
          üö™ Logout
        </button>
      </div>
    </div>
  </div>
</div>






<script>
// ========== WEBRTC / PEERJS INITIALIZATION ==========

let peer = null;
let currentCall = null;
let localStream = null;
let remoteStream = null;
let callInProgress = false;
let currentCamera = 'user'; // 'user' = front, 'environment' = back
let availableCameras = [];


// Initialize PeerJS (safe, single instance)
function initializePeerJS(userId) {
  // ‚úÖ Prevent double initialization
  if (peer && !peer.destroyed) {
    console.log('‚ö†Ô∏è PeerJS already initialized with ID:', peer.id);
    return;
  }

  try {
    // If userId is not passed, generate random ID (guest)
    const peerId = userId || undefined;

    peer = new Peer(peerId, {
      debug: 2,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      }
    });

    peer.on('open', (id) => {
      console.log('‚úÖ PeerJS connected with ID:', id);
    });

    peer.on('error', (error) => {
      console.error('‚ùó PeerJS error:', error);
    });

    // Listen for incoming calls
    peer.on('call', (incomingCall) => {
      console.log('üìû Incoming call from:', incomingCall.peer);
      handleIncomingCall(incomingCall);
    });

    console.log('‚úÖ PeerJS initialized');

  } catch (error) {
    console.error('‚ùó Failed to initialize PeerJS:', error);
  }
}

// ========== WEBRTC CALL FUNCTIONS ==========

// Get patient data from request ID
async function getPatientFromRequest(requestId) {
  try {
    const { doc, getDoc } = window.firestoreFunctions;
    const docRef = doc(window.firebaseDB, 'patientRequests', requestId);
    const docSnap = await getDoc(docRef);
    
    if (docSnap.exists()) {
      return docSnap.data();
    }
    
    return null;
    
  } catch (error) {
    console.error('‚ùó Error getting patient data:', error);
    return null;
  }
}

// Start video call (Doctor initiates)
// Start video call (Doctor initiates)
async function startVideoCall() {
  if (!window.activePatient || !window.activePatient.id) {
    alert('‚ùå No active patient. Please select a patient first.');
    return;
  }
  
  const patientName = window.activePatient.patientName || 'Patient';
  
  if (!confirm(`üìπ Start video call with ${patientName}?`)) {
    return;
  }
  
  try {
    console.log('Starting video call...');
    console.log('üîç Patient request ID:', window.activePatient.id); // DEBUG
    
    // ‚úÖ Get patient's Peer ID from the request
    const patientData = await getPatientFromRequest(window.activePatient.id);
    
    console.log('üì¶ Patient data from Firebase:', patientData); // DEBUG
    console.log('üÜî Patient Peer ID:', patientData?.patientPeerId); // DEBUG
    
    if (!patientData || !patientData.patientPeerId) {
      alert('‚ùå Cannot start call: Patient\'s connection ID not found. Ask patient to reconnect.');
      return;
    }
    
    console.log('üìû Calling patient with Peer ID:', patientData.patientPeerId);
    
    // Get local audio + video stream
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
    
    currentCall = peer.call(patientData.patientPeerId, localStream, {
  metadata: { callType: 'video' }
});

    
    // Handle incoming stream
    currentCall.on('stream', (remoteStream) => {
      handleRemoteStream(remoteStream, 'video');
    });
    
    currentCall.on('close', () => {
      console.log('üìµ Call closed');
      endCall();
    });
    
    currentCall.on('error', (err) => {
      console.error('‚ùó Call error:', err);
      alert('‚ùå Call failed: ' + err.message);
      endCall();
    });
    
    // Show "Calling..." UI
    showCallingUI(patientName, 'video');
    
  } catch (error) {
    console.error('‚ùå Error starting video call:', error);
    if (error.name === 'NotAllowedError') {
      alert('‚ùå Camera/Microphone access denied. Please allow access in your browser settings.');
    } else {
      alert('‚ùå Failed to start call: ' + error.message);
    }
  }
}

// Start voice call (Doctor initiates)
async function startVoiceCall() {
  if (!window.activePatient || !window.activePatient.id) {
    alert('‚ùå No active patient. Please select a patient first.');
    return;
  }
  
  const patientName = window.activePatient.patientName || 'Patient';
  
  if (!confirm(`üìû Start voice call with ${patientName}?`)) {
    return;
  }
  
  try {
    console.log('Starting voice call...');
    console.log('üîç Patient request ID:', window.activePatient.id); // DEBUG
    
    // ‚úÖ Get patient's Peer ID
    const patientData = await getPatientFromRequest(window.activePatient.id);
    
    console.log('üì¶ Patient data from Firebase:', patientData); // DEBUG
    console.log('üÜî Patient Peer ID:', patientData?.patientPeerId); // DEBUG
    
    if (!patientData || !patientData.patientPeerId) {
      alert('‚ùå Cannot start call: Patient\'s connection ID not found.');
      return;
    }
    
    console.log('üìû Calling patient with Peer ID:', patientData.patientPeerId);
    
    // Get local audio stream
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    
    currentCall = peer.call(patientData.patientPeerId, localStream, {
  metadata: { callType: 'voice' }
});

    
    currentCall.on('stream', (remoteStream) => {
      handleRemoteStream(remoteStream, 'voice');
    });
    
    currentCall.on('close', () => {
      console.log('üìµ Call closed');
      endCall();
    });
    
    currentCall.on('error', (err) => {
      console.error('‚ùó Call error:', err);
      alert('‚ùå Call failed: ' + err.message);
      endCall();
    });
    
    showCallingUI(patientName, 'voice');
    
  } catch (error) {
    console.error('‚ùå Error starting voice call:', error);
    if (error.name === 'NotAllowedError') {
      alert('‚ùå Microphone access denied. Please allow microphone access in your browser settings.');
    } else {
      alert('‚ùå Failed to start call: ' + error.message);
    }
  }
}


// ============================================
// SHOW CALLING UI (DOCTOR SIDE)
// ============================================
function showCallingUI(recipientName, callType) {
  document.getElementById('activeCallModal').style.display = 'flex';
  document.getElementById('activeCallTitle').textContent = `Calling ${recipientName}...`;
  document.getElementById('callDuration').textContent = '00:00'; // ‚úÖ Changed from "Connecting..."
  
  // Show appropriate UI
  if (callType === 'voice') {
    document.getElementById('remoteVideo').style.display = 'none';
    document.getElementById('localVideo').style.display = 'none';
    document.getElementById('audioOnlyIndicator').style.display = 'block';
    document.getElementById('videoBtn').style.display = 'none';
    
    // ‚úÖ Hide switch camera button for voice calls
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    if (switchCameraBtn) switchCameraBtn.style.display = 'none';
    
  } else {
    document.getElementById('remoteVideo').style.display = 'block';
    document.getElementById('localVideo').style.display = 'block';
    document.getElementById('audioOnlyIndicator').style.display = 'none';
    document.getElementById('videoBtn').style.display = 'inline-block';
    
    // ‚úÖ Show switch camera button for video calls
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    if (switchCameraBtn) switchCameraBtn.style.display = 'inline-block';
    
    // Show local video preview
    document.getElementById('localVideo').srcObject = localStream;
  }
}

// Listen for incoming call invitations (Patient side)
function listenForCallInvitations() {
  const currentUser = window.firebaseAuth.currentUser;
  
  if (!currentUser) return;
  
  const { collection, query, where, onSnapshot } = window.firestoreFunctions;
  
  const q = query(
    collection(window.firebaseDB, 'callInvitations'),
    where('recipientId', '==', currentUser.uid),
    where('status', '==', 'pending')
  );
  
  onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        const invitation = { id: change.doc.id, ...change.doc.data() };
        showIncomingCallNotification(invitation);
      }
    });
  });
  
  console.log('üîç Listening for call invitations...');
}

// Show incoming call notification
function showIncomingCallNotification(invitation) {
  console.log('üìû Incoming call from:', invitation.callerName);
  
  // Store invitation data
  window.currentCallInvitation = invitation;
  
  // Update modal
  document.getElementById('callerName').textContent = invitation.callerName;
  document.getElementById('callType').textContent = invitation.callType === 'video' ? 'üìπ Video Call' : 'üìû Voice Call';
  
  // Show modal
  document.getElementById('callInvitationModal').style.display = 'flex';
}

// Accept incoming call (Patient)
async function acceptCall() {
  if (!window.currentCallInvitation) {
    alert('‚ùó No active call invitation');
    return;
  }
  
  try {
    console.log('‚úÖ Accepting call...');
    
    const invitation = window.currentCallInvitation;
    
    // Hide invitation modal
    document.getElementById('callInvitationModal').style.display = 'none';
    
    // Get user media
    const constraints = {
      audio: true,
      video: invitation.callType === 'video'
    };
    
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    // Update invitation status in Firebase
    const { doc, updateDoc } = window.firestoreFunctions;
    await updateDoc(doc(window.firebaseDB, 'callInvitations', invitation.id), {
      status: 'accepted'
    });
    
    // Call the peer
    currentCall = peer.call(invitation.callerId, localStream);
    
    currentCall.on('stream', (remoteStream) => {
      handleRemoteStream(remoteStream, invitation.callType);
    });
    
    // Show call UI
    showActiveCallUI(invitation.callerName, invitation.callType);
    
  } catch (error) {
    console.error('‚ùó Error accepting call:', error);
    alert('‚ùó Failed to accept call: ' + error.message);
  }
}

// Decline incoming call
async function declineCall() {
  const requestId = sessionStorage.getItem('activeRequestId');
  if (!requestId) return;

  try {
    const { doc, updateDoc } = window.firestoreFunctions;
    await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
      status: 'declined',
      declinedBy: 'patient'
    });
    
    alert("Consultation cancelled. You can request again later.");
    document.getElementById('callInvitationModal').style.display = 'none';
    
  } catch (e) {
    console.error("Error declining:", e);
  }
}

// ============================================
// HANDLE INCOMING CALL - COMPLETE FIX
// ============================================
function handleIncomingCall(incomingCall) {
  console.log("üìû Handling incoming call...");
  
  currentCall = incomingCall;
  
  // Determine call type
  const callType = incomingCall.metadata?.callType || 'voice';
  
  // Get doctor name from active consultation
  const doctorName = window.activeConsultation?.doctorName || "Doctor";
  
  // Request user media FIRST
  navigator.mediaDevices.getUserMedia({ 
    audio: true, 
    video: callType === 'video' 
  })
  .then(stream => {
    localStream = stream;
    
    // Answer the call with local stream
    currentCall.answer(stream);
    
    // ‚úÖ SHOW THE CALL UI IMMEDIATELY
    showActiveCallUI(doctorName, callType);
    
    // Display local video if video call
    if (callType === 'video') {
      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.srcObject = stream;
        localVideo.style.display = 'block';
      }
    }
    
    // Listen for remote stream
    currentCall.on('stream', (remoteStream) => {
      console.log("‚úÖ Received remote stream");
      handleRemoteStream(remoteStream, callType);
    });
    
    // Handle call close
    currentCall.on('close', () => {
      console.log("üìµ Call closed");
      endCall();
    });
    
    // Handle errors
    currentCall.on('error', (err) => {
      console.error("‚ùå Call error:", err);
      alert("Call failed: " + err.message);
      endCall();
    });
    
  })
  .catch(err => {
    console.error("‚ùå Failed to get media:", err);
    
    if (err.name === 'NotAllowedError') {
      alert("‚ö†Ô∏è Camera/Microphone access denied!\n\nPlease allow access in your browser settings and try again.");
    } else {
      alert("Cannot access microphone/camera: " + err.message);
    }
    
    // Reject the call
    if (currentCall) {
      currentCall.close();
    }
  });
}


// ============================================
// HANDLE REMOTE STREAM
// ============================================
function handleRemoteStream(stream, callType) {
  remoteStream = stream;
  console.log("üé• Displaying remote stream");
  
  // ‚úÖ UPDATE CALL TITLE - REMOVE "CALLING..." / "CONNECTING..."
  const callTitle = document.getElementById('activeCallTitle');
  if (callTitle) {
    // Remove any "Calling " prefix and "..." suffix
    const personName = callTitle.textContent.replace('Calling ', '').replace('...', '');
    callTitle.textContent = personName;
  }
  
  // ‚úÖ UPDATE DURATION - MAKE SURE IT'S NOT STUCK ON "CONNECTING..."
  const callDuration = document.getElementById('callDuration');
  if (callDuration && callDuration.textContent === 'Connecting...') {
    callDuration.textContent = '00:00';
  }
  
  if (callType === 'video') {
    const remoteVideo = document.getElementById('remoteVideo');
    if (remoteVideo) {
      remoteVideo.srcObject = stream;
      remoteVideo.style.display = 'block';
    }
  } else {
    // For voice call, play audio
    const audio = new Audio();
    audio.srcObject = stream;
    audio.play().catch(e => console.error("Audio play failed:", e));
  }
  
  // Start timer if not already started
  if (!callStartTime) {
    startCallTimer();
  }
  
  callInProgress = true;
}


// ============================================
// SHOW ACTIVE CALL UI - PATIENT SIDE
// ============================================
function showActiveCallUI(personName, callType) {
  console.log("üé¨ Showing call UI for patient:", personName, callType);
  
  // Get or create modal
  let modal = document.getElementById('activeCallModal');
  
  if (!modal) {
    const modalHTML = `
      <div id="activeCallModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; background: #1f2937; color: white;">
          <div style="text-align: center; padding: 20px;">
            <h2 id="activeCallTitle" style="margin: 0 0 10px 0;">Call with ${personName}</h2>
            <div id="callDuration" style="font-size: 1.5rem; color: #10b981; margin-bottom: 20px;">00:00</div>
            
            <!-- Video Elements -->
            <div style="position: relative; width: 100%; margin-bottom: 20px;">
              <video id="remoteVideo" autoplay playsinline style="width: 100%; border-radius: 10px; background: #000; display: none;"></video>
              <video id="localVideo" autoplay playsinline muted style="position: absolute; bottom: 10px; right: 10px; width: 150px; border-radius: 8px; border: 2px solid white; display: none;"></video>
              <div id="audioOnlyIndicator" style="display: none; padding: 60px; background: #374151; border-radius: 10px; text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 10px;">üé§</div>
                <div style="font-size: 1.2rem;">Voice Call Active</div>
              </div>
            </div>
            
            <!-- Call Controls -->
            <div style="display: flex; gap: 15px; justify-content: center;">
              <button id="muteBtn" onclick="toggleMute()" style="padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem;">
                üîä
              </button>
              <button id="videoBtn" onclick="toggleVideo()" style="padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: none;">
                üìπ
              </button>
              <button id="switchCameraBtn" onclick="switchCamera()" style="padding: 15px 20px; background: #6b7280; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: none;" title="Switch Camera">
                üîÑ
              </button>
              <button onclick="endCall()" style="padding: 15px 30px; background: #dc2626; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 1rem;">
                ‚ùå End Call
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    modal = document.getElementById('activeCallModal');
  }

  
  // Show modal
  modal.style.display = 'flex';
  
  // Update title
  const title = document.getElementById('activeCallTitle');
  if (title) title.textContent = `Call with ${personName}`;
  
  // Configure for voice or video
  const remoteVideo = document.getElementById('remoteVideo');
  const localVideo = document.getElementById('localVideo');
  const audioIndicator = document.getElementById('audioOnlyIndicator');
  const videoBtn = document.getElementById('videoBtn');
  
  const switchCameraBtn = document.getElementById('switchCameraBtn');

if (callType === 'voice') {
  if (remoteVideo) remoteVideo.style.display = 'none';
  if (localVideo) localVideo.style.display = 'none';
  if (audioIndicator) audioIndicator.style.display = 'block';
  if (videoBtn) videoBtn.style.display = 'none';
  if (switchCameraBtn) switchCameraBtn.style.display = 'none';
} else {
  if (remoteVideo) remoteVideo.style.display = 'block';
  if (localVideo) localVideo.style.display = 'block';
  if (audioIndicator) audioIndicator.style.display = 'none';
  if (videoBtn) videoBtn.style.display = 'inline-block';
  if (switchCameraBtn) switchCameraBtn.style.display = 'inline-block';
}

  // Start call timer
  startCallTimer();
  
  callInProgress = true;
}


// Call timer
let callStartTime = null;
let callTimerInterval = null;

function startCallTimer() {
  callStartTime = Date.now();
  
  callTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('callDuration').textContent = 
      `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }, 1000);
}

// Toggle mute
function toggleMute() {
  if (!localStream) return;
  
  const audioTrack = localStream.getAudioTracks()[0];
  
  if (audioTrack) {
    audioTrack.enabled = !audioTrack.enabled;
    
    const btn = document.getElementById('muteBtn');
    if (audioTrack.enabled) {
      btn.textContent = 'üé§';
      btn.style.background = '#6b7280';
    } else {
      btn.textContent = 'üîá';
      btn.style.background = '#dc2626';
    }
  }
}

// Toggle video
function toggleVideo() {
  if (!localStream) return;
  
  const videoTrack = localStream.getVideoTracks()[0];
  
  if (videoTrack) {
    videoTrack.enabled = !videoTrack.enabled;
    
    const btn = document.getElementById('videoBtn');
    if (videoTrack.enabled) {
      btn.textContent = 'üìπ';
      btn.style.background = '#6b7280';
    } else {
      btn.textContent = 'üìµ';
      btn.style.background = '#dc2626';
    }
  }
}

// ============================================
// END CALL - COMPLETE VERSION
// ============================================
async function endCall() {
  if (callInProgress) {
    if (!confirm("End this call?")) return;
  }
  
  console.log("üìµ Ending call...");
  
  try {
    // Stop all tracks
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    
    if (remoteStream) {
      remoteStream.getTracks().forEach(track => track.stop());
      remoteStream = null;
    }
    
    // Close peer connection
    if (currentCall) {
      currentCall.close();
      currentCall = null;
    }
    
    // Stop timer
    if (callTimerInterval) {
      clearInterval(callTimerInterval);
      callTimerInterval = null;
    }
    
    // Hide modal
    const modal = document.getElementById('activeCallModal');
    if (modal) {
      modal.style.display = 'none';
    }
    
    callInProgress = false;
    
    console.log("‚úÖ Call ended");
    
  } catch (error) {
    console.error("‚ùå Error ending call:", error);
  }
}

// Show unified auth modal
function showAuthModal() {
  document.getElementById('roleModal').style.display = 'flex';
}

// ============================================
// DOCTOR LOGIN MODAL FUNCTIONS
// ============================================
function showDoctorLogin() {
  document.getElementById('roleModal').style.display = 'none';
  document.getElementById('doctorRegModal').style.display = 'none';
  document.getElementById('doctorLoginModal').style.display = 'flex';
}

function closeDoctorLogin() {
  document.getElementById('doctorLoginModal').style.display = 'none';
}

function showDoctorRegister() {
  document.getElementById('roleModal').style.display = 'none';
  document.getElementById('doctorLoginModal').style.display = 'none';
  document.getElementById('doctorRegModal').style.display = 'flex';
}

function closeDoctorRegister() {
  document.getElementById('doctorRegModal').style.display = 'none';
}

function closeDoctorDashboard() {
  document.getElementById('doctorDashboard').style.display = 'none';
}

// ‚úÖ DOCTOR LOGOUT
async function logoutDoctor() {
  if (!confirm('Logout? Are you sure you want to logout?')) return;
  
  try {
    // Clear session data
    localStorage.removeItem('userMode');
    localStorage.removeItem('activeDoctorSession');
    sessionStorage.removeItem('doctorSession');
    
    // Sign out from Firebase Auth
    const { signOut } = window.authFunctions;
    await signOut(window.firebaseAuth);
    
    console.log('‚úÖ Doctor logged out');
    
    // Reload page
    location.reload();
    
  } catch (error) {
    console.error('‚ùó Logout error:', error);
    alert('‚ùó Logout failed: ' + error.message);
  }
}


// ========== PATIENT AUTHENTICATION ==========

/// Show/Hide patient auth modals (Bulletproof Version)
function showPatientAuth() {
  console.log("üöÄ Starting showPatientAuth...");

  // 1. SAFELY close Role Selection
  const roleModal = document.getElementById('roleModal');
  if (roleModal) roleModal.style.display = 'none';

  // 2. SAFELY close Auth Modal
  const authModal = document.getElementById('authModal');
  if (authModal) authModal.style.display = 'none';

  // 3. SAFELY Show Patient Login
  const patientModal = document.getElementById('patientAuthModal');
  if (patientModal) {
    patientModal.style.display = 'flex';
    
    // Ensure Login Form is the active one
    const loginForm = document.getElementById('patientLoginForm');
    const registerForm = document.getElementById('patientRegisterForm');
    const resetForm = document.getElementById('patientPasswordResetForm');

    if (loginForm) loginForm.style.display = 'block';
    if (registerForm) registerForm.style.display = 'none';
    if (resetForm) resetForm.style.display = 'none';
  } else {
    console.error("‚ùå CRITICAL: 'patientAuthModal' is missing from HTML!");
  }
}



function closePatientAuth() {
  document.getElementById('patientAuthModal').style.display = 'none';
}

function showPatientLogin() {
  document.getElementById('patientLoginForm').style.display = 'block';
  document.getElementById('patientRegisterForm').style.display = 'none';
  document.getElementById('patientPasswordResetForm').style.display = 'none';
}

function showPatientRegister() {
  document.getElementById('patientLoginForm').style.display = 'none';
  document.getElementById('patientRegisterForm').style.display = 'block';
  document.getElementById('patientPasswordResetForm').style.display = 'none';
}

function showPatientPasswordReset() {
  document.getElementById('patientLoginForm').style.display = 'none';
  document.getElementById('patientRegisterForm').style.display = 'none';
  document.getElementById('patientPasswordResetForm').style.display = 'block';
}

// ‚úÖ PATIENT REGISTRATION
// PATIENT REGISTRATION
async function registerPatient(event) {
  event.preventDefault();
  
  const name = document.getElementById('patientRegName').value.trim();
  const age = parseInt(document.getElementById('patientRegAge').value);
  const email = document.getElementById('patientRegEmail').value.trim();
  const password = document.getElementById('patientRegPassword').value;
  
  // Show loading
  document.getElementById('patientRegBtnText').style.display = 'none';
  document.getElementById('patientRegBtnLoader').style.display = 'inline';
  
  try {
    // Create Firebase Auth account
    const { createUserWithEmailAndPassword } = window.authFunctions;
    const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
    const user = userCredential.user;
    
    // Save patient data to Firestore
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    await addDoc(collection(window.firebaseDB, 'patients'), {
      userId: user.uid,
      name: name,
      age: age,
      email: email,
      registeredAt: serverTimestamp(),
      role: 'patient'
    });
    
    console.log('‚úÖ Patient registered:', user.uid);
    
    // ‚úÖ CLOSE MODAL IMMEDIATELY
    closePatientAuth();
    
    // ‚úÖ Wait a bit then show message
    setTimeout(() => {
      alert('Registration successful! You are now logged in.');
      // Don't call initializePatientMode here - auth state listener will handle it
    }, 300);
    
  } catch (error) {
    console.error('‚ùå Registration error:', error);
    
    if (error.code === 'auth/email-already-in-use') {
      alert('This email is already registered. Please login instead.');
    } else if (error.code === 'auth/weak-password') {
      alert('Password should be at least 6 characters.');
    } else {
      alert('Registration failed: ' + error.message);
    }
  } finally {
    // Hide loading
    document.getElementById('patientRegBtnText').style.display = 'inline';
    document.getElementById('patientRegBtnLoader').style.display = 'none';
  }
}


// ‚úÖ PATIENT LOGIN
// PATIENT LOGIN
// PATIENT LOGIN
async function loginPatient(event) {
  event.preventDefault();
  
  const email = document.getElementById('patientLoginEmail').value.trim();
  const password = document.getElementById('patientLoginPassword').value;
  
  // Show loading
  document.getElementById('patientLoginBtnText').style.display = 'none';
  document.getElementById('patientLoginBtnLoader').style.display = 'inline';
  
  try {
    const { signInWithEmailAndPassword } = window.authFunctions;
    const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
    const user = userCredential.user;
    
    console.log('‚úÖ Patient logged in:', user.uid);
    
    // ‚úÖ CLOSE MODAL IMMEDIATELY
    closePatientAuth();
    
    // ‚úÖ Wait a bit then show message and initialize
    setTimeout(() => {
      alert('Welcome back!');
      // Don't call initializePatientMode here - auth state listener will handle it
    }, 300);
    
  } catch (error) {
    console.error('‚ùå Login error:', error);
    
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      alert('Invalid email or password.');
    } else if (error.code === 'auth/invalid-credential') {
      alert('Invalid credentials. Please check your email and password.');
    } else {
      alert('Login failed: ' + error.message);
    }
  } finally {
    // Hide loading
    document.getElementById('patientLoginBtnText').style.display = 'inline';
    document.getElementById('patientLoginBtnLoader').style.display = 'none';
  }
}


// ‚úÖ SEND PASSWORD RESET EMAIL
async function sendPatientPasswordReset() {
  const email = document.getElementById('patientResetEmail').value.trim();
  
  if (!email) {
    alert('Please enter your email address.');
    return;
  }
  
  try {
    const { sendPasswordResetEmail } = window.authFunctions;
    await sendPasswordResetEmail(window.firebaseAuth, email);
    
    alert('‚úÖ Password reset email sent! Check your inbox.');
    showPatientLogin();
    
  } catch (error) {
    console.error('‚ùó Password reset error:', error);
    
    if (error.code === 'auth/user-not-found') {
      alert('‚ùó No account found with this email.');
    } else {
      alert('‚ùó Failed to send reset email: ' + error.message);
    }
  }
}

// ‚úÖ PATIENT LOGOUT
async function logoutPatient() {
  if (!confirm('Are you sure you want to logout?')) return;
  
  try {
    const { signOut } = window.authFunctions;
    await signOut(window.firebaseAuth);
    
    console.log('‚úÖ Patient logged out');
    alert('‚úÖ Logged out successfully.');
    
    // Reload page
    location.reload();
    
  } catch (error) {
    console.error('‚ùó Logout error:', error);
    alert('‚ùó Logout failed: ' + error.message);
  }
}




// ============================================
// DOCTOR CONNECTION CONFIRMATION MODAL
// ============================================
function showDoctorConnectionModal(doctor) {
  // Create modal HTML
  const modalHTML = `
    <div id="doctorConnectionModal" class="modal-overlay" style="display: flex;">
      <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeDoctorConnectionModal()">‚ùå‚Ä¢</button>
        
        <div style="text-align: center; padding: 20px 0;">
          <div style="font-size: 4rem; margin-bottom: 15px;">üë®‚Äç‚öïÔ∏è</div>
          <h2 style="color: #2563eb; margin: 0 0 10px 0;">Connect to Doctor?</h2>
        </div>
        
        <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
          <div style="margin-bottom: 15px;">
            <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">Doctor Name</p>
            <p style="font-size: 1.1rem; font-weight: bold; color: #333; margin: 0;">${doctor.name}</p>
          </div>
          
          <div style="margin-bottom: 15px;">
            <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">Specialty</p>
            <p style="font-size: 1rem; color: #333; margin: 0;">${doctor.specialty}</p>
          </div>
          
          <div style="margin-bottom: 15px;">
            <p style="font-size: 0.85rem; color: #666; margin: 0 0 8px 0;">Current Status</p>
            ${getDoctorStatusBanner(doctor.status)}
          </div>
          
          <div>
            <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">√¢¬è¬∞ Estimated Wait Time</p>
            <p style="font-size: 1rem; font-weight: 600; color: #2563eb; margin: 0;">
              ${getEstimatedWaitTime(doctor.status)}
            </p>
          </div>
        </div>
        
        ${getDoctorWarningMessage(doctor.status)}
        
        <div style="display: flex; gap: 10px;">
          <button onclick="closeDoctorConnectionModal()" 
                  style="flex: 1; padding: 14px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;">
            Cancel
          </button>
          <button onclick="confirmDoctorConnection('${doctor.id}', '${doctor.name}', '${doctor.specialty}')" 
                  style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;">
            ‚ùå Connect Now
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('doctorConnectionModal');
  if (existing) existing.remove();
  
  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeDoctorConnectionModal() {
  const modal = document.getElementById('doctorConnectionModal');
  if (modal) modal.remove();
}


// ============================================
// HELPER FUNCTIONS FOR STATUS DISPLAY
// ============================================
function getDoctorStatusBanner(status) {
  if (status === 'available') {
    return `
      <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #10b981;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #10b981; border-radius: 50%; 
                    box-shadow: 0 0 10px #10b981; animation: pulse 2s infinite;"></div>
        <span style="font-weight: bold; color: #065f46; font-size: 1rem;">Available Now</span>
      </div>
    `;
  } else if (status === 'engaged') {
    return `
      <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #ef4444;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 50%; 
                    box-shadow: 0 0 10px #ef4444;"></div>
        <span style="font-weight: bold; color: #991b1b; font-size: 1rem;">‚ùó Currently Engaged</span>
      </div>
    `;
  } else {
    return `
      <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #9ca3af;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #9ca3af; border-radius: 50%;"></div>
        <span style="font-weight: bold; color: #4b5563; font-size: 1rem;">üîò Offline</span>
      </div>
    `;
  }
}

function getEstimatedWaitTime(status) {
  if (status === 'available') {
    return 'Immediate Response';
  } else if (status === 'engaged') {
    return '10-15 minutes';
  } else {
    return 'May take several hours';
  }
}

function getDoctorWarningMessage(status) {
  if (status === 'available') {
    return `
      <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb; margin-bottom: 20px;">
        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
          üå¨Ô∏è <strong>Ready to connect!</strong> This doctor is available and can respond immediately.
        </p>
      </div>
    `;
  } else if (status === 'engaged') {
    return `
      <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
        <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
         üî¥ <strong>Doctor is busy</strong> with another patient. Your request will be queued and the doctor will respond when available.
        </p>
      </div>
    `;
  } else {
    return `
      <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 20px;">
        <p style="margin: 0; color: #991b1b; font-size: 0.9rem;">
          ‚ùó <strong>Doctor is offline.</strong> Your request will be saved but may not receive an immediate response.
        </p>
      </div>
    `;
  }
}

// ============================================
// CONFIRM CONNECTION AND SEND REQUEST
// ============================================
async function confirmDoctorConnection(doctorId, doctorName, doctorSpecialty) {
  closeDoctorConnectionModal();

  // ‚úÖ CRITICAL: Wait for PeerJS to be ready
  if (!peer || !peer.id) {
    alert("‚ö†Ô∏è Establishing connection... Please wait 3 seconds and try again.");
    console.error("‚ùå PeerJS not ready. peer:", peer, "peer.id:", peer?.id);
    
    // Give user option to wait
    if (confirm("Connection is still establishing. Click OK to wait 2 seconds and try again.")) {
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Check again
      if (!peer || !peer.id) {
        alert("‚ùå Connection failed. Please refresh the page and try again.");
        return;
      }
    } else {
      return;
    }
  }

  console.log("‚úÖ PeerJS is ready with ID:", peer.id);

  // ... rest of your existing code stays the same
  let patientName = "Anonymous Patient";
  let patientAge = 25;
  const user = window.firebaseAuth.currentUser;

  if (user) {
    try {
      const { collection, query, where, getDocs } = window.firestoreFunctions;
      const q = query(collection(window.firebaseDB, "patients"), where("userId", "==", user.uid));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        const data = snapshot.docs[0].data();
        patientName = data.name;
        patientAge = data.age;
      } else {
        patientName = user.email.split("@")[0];
      }
    } catch (e) {
      console.error("Error fetching patient details:", e);
    }
  } else {
    patientName = prompt("Please enter your name:", "Guest");
    if (!patientName) return;
    patientAge = prompt("Please enter your age:", "25");
    if (!patientAge) return;
  }

  try {
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;

    const requestData = {
      patientName,
      age: parseInt(patientAge),
      doctorId,
      doctorName,
      doctorSpecialty,
      status: "pending",
      timestamp: serverTimestamp(),
      message: `Patient ${patientName} (${patientAge}) wants to consult.`,
      patientPeerId: peer.id   // ‚úÖ Now guaranteed to be valid
    };

    if (user) {
      requestData.userId = user.uid;
      requestData.userEmail = user.email;
    }

    console.log("üì§ Sending request with Peer ID:", peer.id);

    const docRef = await addDoc(collection(window.firebaseDB, "patientRequests"), requestData);
    sessionStorage.setItem("activeRequestId", docRef.id);
    alert(`‚úÖ Request sent to Dr. ${doctorName}! Please wait for acceptance.`);
    startListeningForDoctorAcceptance(docRef.id, doctorName);

  } catch (error) {
    console.error("Error sending request:", error);
    alert("‚ùå Failed to send request.");
  }
}





// ‚úÖ GET PATIENT DATA BY USER ID
async function getPatientData(userId) {
  try {
    const { collection, query, where, getDocs } = window.firestoreFunctions;
    
    const q = query(
      collection(window.firebaseDB, 'patients'),
      where('userId', '==', userId)
    );
    
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const doc = snapshot.docs[0];
      return {
        id: doc.id,
        ...doc.data()
      };
    }
    
    return null;
    
  } catch (error) {
    console.error('‚ùó Error getting patient data:', error);
    return null;
  }
}


// ============================================
// UPDATE displayDoctors TO USE NEW MODAL
// ============================================
// Display Patients (Doctor Mode)
function displayPatients(patients) {
  console.log('√∞≈∏‚Äì¬º√Ø¬∏¬è Displaying patients:', patients);
  
  const doctorList = document.getElementById('doctorList');
  if (!doctorList) {
    console.error('‚ùó doctorList element not found');
    return;
  }
  
  if (!patients || patients.length === 0) {
    doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No patients waiting</p>';
    return;
  }
  
  // Clear existing content
  doctorList.innerHTML = '';
  
  // Create patient cards
  patients.forEach(patient => {
    const card = document.createElement('div');
    card.className = 'doctor-card';
    card.innerHTML = `
      <div class="doctor-info">
        <div class="doctor-name">${patient.patientName || 'Anonymous Patient'}</div>
        <div class="doctor-specialty">Age: ${patient.age || 'N/A'} √¢‚Ç¨¬¢ ${patient.urgency || 'Normal'}</div>
        <div style="font-size: 0.75rem; color: #666; margin-top: 4px;">${patient.message || 'Waiting for consultation'}</div>
      </div>
      <div class="status-indicator status-available"></div>
    `;
    
   card.addEventListener('click', () => {
  console.log('üîµPatient card clicked:', patient);
  console.log('üîç Patient ID:', patient.id);  // Add this debug line
  acceptPatientRequest(patient);  // ‚úÖ Pass the whole object
});


    
    doctorList.appendChild(card);
  });
  
  console.log(`‚úÖ Displayed ${patients.length} patient card(s)`);
  
  // ‚úÖ UPDATE BANNER WITH NEW PATIENT COUNT
  updateDoctorBanner(patients.length);
}

// ‚úÖ ADD THIS NEW FUNCTION
function updateDoctorBanner(patientCount) {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  // Only update if doctor is NOT in active consultation
  if (window.activePatient) return;
  
  // Find and update the welcome banner
  const firstMessage = chatWindow.querySelector('.bot-msg');
  if (firstMessage) {
    firstMessage.innerHTML = `
      <strong>ü§ù Welcome, Dr. ${currentDoctor?.name || 'Doctor'}!</strong><br>
      Ready to help patients today.<br>
      <span style="font-size: 1.1rem; font-weight: bold;">üì´ ${patientCount} patient(s) waiting</span>
    `;
  }
}


// ========== PATIENT LISTENS FOR DOCTOR ACCEPTANCE - FIXED ==========
async function acceptPatientRequest(patient) {
  if (!confirm(`Accept consultation request from ${patient.patientName}?`)) return;
  
  try {
    const { doc, updateDoc, getDoc } = window.firestoreFunctions;
    
    // ‚úÖ FIX: Change 'active' to 'accepted'
    await updateDoc(doc(window.firebaseDB, 'patientRequests', patient.id), {
      status: 'accepted',  // ‚Üê Changed from 'active' to 'accepted'
      acceptedAt: new Date().toISOString(),
      notified: false  // ‚Üê Add this so patient listener triggers
    });
    
    // Store active patient data
    const requestDoc = await getDoc(doc(window.firebaseDB, 'patientRequests', patient.id));
    if (requestDoc.exists()) {
      window.activePatient = { id: patient.id, ...requestDoc.data() };
      console.log('‚úÖ Active patient stored:', window.activePatient);
    }
    
    alert(`‚úÖ Request Accepted! You are now consulting with ${patient.patientName}.`);
    
    // Start doctor chat
    startDoctorChat(patient);
    
  } catch (error) {
    console.error('‚ùå Error accepting request:', error);
    alert('‚ùå Failed to accept request. Please try again.');
  }
}


// ‚úÖ ADD THIS NEW FUNCTION
function convertToConsultationWaitingMode(patient) {
  console.log('√∞≈∏‚Äù‚Äû Converting to consultation waiting mode...');
  
  // Hide normal search bar (AI chat)
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'none';
  
  // Update chat window
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = `
      <div class="bot-msg" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        <strong>‚úÖ Consultation Request Accepted!</strong><br>
        Patient: <strong>${patient.patientName}</strong> (Age: ${patient.age})
      </div>
      <div class="bot-msg" style="background: #fbbf24;">
        <strong>√¢¬è¬≥ Waiting for Patient Response...</strong><br>
        You have accepted ${patient.patientName}'s consultation request.<br>
        Waiting for patient to join the conversation...
      </div>
    `;
  }
  
  console.log('‚úÖ Converted to waiting mode');
}


// ‚úÖ Show waiting banner (doctor side)
function showWaitingForPatientBanner(patient) {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  chatWindow.innerHTML = `
    <div class="bot-msg" style="background: #fbbf24;">
      <strong>√¢¬è¬≥ Waiting for Patient Response...</strong><br>
      You have accepted <strong>${patient.patientName}</strong>'s consultation request.<br>
      Waiting for patient to join the conversation...
    </div>
  `;
}

// ‚úÖ Listen for patient response (accept or decline)
function listenForPatientResponse(patient) {
  console.log('üîç Listening for patient response...');
  
  if (!window.firebaseDB) return;
  
  const { doc, onSnapshot } = window.firestoreFunctions;
  
  const unsubscribe = onSnapshot(doc(window.firebaseDB, 'patientRequests', patient.id), (docSnapshot) => {
    if (docSnapshot.exists()) {
      const data = docSnapshot.data();
      console.log('√∞≈∏‚Äú¬° Patient request status:', data.status);
      
      if (data.status === 'declined') {
        // Patient declined
        unsubscribe();
        
        alert(`‚ùó ${patient.patientName} declined the consultation.`);
        
        // ‚úÖ RESET TO NORMAL CHAT BOX
        resetDoctorToNormalChat();
        
      } else if (data.consultationStarted === true) {
        // ‚úÖ Patient accepted - start full consultation
        unsubscribe();
        startDoctorChat(patient);
      }
    }
  });
  
  window.patientResponseListener = unsubscribe;
}

// ‚úÖ ADD THIS FUNCTION
function resetDoctorToNormalChat() {
  console.log('√∞≈∏‚Äù‚Äû Resetting doctor interface to normal chat...');
  
  // Clear active patient
  window.activePatient = null;
  
  // Show search bar (AI chat)
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'flex';
  
  // Reload patient list and show welcome banner
  initializeDoctorChatArea();
  loadPatientList();
  
  console.log('‚úÖ Doctor interface reset');
}

// ‚úÖ ADD THIS NEW FUNCTION - START DOCTOR CHAT WITH PATIENT
// ‚úÖ START DOCTOR CHAT WITH PATIENT - FIXED
function startDoctorChat(patient) {
  console.log('ü©∫ Starting doctor chat with patient:', patient);
  
  if (!patient || !patient.id) {
    console.error('‚ùå Patient object missing ID!', patient);
    alert('Error: Cannot start chat - patient data incomplete.');
    return;
  }
  
  // Store active patient info
  window.activePatient = {
    id: patient.id,
    patientName: patient.patientName,
    age: patient.age,
    message: patient.message,
    doctorId: patient.doctorId
  };
  
  console.log('‚úÖ window.activePatient set:', window.activePatient);
  
  // Update chat window with WAITING message
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = `
      <div class="bot-msg" style="background: #10b981;">
        <strong>‚úÖ Request Accepted!</strong><br>
        You have accepted <strong>${patient.patientName}</strong>'s consultation request.
      </div>
      <div class="bot-msg" style="background: #fbbf24; color: #92400e;">
        <strong>‚è≥ Waiting for Patient...</strong><br>
        Waiting for ${patient.patientName} to join the conversation.<br>
        They will receive a notification to connect.
      </div>
    `;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  // Hide search bar
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'none';
  
  // ‚úÖ START LISTENING FOR PATIENT TO ACCEPT
  listenForPatientAcceptance(patient);
  
  // ‚úÖ FUNCTION ENDS HERE - No more code!
}

// Doctor listens for patient to accept/decline
function listenForPatientAcceptance(patient) {
  console.log('üëÇ Doctor waiting for patient response...');
  
  if (!window.firebaseDB) return;
  
  const { doc, onSnapshot } = window.firestoreFunctions;
  
  const unsubscribe = onSnapshot(
    doc(window.firebaseDB, 'patientRequests', patient.id),
    (docSnapshot) => {
      if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        
        console.log('üì° Patient response status:', data.consultationStarted, data.notified);
        
        // ‚úÖ Patient accepted - start full consultation
        if (data.consultationStarted === true && data.notified === true) {
          console.log('‚úÖ Patient accepted! Starting consultation...');
          
          // Stop listening
          unsubscribe();
          
          // Update UI - show "Patient Connected"
          const chatWindow = document.getElementById('chatWindow');
          if (chatWindow) {
            chatWindow.innerHTML = `
              <div class="bot-msg" style="background: #10b981;">
                <strong>‚úÖ Consultation Started!</strong><br>
                <strong>${patient.patientName}</strong> has joined the conversation.
              </div>
            `;
          }
          
          // Show consultation controls
          showDoctorConsultationControls(patient);
          
          // Start listening for messages
          startListeningToPatientMessages(patient.id);
        }
        
        // ‚úÖ Patient declined
        if (data.status === 'declined') {
          console.log('‚ùå Patient declined consultation');
          
          unsubscribe();
          
          alert(`${patient.patientName} declined the consultation.`);
          
          // Reset to normal chat
          resetDoctorToNormalChat();
        }
      }
    }
  );
  
  // Store for cleanup
  window.patientAcceptanceListener = unsubscribe;
}

// Show consultation controls for doctor
function showDoctorConsultationControls(patient) {
  const chatSection = document.querySelector('.chat-section');
  if (!chatSection) return;
  
  // Remove existing controls
  const existing = document.getElementById('doctorConsultationControls');
  if (existing) existing.remove();
  
  // Create consultation bar
  const consultationHTML = `
    <div id="doctorConsultationControls" style="
      flex: 0 0 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-top: 3px solid #2563eb;
      background: white;
      padding: 12px 16px;
    ">
      <input 
        type="text" 
        id="doctorConsultationInput" 
        placeholder="Type your response to ${patient.patientName}..."
        style="
          flex: 1;
          border: 2px solid #9fbff0c1;
          border-radius: 8px;
          padding: 10px 12px;
          font-size: 0.95rem;
          outline: none;
        "
      />
      <button onclick="sendDoctorMessage()" class="btn send" style="padding: 10px 15px;">
        Send
      </button>
      <button onclick="startVoiceCall()" class="btn mic" style="padding: 10px 15px;">
        üìû Voice Call
      </button>
      <button onclick="startVideoCall()" class="btn upload" style="padding: 10px 15px; background: #10b981;">
        üìπ Video Call
      </button>
      <button onclick="endConsultation()" class="btn" style="padding: 10px 15px; background: #dc2626;">
        End
      </button>
    </div>
  `;
  
  chatSection.insertAdjacentHTML('beforeend', consultationHTML);
  console.log('‚úÖ Doctor consultation controls shown');
}


// Patient declines consultation
async function declineConsultation(requestId) {
  console.log('‚ùå Patient declining consultation');
  
  try {
    if (window.firebaseDB) {
      const { doc, updateDoc } = window.firestoreFunctions;
      
      await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
        status: 'declined',
        declinedAt: new Date().toISOString()
      });
    }
    
    // Close notification
    const modal = document.getElementById('acceptanceNotification');
    if (modal) modal.remove();
    
    alert('You declined the consultation. You can connect with another doctor.');
    
  } catch (error) {
    console.error('‚ùå Error declining:', error);
  }
}






// ‚úÖ LISTEN FOR PATIENT MESSAGES IN REAL-TIME
function startListeningToPatientMessages(requestId) {
  console.log('üîç Doctor listening for patient messages...');
  
  if (!window.firebaseDB) return;
  
  const { collection, query, where, orderBy, onSnapshot } = window.firestoreFunctions;
  
  // Listen to conversations collection
  const q = query(
    collection(window.firebaseDB, 'conversations'),
    where('patientRequestId', '==', requestId),
    orderBy('timestamp', 'asc')
  );
  
  // Real-time listener
  const unsubscribe = onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        const msg = change.doc.data();
        
        // Only show patient messages (don't duplicate doctor's own messages)
        if (msg.sender === 'patient') {
          displayMessageInChat(msg.message, 'patient');
        }
      }
    });
  });
  
  // Store unsubscribe function for cleanup
  window.messageListener = unsubscribe;
}

// Helper function to display messages
function displayMessageInChat(message, sender) {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  const className = sender === 'patient' ? 'bot-msg' : 'user-msg';
  
  chatWindow.innerHTML += `<div class="${className}">${message}</div>`;
  chatWindow.scrollTop = chatWindow.scrollHeight;
  
  console.log('√∞≈∏‚Äô¬¨ New message displayed from:', sender);
}


// ‚úÖ SEND MESSAGE FROM DOCTOR TO PATIENT - FULLY FIXED
async function sendDoctorMessage() {
   console.log('√∞≈∏≈°¬® sendDoctorMessage CALLED!'); // √¢‚Ä†¬ê ADD THIS LINE FIRST
  const input = document.getElementById('doctorConsultationInput');
  
  if (!input) {
    console.error('‚ùó Input field not found');
    return;
  }
  
  const message = input.value.trim();
  
  if (!message) {
    alert('Please enter a message');
    return;
  }
  // ‚úÖ ADD THIS DEBUG LOG
  console.log('√∞≈∏‚Äù¬ç activePatient check:', window.activePatient);
  console.log('√∞≈∏‚Äù¬ç activePatient.id:', window.activePatient?.id);
  
  // Add message to chat IMMEDIATELY (optimistic update)
  const chatWindow = document.getElementById('chatWindow');
  
  if (chatWindow) {
    chatWindow.innerHTML += `
      <div class="user-msg">${message}</div>
    `;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  input.value = '';
  
  // ‚úÖ SEND TO FIREBASE
  try {
    // ‚úÖ VALIDATE ACTIVE PATIENT
    if (!window.activePatient || !window.activePatient.id) {
      console.error('‚ùó No active patient found');
      alert('Error: No active patient. Please refresh and try again.');
      return;
    }
    
    if (!window.firebaseDB) {
      console.error('‚ùó Firebase not initialized');
      alert('Error: Database not connected. Please refresh.');
      return;
    }
    
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    
    // ‚úÖ SAVE MESSAGE TO FIREBASE WITH CORRECT FIELD
    await addDoc(collection(window.firebaseDB, 'conversations'), {
      patientRequestId: window.activePatient.id,  // ‚úÖ CORRECT - This is the request ID
      doctorId: currentDoctor?.id || 'unknown',
      patientName: window.activePatient.patientName,
      sender: 'doctor',
      message: message,
      timestamp: serverTimestamp()
    });
    
    console.log('‚úÖ Doctor message sent successfully:', message);
    
  } catch (error) {
    console.error('‚ùó Error sending message:', error);
    alert('Failed to send message: ' + error.message);
  }
}

async function endConsultation() {
  const confirmed = confirm('Are you sure you want to end this consultation?');
  
  if (!confirmed) return;
  
  console.log('√∞≈∏‚Ä∫‚Äò Ending consultation...');
  
  try {
    // ‚úÖ Notify Firebase that doctor ended consultation
    if (window.activePatient && window.activePatient.id && window.firebaseDB) {
      const { doc, updateDoc, serverTimestamp } = window.firestoreFunctions;
      
      await updateDoc(doc(window.firebaseDB, 'patientRequests', window.activePatient.id), {
        status: 'ended',
        endedAt: serverTimestamp(),
        endedBy: 'doctor'
      });
      
      console.log('‚úÖ Consultation ended in Firebase');
    }
  } catch (error) {
    console.error('‚ùó Error updating Firebase:', error);
  }
  
  // Stop message listener
  if (window.messageListener) {
    window.messageListener();
    window.messageListener = null;
  }
  
  // Clear active patient
  window.activePatient = null;
  
  // Remove consultation controls
  const controls = document.getElementById('doctorConsultationControls');
  if (controls) controls.remove();
  
  // Show search bar again
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'flex';
  
  // Clear chat window
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = `
      <div class="bot-msg">
        ‚úÖ <strong>Consultation ended.</strong><br>
        You can now accept new patients from the Patient List.
      </div>
    `;
  }
  
  console.log('‚úÖ Consultation ended successfully');
  alert('‚úÖ Consultation ended successfully.');
}


// ========== PATIENT LISTENS FOR DOCTOR ACCEPTANCE - FIXED ==========

function startListeningForDoctorAcceptance(requestId, doctorName) {
  console.log('üëÇ Listening for doctor acceptance...');
  
  if (!window.firebaseDB) return;
  
  // ‚úÖ Prevent duplicate listeners
  if (window.acceptanceListener) {
    console.log('‚ùó Already listening, cleaning up old listener...');
    window.acceptanceListener();
  }
  
  const { doc, onSnapshot } = window.firestoreFunctions;
  
  // ‚úÖ LISTEN TO REQUEST DOCUMENT
  const unsubscribe = onSnapshot(
    doc(window.firebaseDB, 'patientRequests', requestId),
    (docSnapshot) => {
      if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        
        console.log('√∞≈∏‚Äú¬° Request status update:', data.status);
        
        // ‚úÖ CHECK IF DOCTOR ACCEPTED
        if (data.status === 'accepted' && !data.notified) {
          // Stop listening
          unsubscribe();
          window.acceptanceListener = null;
          
          // ‚úÖ SHOW NOTIFICATION TO PATIENT
          showDoctorAcceptanceNotification(doctorName, requestId, data);
        }
      }
    },
    (error) => {
      console.error('‚ùó Error listening for acceptance:', error);
    }
  );
  
  // Store unsubscribe function for cleanup
  window.acceptanceListener = unsubscribe;
  console.log('‚úÖ Real-time listener activated for request:', requestId);
}

// ‚úÖ SHOW NOTIFICATION WHEN DOCTOR ACCEPTS - FIXED
function showDoctorAcceptanceNotification(doctorName, requestId, patientData) {
  console.log('√∞≈∏‚Äù‚Äù Doctor accepted! Showing notification...');
  
  // ‚úÖ CREATE CUSTOM NOTIFICATION MODAL
  const modalHTML = `
    <div id="acceptanceNotification" class="modal-overlay" style="display: flex;">
      <div class="modal-content" style="max-width: 450px; text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 15px;">‚úÖ</div>
        <h2 style="color: #10b981; margin: 0 0 15px 0;">Request Accepted!</h2>
        <p style="font-size: 1.1rem; color: #333; margin-bottom: 20px;">
          <strong>Dr. ${doctorName}</strong> has accepted your consultation request and is ready to talk with you.
        </p>
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 25px;">
          Do you want to start the consultation now?
        </p>
        <div style="display: flex; gap: 10px;">
          <button 
            onclick="declineConsultation('${requestId}')" 
            style="
              flex: 1;
              padding: 14px;
              background: #dc2626;
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              font-size: 1rem;
              cursor: pointer;
            "
          >
            Later
          </button>
          <button 
            onclick="startPatientConsultation('${doctorName}', '${requestId}', ${JSON.stringify(patientData).replace(/"/g, '&quot;')})" 
            style="
              flex: 1;
              padding: 14px;
              background: linear-gradient(135deg, #10b981 0%, #059669 100%);
              color: white;
              border: none;
              border-radius: 8px;
              font-weight: bold;
              font-size: 1rem;
              cursor: pointer;
            "
          >
            Connect Now
          </button>
        </div>
      </div>
    </div>
  `;
  


  
  // Remove existing notification if any
  const existing = document.getElementById('acceptanceNotification');
  if (existing) existing.remove();
  
  // Add to page
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// ‚úÖ PATIENT ACCEPTS TO START CONSULTATION - NEW
async function startPatientConsultation(doctorName, requestId, patientData) {
  console.log('√∞≈∏¬§¬ù Patient accepted consultation');
  
  try {
    // ‚úÖ MARK AS NOTIFIED IN FIREBASE
    if (window.firebaseDB) {
      const { doc, updateDoc } = window.firestoreFunctions;
      
      await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
        notified: true,
        consultationStarted: true,
        startedAt: new Date().toISOString()
      });
    }
    
    // ‚úÖ CLOSE NOTIFICATION
    const modal = document.getElementById('acceptanceNotification');
    if (modal) modal.remove();
    
    // ‚úÖ SHOW SUCCESS MESSAGE
    alert(`Consultation Started! You are now connected with Dr. ${doctorName}.`);
    
    // ‚úÖ CONVERT CHAT INTERFACE TO CONSULTATION MODE
     // Convert chat interface to consultation mode
  convertPatientToConsultationMode(doctorName, requestId, patientData);  // ‚úÖ Add requestId

    
  } catch (error) {
    console.error('‚ùó Error starting consultation:', error);
    alert('Failed to start consultation. Please try again.');
  }
}


// ‚úÖ CONVERT PATIENT CHAT TO CONSULTATION MODE - COMPLETE VERSION
function convertPatientToConsultationMode(doctorName, requestId, patientData) {
  console.log('√∞≈∏‚Äù‚Äû Converting to consultation mode...');
  
  // ‚úÖ Store consultation info WITH REQUEST ID
  window.activeConsultation = {
    doctorName: doctorName,
    requestId: requestId,
    patientName: patientData?.patientName || 'Patient',
    patientData: patientData,
    startedAt: new Date().toISOString()
  };
  
  console.log('‚úÖ Stored activeConsultation:', window.activeConsultation);
  
  // ‚úÖ HIDE NORMAL SEARCH BAR
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'none';
  }
  
  // ‚úÖ UPDATE CHAT WINDOW WITH GREETING
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = `
      <div class="bot-msg" style="background: #10b981;">
        <strong>‚úÖ Consultation Started!</strong><br>
        You are now connected with <strong>Dr. ${doctorName}</strong>.<br>
        You can start chatting with the doctor below.
      </div>
    `;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  // ‚úÖ CREATE NEW CONSULTATION CONTROLS
  const chatSection = document.querySelector('.chat-section');
  if (!chatSection) return;
  
  // Remove existing consultation bar if any
  const existing = document.getElementById('patientConsultationControls');
  if (existing) existing.remove();
  
  // ‚úÖ CREATE CONSULTATION BAR
  const consultationHTML = `
    <div id="patientConsultationControls" style="
      flex: 0 0 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-top: 3px solid #2563eb;
      background: white;
      padding: 12px 16px;
    ">
      <input 
        type="text" 
        id="patientConsultationInput" 
        placeholder="Type your message to Dr. ${doctorName}..."
        style="
          flex: 1;
          border: 2px solid #9fbff0c1;
          border-radius: 8px;
          padding: 10px 12px;
          font-size: 0.95rem;
          outline: none;
        "
      />
      <button 
        onclick="sendPatientMessage()" 
        class="btn send"
        style="padding: 10px 15px;"
      >
        Send
      </button>
      <button 
        onclick="startVoiceCall()" 
        class="btn mic"
        style="padding: 10px 15px;"
      >
        üìû Voice Call
      </button>
      <button 
        onclick="startVideoCall()" 
        class="btn upload"
        style="padding: 10px 15px; background: #10b981;"
      >
        üìπ Video Call
      </button>
    </div>
  `;
  
  chatSection.insertAdjacentHTML('beforeend', consultationHTML);
  
  console.log('‚úÖ Patient consultation mode activated');
  
  // ‚úÖ START LISTENING FOR DOCTOR MESSAGES
  startListeningToDoctorMessages(requestId);
  
  // ‚úÖ START LISTENING FOR CONSULTATION END
  listenForConsultationEnd(requestId);
}

// Listen for consultation end (if doctor ends it)
function listenForConsultationEnd(requestId) {
  console.log('üëÇ Listening for consultation end...');
  
  if (!window.firebaseDB) return;
  
  const { doc, onSnapshot } = window.firestoreFunctions;
  
  const unsubscribe = onSnapshot(
    doc(window.firebaseDB, 'patientRequests', requestId),
    (docSnapshot) => {
      if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        
        if (data.status === 'ended') {
          console.log('üõë Consultation ended by doctor');
          
          // Stop listening
          unsubscribe();
          
          // Show message
          alert('Consultation ended by doctor.');
          
          // Reload page to reset
          location.reload();
        }
      }
    }
  );
  
  // Store for cleanup
  window.consultationEndListener = unsubscribe;
}



// ‚úÖ LISTEN FOR DOCTOR MESSAGES IN REAL-TIME
function startListeningToDoctorMessages(requestId) {
  console.log('üîç Patient listening for doctor messages...');
  
  if (!window.firebaseDB) return;
  
  const { collection, query, where, orderBy, onSnapshot } = window.firestoreFunctions;
  
  // Listen to conversations collection
  const q = query(
    collection(window.firebaseDB, 'conversations'),
    where('patientRequestId', '==', requestId),
    orderBy('timestamp', 'asc')
  );
  
  // Real-time listener
  const unsubscribe = onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      if (change.type === 'added') {
        const msg = change.doc.data();
        
        // Only show doctor messages (don't duplicate patient's own messages)
        if (msg.sender === 'doctor') {
          displayMessageInChat(msg.message, 'doctor');
        }
      }
    });
  });
  
  // Store unsubscribe function for cleanup
  window.messageListener = unsubscribe;
}

// Helper function to display messages
function displayMessageInChat(message, sender) {
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  // ‚úÖ FIX: Determine correct CSS class based on sender
  let className;
  
  // Check if we're in doctor mode
  const isDoctorMode = window.activePatient != null;
  
  if (isDoctorMode) {
    // Doctor interface: patient=left(blue), doctor=right(green)
    className = sender === 'patient' ? 'bot-msg' : 'user-msg';
  } else {
    // Patient interface: doctor=left(blue), patient=right(green)
    className = sender === 'doctor' ? 'bot-msg' : 'user-msg';
  }
  
  chatWindow.innerHTML += `<div class="${className}">${message}</div>`;
  chatWindow.scrollTop = chatWindow.scrollHeight;
  
  console.log('√∞≈∏‚Äô¬¨ New message displayed from:', sender, '| class:', className);
}




// ‚úÖ KEEP AND FIX THIS ONE
async function sendPatientMessage() {
  const input = document.getElementById('patientConsultationInput');
  
  if (!input) return;
  
  const message = input.value.trim();
  
  if (!message) {
    alert('Please enter a message');
    return;
  }
  
  // ‚úÖ ADD VALIDATION
  console.log('√∞≈∏‚Äù¬ç Checking window.activeConsultation:', window.activeConsultation);
  
  if (!window.activeConsultation || !window.activeConsultation.requestId) {
    console.error('‚ùó No active consultation or request ID missing');
    alert('‚ùó Error: Consultation session lost. Please refresh the page.');
    return;
  }
  
  console.log('‚úÖ Request ID found:', window.activeConsultation.requestId);
  
  // Add message to chat
  const chatWindow = document.getElementById('chatWindow');
  
  if (chatWindow) {
    chatWindow.innerHTML += `<div class="user-msg">${message}</div>`;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  input.value = '';
  
  // ‚úÖ SEND TO FIREBASE
  try {
    if (!window.firebaseDB) {
      console.error('‚ùó Firebase not initialized');
      alert('‚ùó Database not connected. Please refresh.');
      return;
    }
    
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    
    await addDoc(collection(window.firebaseDB, 'conversations'), {
      patientRequestId: window.activeConsultation.requestId,
      patientName: window.activeConsultation.patientName || 'Patient',
      sender: 'patient',
      message: message,
      timestamp: serverTimestamp()
    });
    
    console.log('‚úÖ Patient message sent successfully:', message);
    
  } catch (error) {
    console.error('‚ùó Error sending message:', error);
    alert('‚ùó Failed to send message: ' + error.message);
  }
}



async function declineConsultation(requestId) {
  console.log('‚ùó Patient declined consultation');
  
  try {
    // ‚úÖ Update Firebase - mark as declined
    if (window.firebaseDB) {
      const { doc, updateDoc } = window.firestoreFunctions;
      await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
        status: 'declined',
        notified: true,
        declinedAt: new Date().toISOString(),
        declineReason: 'Patient chose to connect later'
      });
      
      console.log('‚úÖ Request marked as declined in Firebase');
    }
    
    // Close notification
    const modal = document.getElementById('acceptanceNotification');
    if (modal) modal.remove();
    
    alert('‚úÖ You can connect with the doctor later from your consultation history.');
    
  } catch (error) {
    console.error('‚ùó Error declining consultation:', error);
  }
}


// ========== PATIENT ACCEPTS TO START CONSULTATION ==========

// Patient clicks "Connect Now"
async function startConsultation(doctorName, requestId) {
  console.log('‚úÖ Patient accepted consultation');
  
  try {
    // ‚úÖ MARK AS NOTIFIED IN FIREBASE
    if (window.firebaseDB) {
      const { doc, updateDoc } = window.firestoreFunctions;
      await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
        notified: true,
        consultationStarted: true,
        startedAt: new Date().toISOString()
      });
    }
    
    // ‚úÖ CLOSE NOTIFICATION
    const modal = document.getElementById('acceptanceNotification');
    if (modal) modal.remove();
    
    // ‚úÖ SHOW SUCCESS MESSAGE
    alert(`üü¢ Consultation Started!\n\nYou are now connected with Dr. ${doctorName}.`);
    
    // ‚úÖ CONVERT CHAT INTERFACE TO CONSULTATION MODE
    convertToConsultationMode(doctorName);
    
  } catch (error) {
    console.error('‚ùó Error starting consultation:', error);
    alert('‚ùó Failed to start consultation. Please try again.');
  }
}


// Patient clicks "Later"
async function declineConsultation(requestId) {
  console.log('‚ùó Patient declined consultation');
  
  try {
    // ‚úÖ NOTIFY DOCTOR THAT PATIENT DECLINED
    if (window.firebaseDB) {
      const { doc, updateDoc } = window.firestoreFunctions;
      await updateDoc(doc(window.firebaseDB, 'patientRequests', requestId), {
        status: 'declined',
        notified: true,
        declinedAt: new Date().toISOString()
      });
    }
    
    // ‚úÖ CLOSE NOTIFICATION
    const modal = document.getElementById('acceptanceNotification');
    if (modal) modal.remove();
    
    alert('You can connect with the doctor later from your request history.');
    
  } catch (error) {
    console.error('‚ùó Error declining:', error);
  }
}

// ========== CONVERT CHAT INTERFACE TO CONSULTATION MODE ==========

function convertToConsultationMode(doctorName) {
  console.log('√∞≈∏‚Äù‚Äû Converting to consultation mode...');
  
  // ‚úÖ HIDE SEARCH BAR
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'none';
  }
  
  // ‚úÖ CREATE NEW CONSULTATION CONTROLS
  const chatSection = document.querySelector('.chat-section');
  if (!chatSection) return;
  
  // Remove existing consultation bar if any
  const existing = document.getElementById('consultationControls');
  if (existing) existing.remove();
  
  // ‚úÖ CREATE CONSULTATION BAR WITH VIDEO/VOICE CALL
  const consultationHTML = `
    <div id="consultationControls" style="
      flex: 0 0 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-top: 3px solid #2563eb;
      background: white;
      padding: 12px 16px;
    ">
      <input 
        type="text" 
        id="consultationInput"
        placeholder="Type your message to Dr. ${doctorName}..."
        style="
          flex: 1;
          border: 2px solid #9fbff0c1;
          border-radius: 8px;
          padding: 10px 12px;
          font-size: 0.95rem;
          outline: none;
        "
      />
      
      <button onclick="sendConsultationMessage()" class="btn send" 
              style="padding: 10px 15px;">
         Send
      </button>
      
      <button onclick="startVoiceCall()" class="btn mic" 
              style="padding: 10px 15px;">
         Voice Call
      </button>
      
      <button onclick="startVideoCall()" class="btn upload" 
              style="padding: 10px 15px; background: #10b981;">
         Video Call
      </button>
    </div>
  `;
  
  chatSection.insertAdjacentHTML('beforeend', consultationHTML);
  
  // ‚úÖ UPDATE CHAT WINDOW WITH GREETING
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML += `
      <div class="bot-msg" style="background: #10b981;">
        ‚úÖ <strong>Consultation Started!</strong><br>
        You are now connected with <strong>Dr. ${doctorName}</strong>.<br>
        You can start chatting or click the call buttons to start a voice/video call.
      </div>
    `;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  console.log('‚úÖ Consultation mode activated');
}


// ‚úÖ PLACEHOLDER FUNCTIONS FOR CALLS
function sendConsultationMessage() {
  const input = document.getElementById('consultationInput');
  if (!input) return;
  
  const message = input.value.trim();
  if (!message) return;
  
  // Add message to chat
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML += `
      <div class="user-msg">${message}</div>
    `;
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  input.value = '';
  
  // TODO: Send to Firebase and notify doctor
  console.log('‚úÖMessage sent:', message);
}

// ========== ENHANCED SYMPTOM DATABASE ==========

const symptomDatabase = {
  // Neurological Symptoms
  'headache': {
    name: 'Headache',
    category: 'Neurological',
    image: 'https://images.unsplash.com/photo-1584515933487-779824d29309?w=500',
    description: 'A headache is pain or discomfort in the head, scalp, or neck area. It can range from mild to severe and may be throbbing, constant, sharp, or dull. Common types include tension headaches, migraines, and cluster headaches. Headaches can be caused by stress, dehydration, lack of sleep, eye strain, sinus infections, or underlying medical conditions. Most headaches are not serious and can be treated with rest, hydration, and over-the-counter pain relievers.',
    advice: 'Seek immediate medical attention if you experience sudden severe headache, headache with fever and stiff neck, headache after head injury, or headache with confusion or loss of consciousness.'
  },
  
  'dizziness': {
    name: 'Dizziness',
    category: 'Neurological',
    image: 'https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=500',
    description: 'Dizziness is a feeling of lightheadedness, unsteadiness, or spinning sensation (vertigo). It can affect your balance and coordination, making you feel like you or your surroundings are moving when they are not. Common causes include inner ear problems, low blood pressure, dehydration, anxiety, medication side effects, or neurological conditions. Episodes can last from seconds to hours and may be accompanied by nausea or vomiting.',
    advice: 'Consult a doctor if dizziness is frequent, severe, accompanied by chest pain, rapid heartbeat, difficulty breathing, or if it occurs after a head injury. Immediate care is needed if you experience sudden severe dizziness with double vision or difficulty speaking.'
  },
  
  'numbness': {
    name: 'Numbness & Tingling',
    category: 'Neurological',
    image: 'https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=500',
    description: 'Numbness is a loss or decrease in sensation in a part of your body, often accompanied by tingling (pins and needles sensation). It commonly occurs in hands, feet, arms, or legs. Causes include nerve compression (like carpal tunnel syndrome), poor circulation, diabetes, vitamin deficiencies, multiple sclerosis, or prolonged pressure on a nerve. Temporary numbness from sitting in one position too long is usually harmless, but persistent or unexplained numbness requires medical evaluation.',
    advice: 'Seek immediate medical attention if numbness occurs suddenly, affects one side of your body, is accompanied by weakness or difficulty speaking, follows a head injury, or involves loss of bowel or bladder control. These could indicate stroke or spinal cord injury.'
  },
  
  'seizure': {
    name: 'Seizures',
    category: 'Neurological',
    image: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=500',
    description: 'A seizure is a sudden, uncontrolled electrical disturbance in the brain that can cause changes in behavior, movements, feelings, or consciousness. Symptoms vary widely and may include convulsions, muscle stiffness, loss of awareness, staring spells, temporary confusion, or uncontrollable jerking movements. Seizures can be caused by epilepsy, high fever, head trauma, stroke, brain tumors, infections, low blood sugar, or drug withdrawal. Not all seizures involve convulsions, and some may appear as brief lapses in awareness.',
    advice: 'Call emergency services immediately if a seizure lasts more than 5 minutes, the person has multiple seizures without regaining consciousness, has difficulty breathing after the seizure, or is injured during the seizure. First-time seizures always require medical evaluation.'
  },
  
  'memory-loss': {
    name: 'Memory Loss',
    category: 'Neurological',
    image: 'https://images.unsplash.com/photo-1559757175-5700dde675bc?w=500',
    description: 'Memory loss (amnesia) is the inability to recall information or past experiences. It can be temporary or permanent, and may affect recent memories (short-term) or distant memories (long-term). Mild forgetfulness is normal with aging, but significant memory loss can indicate serious conditions. Causes include head injury, stroke, dementia, Alzheimer\'s disease, vitamin B12 deficiency, thyroid problems, medication side effects, stress, depression, or alcohol abuse. Memory problems may also involve difficulty learning new information or confusion about time and place.',
    advice: 'Consult a doctor if memory loss interferes with daily activities, worsens over time, is accompanied by confusion or personality changes, or if you forget recent events but remember distant past clearly. Sudden severe memory loss requires immediate medical attention.'
  },
  
  // Respiratory Symptoms
  'cough': {
    name: 'Persistent Cough',
    category: 'Respiratory',
    image: 'https://images.unsplash.com/photo-1584515979956-d9f6e5d09982?w=500',
    description: 'A persistent cough is one that lasts more than 8 weeks in adults or 4 weeks in children. It can be dry (non-productive) or wet (productive, bringing up mucus). Common causes include post-nasal drip, asthma, acid reflux, chronic bronchitis, allergies, smoking, or certain blood pressure medications. Less commonly, it can indicate more serious conditions like pneumonia, tuberculosis, lung cancer, or heart problems. A cough is the body\'s way of clearing the airways, but chronic coughing can disrupt sleep, cause fatigue, and affect quality of life.',
    advice: 'See a doctor if cough lasts more than 3 weeks, produces blood or thick discolored mucus, is accompanied by high fever, shortness of breath, chest pain, wheezing, or unexplained weight loss. Seek immediate care for severe difficulty breathing.'
  },
  
  'shortness-breath': {
    name: 'Shortness of Breath',
    category: 'Respiratory',
    image: 'https://images.unsplash.com/photo-1584515933487-779824d29309?w=500',
    description: 'Shortness of breath (dyspnea) is difficulty breathing or feeling like you cannot get enough air. It can occur suddenly (acute) or develop gradually (chronic). Common causes include asthma, COPD, heart disease, anxiety, anemia, pneumonia, blood clots in lungs, or being out of shape. You may feel breathless during physical activity, at rest, or when lying down. Associated symptoms may include wheezing, chest tightness, rapid heartbeat, or bluish lips. Chronic shortness of breath significantly impacts daily activities and quality of life.',
    advice: 'Call emergency services immediately if shortness of breath is sudden and severe, accompanied by chest pain, fainting, or blue lips. Seek urgent medical care if breathing difficulty worsens rapidly, occurs with swelling in feet and ankles, or is accompanied by high fever.'
  },
  
  'chest-pain': {
    name: 'Chest Pain',
    category: 'Cardiovascular',
    image: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=500',
    description: 'Chest pain is discomfort or pain felt anywhere in the chest area, from the neck to the upper abdomen. It can feel like sharp stabbing, dull aching, crushing pressure, or burning sensation. While some chest pain is related to heart problems (angina, heart attack), many cases are caused by less serious conditions like indigestion, muscle strain, anxiety, rib problems, or lung conditions. Heart-related chest pain often spreads to the jaw, shoulders, arms, or back. The character, location, duration, and triggers of chest pain help determine its cause.',
    advice: 'Call emergency services immediately if chest pain is sudden and severe, crushing or squeezing, radiating to jaw or left arm, accompanied by sweating, nausea, shortness of breath, or lasting more than a few minutes. Do not drive yourself - wait for ambulance. Even if pain subsides, seek immediate evaluation for potential heart attack.'
  },
  
  // Pain Symptoms
  'back-pain': {
    name: 'Back Pain',
    category: 'Musculoskeletal',
    image: 'https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=500',
    description: 'Back pain is one of the most common medical complaints, affecting the lower back (lumbar), middle back (thoracic), or upper back and neck (cervical) regions. Pain can be acute (lasting days to weeks) or chronic (lasting more than 3 months). Causes include muscle or ligament strain, bulging or ruptured discs, arthritis, osteoporosis, poor posture, lifting heavy objects improperly, or prolonged sitting. Most back pain improves with rest, gentle exercise, and over-the-counter pain relievers within a few weeks. Chronic back pain may indicate underlying structural problems.',
    advice: 'Seek medical attention if back pain follows a fall or injury, is severe and doesn\'t improve with rest, causes numbness or weakness in legs, is accompanied by unexplained weight loss or fever, or causes loss of bowel or bladder control (emergency - call immediately).'
  },
  
  'joint-pain': {
    name: 'Joint Pain',
    category: 'Musculoskeletal',
    image: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=500',
    description: 'Joint pain (arthralgia) is discomfort, aches, or soreness in any of the body\'s joints - knees, hips, shoulders, elbows, wrists, or fingers. It can range from mild to debilitating and may be constant or intermittent. Common causes include osteoarthritis (wear and tear), rheumatoid arthritis (autoimmune), gout, bursitis, sprains, infections, or lupus. Joint pain may be accompanied by swelling, stiffness, redness, warmth, or reduced range of motion. Age, previous injuries, obesity, and family history increase risk. Managing weight and staying active can help prevent and reduce joint pain.',
    advice: 'Consult a doctor if joint pain is severe, sudden, accompanied by significant swelling or redness, lasts more than a few weeks, or limits daily activities. Seek immediate care if joint pain follows an injury with severe swelling and deformity, or if accompanied by high fever and inability to move the joint.'
  },
  
  // Digestive Symptoms
  'nausea': {
    name: 'Nausea & Vomiting',
    category: 'Digestive',
    image: 'https://images.unsplash.com/photo-1584515933487-779824d29309?w=500',
    description: 'Nausea is an uncomfortable sensation of wanting to vomit, often felt in the back of the throat and stomach. It may or may not lead to actual vomiting. Common causes include food poisoning, stomach flu (gastroenteritis), morning sickness during pregnancy, motion sickness, migraine, anxiety, medication side effects, or eating too much. More serious causes include appendicitis, bowel obstruction, pancreatitis, liver disease, or concussion. Persistent nausea can lead to dehydration and electrolyte imbalances, especially if accompanied by frequent vomiting.',
    advice: 'Seek immediate medical care if nausea is accompanied by severe abdominal pain, chest pain, severe headache, stiff neck, confusion, signs of dehydration (dark urine, dizziness), or if you suspect food poisoning affecting multiple people. Persistent vomiting for more than 24 hours requires medical evaluation.'
  },
  
  'abdominal-pain': {
    name: 'Abdominal Pain',
    category: 'Digestive',
    image: 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=500',
    description: 'Abdominal pain is discomfort anywhere in the belly area, from below the ribs to the pelvis. It can be cramping, sharp, dull, or burning, and may be localized to one area or spread throughout the abdomen. Common causes include indigestion, gas, constipation, stomach virus, food intolerance, menstrual cramps, or urinary tract infection. More serious causes include appendicitis, gallstones, kidney stones, ulcers, inflammatory bowel disease, or hernias. The location, type, and duration of pain provide important clues about the cause.',
    advice: 'Call emergency services if abdominal pain is sudden and severe, accompanied by vomiting blood, bloody stools, high fever, rigid abdomen, or if you are pregnant. Seek urgent care for pain lasting several hours, accompanied by fever, inability to pass gas, tenderness when touching abdomen, or yellowing of skin.'
  }
};

// ========== SYMPTOM MODAL FUNCTIONS ==========

// Open symptom modal with details
function showSymptomDetails(symptomId) {
  const symptom = symptomDatabase[symptomId];
  
  if (!symptom) {
    alert('Symptom information not available');
    return;
  }
  
  // Update modal content
  document.getElementById('symptomImage').src = symptom.image;
  document.getElementById('symptomImage').alt = symptom.name;
  document.getElementById('symptomTitle').textContent = symptom.name;
  document.getElementById('symptomCategory').textContent = symptom.category;
  document.getElementById('symptomDescription').textContent = symptom.description;
  document.getElementById('symptomAdvice').textContent = symptom.advice;
  
  // Show modal
  document.getElementById('symptomModal').style.display = 'flex';
  
  console.log('‚úÖ Showing symptom details:', symptom.name);
}

// Close symptom modal
function closeSymptomModal() {
  document.getElementById('symptomModal').style.display = 'none';
}



// ============================================
// 1. SYMPTOMS GALLERY FUNCTIONS
// ============================================
function toggleGallery() {
  const panel = document.getElementById('galleryPanel');
  const content = document.getElementById('galleryContent');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
    panel.style.width = '0';
    content.style.display = 'none';
  } else {
    // Close other panels
    closeChatHistory();
    document.getElementById('sidebar').classList.remove('open');
    
    panel.classList.add('open');
    panel.style.width = '350px';
    content.style.display = 'block';
  }
}

function closeGallery() {
  const panel = document.getElementById('galleryPanel');
  const content = document.getElementById('galleryContent');
  panel.classList.remove('open');
  panel.style.width = '0';
  content.style.display = 'none';
}

function showImageInfo(title, description) {
  // Map title to symptom ID
  const symptomMap = {
    'Headache': 'headache',
    'Dizziness': 'dizziness',
    'Numbness': 'numbness',
    'Seizure': 'seizure',
    'Memory Loss': 'memory-loss',
    'Persistent Cough': 'cough',
    'Shortness of Breath': 'shortness-breath',
    'Chest Pain': 'chest-pain',
    'Back Pain': 'back-pain',
    'Joint Pain': 'joint-pain',
    'Nausea': 'nausea',
    'Abdominal Pain': 'abdominal-pain'
  };
  
  const symptomId = symptomMap[title];
  
  if (symptomId && symptomDatabase[symptomId]) {
    // Show enhanced modal
    showSymptomDetails(symptomId);
  } else {
    // Fallback to simple alert if symptom not in database
    alert(`‚ùó ${title}\n\n${description}`);
  }
}


function showUploadMessage() {
  alert('‚ùó Upload Feature\n\nImage upload functionality will be available in the next update. For now, please describe your symptoms in the chat.');
}

// ============================================
// 2. DOCTOR PORTAL FUNCTION
// ============================================
function openDoctorDashboard() {
  const doctorData = localStorage.getItem('currentDoctor');
  
  if (!doctorData) {
    // Not logged in - show login modal
    showDoctorLogin();
    return;
  }
  
  // Logged in - show dashboard
  try {
    const doctor = JSON.parse(doctorData);
    
    // Populate dashboard
    document.getElementById('dashboardName').textContent = doctor.name;
    document.getElementById('dashboardSpecialty').textContent = doctor.specialty;
    document.getElementById('dashboardEmail').textContent = doctor.email;
    document.getElementById('doctorStatusSelect').value = doctor.status || 'available';
    
    // Show dashboard modal
    document.getElementById('doctorDashboard').style.display = 'flex';
    
  } catch (error) {
    console.error('Error opening dashboard:', error);
    alert('‚ùó Error loading dashboard. Please login again.');
    localStorage.removeItem('currentDoctor');
    showDoctorLogin();
  }
}

// ============================================
// DOCTOR CONNECTION CONFIRMATION MODAL (FIXED)
// ============================================
function showDoctorConnectionModal(doctor) {
  // Remove existing modal if any
  const existing = document.getElementById('doctorConnectionModal');
  if (existing) existing.remove();
  
  // Create modal container
  const modalDiv = document.createElement('div');
  modalDiv.id = 'doctorConnectionModal';
  modalDiv.className = 'modal-overlay';
  modalDiv.style.display = 'flex';
  
  // Set innerHTML
  modalDiv.innerHTML = `
    <div class="modal-content" style="max-width: 450px;">
      <button class="modal-close" id="closeConnModalBtn">‚ùå</button>
      
      <div style="text-align: center; padding: 20px 0;">
        <div style="font-size: 4rem; margin-bottom: 15px;">üë®‚Äç‚öïÔ∏è</div>
        <h2 style="color: #2563eb; margin: 0 0 10px 0;">Connect to Doctor?</h2>
      </div>
      
      <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <div style="margin-bottom: 15px;">
          <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">Doctor Name</p>
          <p style="font-size: 1.1rem; font-weight: bold; color: #333; margin: 0;">${doctor.name || 'Unknown'}</p>
        </div>
        
        <div style="margin-bottom: 15px;">
          <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">Specialty</p>
          <p style="font-size: 1rem; color: #333; margin: 0;">${doctor.specialty || 'General'}</p>
        </div>
        
        <div style="margin-bottom: 15px;">
          <p style="font-size: 0.85rem; color: #666; margin: 0 0 8px 0;">Current Status</p>
          ${getDoctorStatusBanner(doctor.status)}
        </div>
        
        <div>
          <p style="font-size: 0.85rem; color: #666; margin: 0 0 5px 0;">‚ùó Estimated Wait Time</p>
          <p style="font-size: 1rem; font-weight: 600; color: #2563eb; margin: 0;">
            ${getEstimatedWaitTime(doctor.status)}
          </p>
        </div>
      </div>
      
      ${getDoctorWarningMessage(doctor.status)}
      
      <div style="display: flex; gap: 10px;">
        <button id="cancelConnBtn" 
                style="flex: 1; padding: 14px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;">
          Cancel
        </button>
        <button id="confirmConnBtn" 
                style="flex: 1; padding: 14px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;">
          ‚ùå Connect Now
        </button>
      </div>
    </div>
  `;
  
  // Add to page
  document.body.appendChild(modalDiv);
  
  // ‚úÖ ATTACH EVENT LISTENERS (NOT INLINE ONCLICK)
  document.getElementById('closeConnModalBtn').onclick = closeDoctorConnectionModal;
  document.getElementById('cancelConnBtn').onclick = closeDoctorConnectionModal;
  document.getElementById('confirmConnBtn').onclick = function() {
    confirmDoctorConnection(doctor.id, doctor.name, doctor.specialty);
  };
}

function closeDoctorConnectionModal() {
  const modal = document.getElementById('doctorConnectionModal');
  if (modal) modal.remove();
}



// ============================================
// HELPER FUNCTIONS FOR STATUS DISPLAY
// ============================================
function getDoctorStatusBanner(status) {
  if (status === 'available') {
    return `
      <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #10b981;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #10b981; border-radius: 50%; 
                    box-shadow: 0 0 10px #10b981;"></div>
        <span style="font-weight: bold; color: #065f46; font-size: 1rem;"> Available Now</span>
      </div>
    `;
  } else if (status === 'engaged') {
    return `
      <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #ef4444;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #ef4444; border-radius: 50%; 
                    box-shadow: 0 0 10px #ef4444;"></div>
        <span style="font-weight: bold; color: #991b1b; font-size: 1rem;"> Currently Engaged</span>
      </div>
    `;
  } else {
    return `
      <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
                  padding: 12px; border-radius: 8px; border: 2px solid #9ca3af;
                  display: flex; align-items: center; gap: 10px;">
        <div style="width: 14px; height: 14px; background: #9ca3af; border-radius: 50%;"></div>
        <span style="font-weight: bold; color: #4b5563; font-size: 1rem;">Offline</span>
      </div>
    `;
  }
}

function getEstimatedWaitTime(status) {
  if (status === 'available') {
    return 'Immediate Response';
  } else if (status === 'engaged') {
    return '10-15 minutes';
  } else {
    return 'May take several hours';
  }
}

function getDoctorWarningMessage(status) {
  if (status === 'available') {
    return `
      <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #2563eb; margin-bottom: 20px;">
        <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
          ‚ùó<strong>Ready to connect!</strong> This doctor is available and can respond immediately.
        </p>
      </div>
    `;
  } else if (status === 'engaged') {
    return `
      <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
        <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
          üî¥ <strong>Doctor is busy</strong> with another patient. Your request will be queued.
        </p>
      </div>
    `;
  } else {
    return `
      <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 20px;">
        <p style="margin: 0; color: #991b1b; font-size: 0.9rem;">
          ‚ùó <strong>Doctor is offline.</strong> Response may be delayed.
        </p>
      </div>
    `;
  }
}

// ============================================
// GET AVAILABLE CAMERAS
// ============================================
async function getAvailableCameras() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    availableCameras = devices.filter(device => device.kind === 'videoinput');
    console.log('üìπ Available cameras:', availableCameras.length);
    return availableCameras;
  } catch (error) {
    console.error('‚ùå Error getting cameras:', error);
    return [];
  }
}

// ============================================
// SWITCH CAMERA (FRONT/BACK)
// ============================================
async function switchCamera() {
  if (!localStream) {
    alert('‚ö†Ô∏è No active video stream');
    return;
  }
  
  try {
    console.log('üîÑ Switching camera...');
    
    // Get available cameras
    const cameras = await getAvailableCameras();
    
    if (cameras.length < 2) {
      alert('‚ö†Ô∏è Only one camera detected on this device');
      return;
    }
    
    // Toggle between front and back
    currentCamera = currentCamera === 'user' ? 'environment' : 'user';
    
    // Stop current video track
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.stop();
    }
    
    // Get new video stream with switched camera
    const newStream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: { facingMode: currentCamera }
    });
    
    // Replace video track in local stream
    const newVideoTrack = newStream.getVideoTracks()[0];
    localStream.removeTrack(videoTrack);
    localStream.addTrack(newVideoTrack);
    
    // Update local video preview
    const localVideo = document.getElementById('localVideo');
    if (localVideo) {
      localVideo.srcObject = localStream;
    }
    
    // Replace video track in the peer connection (if in call)
    if (currentCall && currentCall.peerConnection) {
      const sender = currentCall.peerConnection
        .getSenders()
        .find(s => s.track && s.track.kind === 'video');
      
      if (sender) {
        await sender.replaceTrack(newVideoTrack);
        console.log('‚úÖ Camera switched successfully');
      }
    }
    
  } catch (error) {
    console.error('‚ùå Error switching camera:', error);
    alert('‚ùå Failed to switch camera: ' + error.message);
  }
}





// ============================================
// 5. SEND CONSULTATION REQUEST
// ============================================
async function sendConsultationRequest(doctor) {
  try {
    const patientName = prompt(' Please enter your name:', '') || 'Anonymous Patient';
    
    if (!window.firebaseDB) {
      alert('‚ùó Firebase not initialized. Please refresh the page.');
      return;
    }
    
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    
    // Create consultation request
    const requestData = {
      patientName: patientName,
      doctorId: doctor.id || 'unknown',
      doctorName: doctor.name,
      doctorSpecialty: doctor.specialty,
      urgency: 'normal',
      status: 'pending',
      timestamp: serverTimestamp(),
      message: `Patient ${patientName} wants to consult with you.`
    };
    
    await addDoc(collection(window.firebaseDB, 'patientRequests'), requestData);
    
    alert(`‚úÖ Request Sent!\n\nYour consultation request has been sent to ${doctor.name}.\n\nPlease wait for the doctor to accept your request.`);
    
    console.log('‚úÖ Consultation request sent:', requestData);
    
  } catch (error) {
    console.error('Error sending request:', error);
    alert('‚ùó Failed to send request. Please try again.');
  }
}

// ========== STEP 1: DEFINE displayDoctors() FIRST ==========

// Display Doctors (Patient Mode)
function displayDoctors(doctors) {
  console.log('√∞≈∏‚Äì¬º√Ø¬∏¬è Displaying doctors:', doctors);
  
  const doctorList = document.getElementById('doctorList');
  
  if (!doctorList) {
    console.error('‚ùó doctorList element not found');
    return;
  }
  
  if (!doctors || doctors.length === 0) {
    doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‚ùó¬≠ No doctors available</p>';
    return;
  }
  
  // Clear existing content
  doctorList.innerHTML = '';
  
  // Create doctor cards
  doctors.forEach(doctor => {
    const statusClass = doctor.status === 'available' ? 'status-available' :
                       doctor.status === 'engaged' ? 'status-engaged' : 'status-offline';
    const statusText = doctor.status === 'available' ? '‚úÖ Available' :
                      doctor.status === 'engaged' ? 'üî¥ Busy' : 'üîò Offline';
    
    const card = document.createElement('div');
    card.className = 'doctor-card';
    card.innerHTML = `
      <div class="doctor-info">
        <div class="doctor-name">üë®‚Äç‚öïÔ∏è ${doctor.name || 'Dr. Unknown'}</div>
        <div class="doctor-specialty">${doctor.specialty || 'General Medicine'}</div>
        <div style="font-size: 0.75rem; color: #666; margin-top: 4px">${statusText}</div>
      </div>
      <div class="${statusClass} status-indicator"></div>
    `;
    
    // Add click handler
    card.addEventListener('click', () => {
      console.log('üü¢ Doctor selected:', doctor);
      showDoctorConnectionModal(doctor);
    });
    
    doctorList.appendChild(card);
  });
  
  console.log(`‚úÖ Displayed ${doctors.length} doctor card(s)`);
}

// ============================================
// 6. LOAD REAL DOCTORS FUNCTION
// ============================================
// ========== LOAD REAL DOCTORS (PATIENT MODE) ==========

// Display Doctors (Patient Mode) - MUST BE FIRST
function displayDoctors(doctors) {
  console.log('√∞≈∏‚Äì¬º√Ø¬∏¬è Displaying doctors:', doctors);
  
  const doctorList = document.getElementById('doctorList');
  
  if (!doctorList) {
    console.error('‚ùó doctorList element not found');
    return;
  }
  
  if (!doctors || doctors.length === 0) {
    doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‚ùó¬≠ No doctors available</p>';
    return;
  }
  
  // Clear existing content
  doctorList.innerHTML = '';
  
  // Create doctor cards
  doctors.forEach(doctor => {
    const statusClass = doctor.status === 'available' ? 'status-available' :
                       doctor.status === 'engaged' ? 'status-engaged' : 'status-offline';
    const statusText = doctor.status === 'available' ? '‚úÖ Available' :
                      doctor.status === 'engaged' ? 'üî¥ Busy' : 'üîò Offline';
    
    const card = document.createElement('div');
    card.className = 'doctor-card';
    card.innerHTML = `
      <div class="doctor-info">
        <div class="doctor-name">üë®‚Äç‚öïÔ∏è ${doctor.name || 'Dr. Unknown'}</div>
        <div class="doctor-specialty">${doctor.specialty || 'General Medicine'}</div>
        <div style="font-size: 0.75rem; color: #666; margin-top: 4px">${statusText}</div>
      </div>
      <div class="${statusClass} status-indicator"></div>
    `;
    
    // Add click handler
    card.addEventListener('click', () => {
      console.log('üü¢ Doctor selected:', doctor);
      showDoctorConnectionModal(doctor);
    });
    
    doctorList.appendChild(card);
  });
  
  console.log(`‚úÖ Displayed ${doctors.length} doctor card(s)`);
}


// Load Real Doctors (Patient Mode)
async function loadRealDoctors() {
  console.log('√∞≈∏¬è¬• Loading real doctors from Firebase...');
  
  // Prevent multiple loads
  if (window.isLoadingDoctors) {
    console.log('√¢¬è¬≥ Already loading doctors, skipping...');
    return;
  }
  
  window.isLoadingDoctors = true;
  
  const doctorList = document.getElementById('doctorList');
  
  if (!doctorList) {
    console.error('‚ùó doctorList element not found');
    window.isLoadingDoctors = false;
    return;
  }
  
  doctorList.innerHTML = '<p class="loading-doctors">√¢¬è¬≥ Loading doctors...</p>';
  
  try {
    if (!window.firebaseDB) {
      doctorList.innerHTML = '<p class="loading-doctors">‚ùó Firebase not initialized</p>';
      window.isLoadingDoctors = false;
      return;
    }
    
    const { collection, getDocs } = window.firestoreFunctions;
    const doctorsRef = collection(window.firebaseDB, 'doctors');
    const querySnapshot = await getDocs(doctorsRef);
    
    if (querySnapshot.empty) {
      doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‚ùó¬≠ No doctors registered yet.</p>';
      window.isLoadingDoctors = false;
      return;
    }
    
    // ‚úÖ CORRECT WAY to build array
    const doctors = [];
    querySnapshot.forEach((doc) => {
      doctors.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`‚úÖ Loaded ${doctors.length} doctor(s) from Firebase`);
    
    // ‚úÖ Call displayDoctors
    displayDoctors(doctors);
    
  } catch (error) {
    console.error('‚ùó Error loading doctors:', error);
    if (doctorList) {
      doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùó Error loading doctors</p>';
    }
  } finally {
    window.isLoadingDoctors = false;
  }
}


// ========== DOCTOR PASSWORD RESET ==========

// Show password reset modal
function showPasswordReset() {
  document.getElementById('doctorLoginModal').style.display = 'none';
  document.getElementById('passwordResetModal').style.display = 'flex';
  document.getElementById('resetStep1').style.display = 'block';
}

// Close password reset modal
function closePasswordReset() {
  document.getElementById('passwordResetModal').style.display = 'none';
  document.getElementById('resetEmail').value = '';
}

// ‚úÖ SEND PASSWORD RESET EMAIL (FIREBASE AUTH)
async function requestResetCode() {
  const email = document.getElementById('resetEmail').value.trim();
  
  if (!email) {
    alert('‚ùó Please enter your email address.');
    return;
  }
  
  try {
    // ‚úÖ Use Firebase Auth to send password reset email
    const { sendPasswordResetEmail } = window.authFunctions;
    await sendPasswordResetEmail(window.firebaseAuth, email);
    
    alert('‚úÖ Password Reset Email Sent!\n\nPlease check your email inbox and click the reset link.\n\nAfter resetting your password, return here to login with your new password.');
    
    console.log('‚úÖ Password reset email sent to:', email);
    
    // Close modal and show login
    closePasswordReset();
    showDoctorLogin();
    
  } catch (error) {
    console.error('‚ùó Password reset error:', error);
    
    if (error.code === 'auth/user-not-found') {
      alert('‚ùó No doctor account found with this email.\n\nPlease check your email or register a new account.');
    } else if (error.code === 'auth/invalid-email') {
      alert('‚ùó Invalid email address format.');
    } else if (error.code === 'auth/too-many-requests') {
      alert('‚ùó Too many reset attempts. Please wait a few minutes and try again.');
    } else {
      alert('‚ùó Failed to send reset email: ' + error.message);
    }
  }
}





</script>


<!-- Doctor Dashboard Modal -->
<div id="doctorDashboard" class="modal-overlay" style="display: none;">
  <div class="modal-content doctor-dashboard">
    <button class="modal-close" onclick="closeDoctorDashboard()">‚ùå</button>
    <h2>üë®‚Äç‚öïÔ∏èDoctor Dashboard</h2>
    
    <div class="doctor-profile">
      <div class="profile-header">
        <div class="profile-avatar">üë®‚Äç‚öïÔ∏è</div>
        <div class="profile-info">
          <h3 id="dashboardName">Loading...</h3>
          <p id="dashboardSpecialty">Loading...</p>
          <p id="dashboardEmail">Loading...</p>
        </div>
      </div>
      
      <div class="status-selector">
        <label>Your Status:</label>
        <select id="doctorStatusSelect" onchange="updateDoctorStatus()">
          <option value="available">üü¢Available</option>
          <option value="engaged">üî¥ Engaged</option>
          <option value="offline">üîò Offline</option>
        </select>
      </div>
      
      <div class="dashboard-actions">
        <button class="btn-logout" onclick="logoutDoctor()">üö™ Logout</button>
      </div>
    </div>
  </div>
</div>


  <div class="container">

   <aside class="leftbar" id="sidebar">
<!-- INSIDE <div class="leftbar"> -->

<ul class="menu" style="display: flex; flex-direction: column; height: 100%;">
  
  <!-- TOP ITEMS -->
  <li onclick="toggleChatHistory()">üïí Search History</li>
  <li onclick="toggleGallery()">üñºÔ∏è Symptoms Gallery</li>
  
  <!-- SPACER (This pushes everything below it to the bottom) -->
  <div style="flex-grow: 1;"></div>
  
  <!-- SETTINGS GROUP (Now at the bottom!) -->
  <li onclick="toggleSettingsMenu()" style="background: #eef2ff; font-weight: bold; margin-top: auto;">
    ‚öôÔ∏è Settings ‚ñº
  </li>
  
  <!-- HIDDEN SETTINGS SUB-MENU -->
  <div id="settingsSubMenu" style="display: none; padding-left: 10px; padding-bottom: 20px;">
    
    <!-- 1. ABOUT -->
    <li onclick="showAboutModal()" style="font-size: 0.9rem;">‚ÑπÔ∏è About</li>
    
    <!-- 2. MY PROFILE -->
    <li id="myProfileBtn" onclick="openUserProfile()" style="display: none; font-size: 0.9rem; color: #2563eb; font-weight: bold;">
      üë§ My Profile
    </li>
    
    <!-- 3. LOGIN / LOGOUT -->
    <li id="authBtn" onclick="handleAuthClick()" style="font-size: 0.9rem;">
      üîê Login
    </li>
    
  </div>
</ul>

    </aside>

   <!-- CHAT HISTORY PANEL -->
<aside id="chatHistoryPanel">
  <div class="history-header">
    üìú Chat History
    <button onclick="closeChatHistory()" style="float: right; background: none; border: none; color: #2563eb; font-size: 1.5rem; cursor: pointer; padding: 0; margin-left: 10px;">‚úñÔ∏è</button>
  </div>
  <div id="historyList"></div>
  <button class="clear-history-btn" onclick="clearChatHistory()">üóëÔ∏è Clear History</button>
</aside>

<!-- BRAIN HEALTH GALLERY PANEL -->
<aside id="galleryPanel" style="width: 0; background: white; border-right: 8px solid #e5e7eb; overflow-y: auto; transition: width 0.3s ease; display: flex; flex-direction: column; padding: 0;">
  <div id="galleryContent" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 2px solid #e5e7eb;">
      <h3 style="margin: 0; color: #2563eb; font-size: 1.1rem;">ü©∫ Brain Health Gallery</h3>
      <button onclick="closeGallery()" style="background: none; border: none; color: #2563eb; font-size: 1.8rem; cursor: pointer; padding: 0;">‚ùå</button>
    </div>
    
    <div style="padding: 15px;">
      <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Visual guide to neurological symptoms and conditions</p>
      
      <!-- Upload Button (Fake) -->
      <button onclick="showUploadMessage()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 20px; cursor: pointer; transition: 0.3s;">
       ‚¨ÜÔ∏è Upload Your Image
      </button>
      
      <!-- Gallery Grid -->
      <div id="galleryGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        
        <!-- Image 1: Brain Anatomy -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('Brain Anatomy', 'Understanding the structure of the human brain and its key regions.')">
          <img src="https://images.unsplash.com/photo-1559757175-0eb30cd8c063?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="Brain Anatomy">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">Brain Anatomy</p>
        </div>
        
        <!-- Image 2: MRI Scan -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('MRI Brain Scan', 'Medical imaging used to detect neurological conditions.')">
          <img src="https://images.unsplash.com/photo-1530497610245-94d3c16cda28?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="MRI Scan">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">MRI Brain Scan</p>
        </div>
        
        <!-- Image 3: Migraine Symptoms -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('Migraine Symptoms', 'Visual representation of common migraine patterns and triggers.')">
          <img src="https://images.unsplash.com/photo-1578496781379-7dcfb995293d?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="Migraine">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">Migraine Symptoms</p>
        </div>
        
        <!-- Image 4: Stroke Warning Signs -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('Stroke Warning', 'Recognizing early signs of stroke - FAST method.')">
          <img src="https://images.unsplash.com/photo-1576091160550-2173dba999ef?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="Stroke">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">Stroke Warning</p>
        </div>
        
        <!-- Image 5: Alzheimer's Brain -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('Alzheimer Disease', 'Brain changes associated with Alzheimer disease.')">
          <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="Alzheimer">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">Alzheimer's Disease</p>
        </div>
        
        <!-- Image 6: Seizure Patterns -->
        <div class="gallery-item" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s;" onclick="showImageInfo('Seizure Types', 'Understanding different types of seizure patterns.')">
          <img src="https://images.unsplash.com/photo-1582719471384-894fbb16e074?w=400&h=300&fit=crop" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" alt="Seizure">
          <p style="margin: 0; font-size: 0.85rem; font-weight: 600; color: #333;">Seizure Patterns</p>
        </div>
        
      </div>
    </div>
  </div>
</aside>

<style>
  #galleryPanel.open {
    width: 350px !important;
    padding: 0 !important;
  }
  
  #galleryPanel.open #galleryContent {
    display: block !important;
  }
  
  .gallery-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #2563eb !important;
  }
</style>



    <main class="chat-section">
      <div class="top-typing-box" id="topTypingBox">
        <div class="typing-title">‚úçÔ∏è You're typing...</div>
        <div id="topTypingContent"></div>
      </div>

      <div class="chat-window" id="chatWindow">
        <div class="bot-msg"> üëã Hello dear! Type your health question below and I'll help you find answers.</div>
      </div>

      <div class="suggestions-box" id="suggestionsBox">
        <div class="suggestions-title">üí°Related Questions (click to select):</div>
        <div id="suggestionsList"></div>
      </div>

      <div class="search-bar">
  <input type="text" id="userInput" placeholder="Type your health question here..." />
  <button class="btn send" onclick="sendMessage()">‚¨ÜÔ∏è</button>
  
  <!-- These buttons will be hidden/shown based on mode -->
  <button class="btn" id="patientActionBtn" style="display: flex;">
    <span class="mic">üé§</span>
    <span class="upload">üìÇ</span>
  </button>
  
  <button class="btn" id="doctorVideoBtn" onclick="startVideoCall(activePatientId)" style="display: none; background: #10b981;">
    üìπ
  </button>
  <button class="btn" id="doctorVoiceBtn" onclick="startVoiceCall(activePatientId)" style="display: none; background: #3b82f6;">
    üìû
  </button>
</div>

    </main>

    <aside class="rightbar">
      <button class="emergency" onclick="triggerEmergency()">üö® Emergency</button>
      
      <button class="connect-doctor" onclick="togglePatientList()" id="connectDoctorBtn" style="position: relative;">
  <span id="patientBtnText">üë§ Patient List</span>
  <span id="patientCountBadge" class="patient-count-badge" style="display: none;">0</span>
</button>

      
      <div id="doctorListContainer">
        <div id="doctorList">
          <p class="loading-doctors">Loading doctors...</p>
        </div>
      </div>

      <!-- HOSPITAL LOCATION SECTION -->
      <div class="hospital-section">
        <h2 class="location-title" id="hospitalSectionTitle">üè• Setup Nearest Hospital</h2>
        
        <div class="location-form" id="locationForm">
          <p style="font-size: 0.85rem; color: #666; margin-bottom: 15px;">
            ‚ùó Required for Emergency Button
          </p>
          
          <select id="stateInput" class="location-input" onchange="loadDistricts()">
            <option value="">Select State</option>
            <option value="Delhi">Delhi</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="West Bengal">West Bengal</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Assam">Assam</option>
          </select>
          
          <select id="districtInput" class="location-input" disabled onchange="loadAreas()">
            <option value="">Select District</option>
          </select>
          
          <select id="areaInput" class="location-input" disabled>
            <option value="">Select Area</option>
          </select>
          
          <button class="save-location-btn" onclick="saveUserLocation()">
           üíæ Save Location
          </button>
        </div>
        
        <div id="savedLocationDisplay" style="display: none;"></div>
      </div>
    </aside>

  </div>

 <div id="aboutModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); overflow-y: auto;">
  <div style="background-color: white; margin: 3% auto 3% auto; padding: 0; border-radius: 20px; width: 85%; max-width: 900px; box-shadow: 0 10px 50px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto;">
    
    <!-- Header Section -->
    <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 30px; border-radius: 20px 20px 0 0; position: relative;">
      <span onclick="closeAbout()" style="position: absolute; right: 20px; top: 20px; font-size: 32px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s;" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0deg)'">‚ùå</span>
      <h1 style="color: white; margin: 0; font-size: 2rem; text-align: center;">üîó NEUROBUDDYY.AI Platform Guide</h1>
      <p style="color: #e0f2fe; text-align: center; margin: 10px 0 0 0; font-size: 1.1rem;">Your Complete AI-Powered Brain Health Assistant</p>
    </div>
    
    <!-- Content Body -->
    <div style="padding: 40px;">
      
      <!-- What is NEUROBUDDYY.AI -->
      <section style="margin-bottom: 35px;">
        <h2 style="color: #2563eb; margin-bottom: 15px; font-size: 1.5rem; border-bottom: 3px solid #e0f2fe; padding-bottom: 10px;">1Ô∏è‚É£  What is NEUROBUDDYY.AI?</h2>
        <p style="font-size: 1rem; line-height: 1.8; color: #374151; text-align: justify;">
          NEUROBUDDYY.AI is an intelligent, AI-powered healthcare platform designed to provide instant, reliable information about neurological conditions, brain health, and general medical inquiries. Our mission is to make professional health guidance accessible to everyone, anytime, anywhere.
        </p>
      </section>
      
      <!-- Two Modes Section -->
      <section style="margin-bottom: 35px;">
        <h2 style="color: #2563eb; margin-bottom: 20px; font-size: 1.5rem; border-bottom: 3px solid #e0f2fe; padding-bottom: 10px;">2Ô∏è‚É£ Two Modes of Operation</h2>
        
        <!-- Patient Mode -->
        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #10b981;">
          <h3 style="color: #065f46; margin: 0 0 10px 0; font-size: 1.2rem;">üë§ Patient Mode (Default)</h3>
          <p style="color: #064e3b; margin: 8px 0; font-size: 0.95rem;"><strong>For:</strong> General users seeking medical information</p>
          <p style="color: #064e3b; margin: 8px 0; font-size: 0.95rem;"><strong>Features:</strong></p>
          <ul style="color: #064e3b; margin: 10px 0; padding-left: 20px;">
            <li style="margin: 5px 0;">AI-powered chatbot for instant health queries</li>
            <li style="margin: 5px 0;">Smart suggestion system for accurate questions</li>
            <li style="margin: 5px 0;">Chat history with cross-device sync</li>
            <li style="margin: 5px 0;">Brain Health Symptoms Gallery</li>
            <li style="margin: 5px 0;">Connect to verified doctors via voice/video call</li>
            <li style="margin: 5px 0;">Emergency SOS to nearest neuro-hospital</li>
            <li style="margin: 5px 0;">Location-based hospital finder</li>
          </ul>
        </div>
        
        <!-- Doctor Mode -->
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #2563eb;">
          <h3 style="color: #1e40af; margin: 0 0 10px 0; font-size: 1.2rem;">üë®‚Äç‚öïÔ∏è Doctor Mode (Professional)</h3>
          <p style="color: #1e3a8a; margin: 8px 0; font-size: 0.95rem;"><strong>For:</strong> Registered neurologists and healthcare professionals</p>
          <p style="color: #1e3a8a; margin: 8px 0; font-size: 0.95rem;"><strong>Features:</strong></p>
          <ul style="color: #1e3a8a; margin: 10px 0; padding-left: 20px;">
            <li style="margin: 5px 0;">Professional dashboard with patient management</li>
            <li style="margin: 5px 0;">Real-time status control (Available/Engaged/Offline)</li>
            <li style="margin: 5px 0;">Receive patient consultation requests</li>
            <li style="margin: 5px 0;">Voice/Video call interface</li>
            <li style="margin: 5px 0;">Emergency alert notifications</li>
            <li style="margin: 5px 0;">Secure Firebase authentication</li>
          </ul>
        </div>
        
        <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #f59e0b;">
          <p style="margin: 0; color: #92400e; font-size: 0.95rem;"><strong>‚ÄºÔ∏è Mode Selection:</strong> Upon first visit, you'll see a registration interface asking "Are you a healthcare professional?" Choose your mode accordingly. Doctors must register with valid credentials.</p>
        </div>
      </section>
      
      <!-- How to Use Section -->
      <section style="margin-bottom: 35px;">
        <h2 style="color: #2563eb; margin-bottom: 20px; font-size: 1.5rem; border-bottom: 3px solid #e0f2fe; padding-bottom: 10px;">3Ô∏è‚É£ How to Use the Platform</h2>
        
        <div style="background: #f9fafb; padding: 20px; border-radius: 12px; border: 2px solid #e5e7eb;">
          <h3 style="color: #374151; margin-top: 0; font-size: 1.1rem;">For Patients:</h3>
          <ol style="color: #4b5563; line-height: 1.8; padding-left: 20px;">
            <li style="margin: 10px 0;"><strong>Ask Questions:</strong> Type your health query in the chat box. <strong style="color: #dc2626;">IMPORTANT: Always select your question from the suggestion box that appears. Manually typed questions without selection may cause errors.</strong></li>
            <li style="margin: 10px 0;"><strong>View History:</strong> Click " üîéSearch" in the left menu to access your previous conversations.</li>
            <li style="margin: 10px 0;"><strong>Browse Gallery:</strong> Click "ü™¶ Brain Health Gallery" to view visual guides of neurological symptoms.</li>
            <li style="margin: 10px 0;"><strong>Set Location:</strong> Configure your nearest hospital in the right sidebar for emergency alerts.</li>
            <li style="margin: 10px 0;"><strong>Connect to Doctors:</strong> Click "üë®‚Äç‚öïÔ∏è Connect to Doctors" to see available professionals. Click any doctor to initiate consultation.</li>
            <li style="margin: 10px 0;"><strong>Emergency:</strong> Press the red "üö® Emergency" button to send instant SOS to your configured hospital.</li>
          </ol>
          
          <h3 style="color: #374151; margin-top: 25px; font-size: 1.1rem;">For Doctors:</h3>
          <ol style="color: #4b5563; line-height: 1.8; padding-left: 20px;">
            <li style="margin: 10px 0;"><strong>Register:</strong> Use valid medical license number and credentials.</li>
            <li style="margin: 10px 0;"><strong>Login:</strong> Access your dashboard via Settings √¢‚Ä†‚Äô Doctor Portal.</li>
            <li style="margin: 10px 0;"><strong>Update Status:</strong> Set your availability (Available/Engaged/Offline) so patients know when you're ready to consult.</li>
            <li style="margin: 10px 0;"><strong>Receive Consultations:</strong> Patients can see you in the "Connect to Doctors" list and initiate calls.</li>
          </ol>
        </div>
      </section>
      
      <!-- Important Notice -->
      <section style="margin-bottom: 35px;">
        <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #dc2626;">
          <h3 style="color: #991b1b; margin: 0 0 10px 0; font-size: 1.2rem;">‚ò¢Ô∏è Important Disclaimer</h3>
          <p style="color: #7f1d1d; margin: 0; line-height: 1.7; font-size: 0.95rem;">
            NEUROBUDDYY.AI is an informational tool and <strong>NOT a replacement for professional medical advice, diagnosis, or treatment</strong>. Always consult with qualified healthcare providers for medical concerns. In case of emergency, call your local emergency services ‚ùó108 immediately.
          </p>
        </div>
      </section>
      
      <!-- Contact & Support -->
      <section style="margin-bottom: 20px;">
        <h2 style="color: #2563eb; margin-bottom: 20px; font-size: 1.5rem; border-bottom: 3px solid #e0f2fe; padding-bottom: 10px;">4Ô∏è‚É£ Support & Contact</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          
          <!-- Email Support -->
          <div style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">üì™</div>
            <h3 style="color: #5b21b6; margin: 0 0 8px 0; font-size: 1rem;">Email Support</h3>
            <a href="mailto:support@neurobuddyy.ai" style="color: #6d28d9; text-decoration: none; font-weight: bold; font-size: 0.9rem;">neurobuddyyai@gmail.com</a>
          </div>
          
          <!-- Phone Support -->
          <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">‚òéÔ∏è</div>
            <h3 style="color: #065f46; margin: 0 0 8px 0; font-size: 1rem;"> Support</h3>
            <a href="tel:+91 7002588787" style="color: #047857; text-decoration: none; font-weight: bold; font-size: 0.9rem;">+91 9101574957</a>
          </div>
          
          <!-- Developer -->
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center;">
            <div style="font-size: 2.5rem; margin-bottom: 10px;">üñ•Ô∏è</div>
            <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 1rem;">Developer</h3>
            <p style="color: #d31111; margin: 0; font-weight: bold; font-size: 0.9rem;"><strong>ARIYAN ABEDIN</strong> AND <strong>JYOTISHMAN SHIVAM</strong></p>
          </div>
          
        </div>
      </section>
      
      <!-- Footer -->
      <div style="text-align: center; padding-top: 20px; border-top: 2px solid #e5e7eb;">
        <p style="color: #2563eb; font-weight: bold; font-size: 1rem; margin: 10px 0;">¬© 2025 NEUROBUDDYY.AI</p>
        <p style="color: #6b7280; font-size: 0.85rem; margin: 5px 0;">Empowering Health Through Artificial Intelligence</p>
        <p style="color: #9ca3af; font-size: 0.8rem; margin: 5px 0;">Version 1.0 | Built with <strong>RENDER</strong>and <strong>FIREBASE</strong></p>
      </div>
      
    </div>
  </div>
</div>


<script>
  const BACKEND_URL = 'https://neurobuddyy-ai.onrender.com';

  // ========== HOSPITAL LOCATION FEATURE ==========

  const districtData = {
  "Andaman & Nicobar Islands": ["Nicobar","North & Middle Andaman","South Andaman"],
  "Andhra Pradesh": ["Anantapur","Chittoor","East Godavari","Guntur","Kadapa","Krishna","Kurnool","Nellore","Prakasam","Srikakulam","Visakhapatnam","Vizianagaram","West Godavari"],
  "Arunachal Pradesh": ["Anjaw","Changlang","East Kameng","East Siang","Kurung Kumey","Lohit","Lower Dibang Valley","Lower Siang","Lower Subansiri","Namsai","Papum Pare","Shi Yomi","Siang","Tawang","Tirap","Upper Dibang Valley","Upper Siang","Upper Subansiri","West Kameng","West Siang"],
  "Assam": ["Baksa","Barpeta","Biswanath","Bongaigaon","Cachar","Charaideo","Chirang","Darrang","Dhemaji","Dhubri","Dibrugarh","Dima Hasao","Guwahati","Goalpara","Golaghat","Hailakandi","Hojai","Jorhat","Kamrup","Kamrup Metropolitan","Karbi Anglong","Karimganj","Kokrajhar","Lakhimpur","Majuli","Morigaon","Nagaon","Nalbari","Sivasagar","Sonitpur","Tinsukia","Udalguri","West Karbi Anglong"],
  "Bihar": ["Araria","Arwal","Aurangabad","Banka","Begusarai","Bhagalpur","Bhojpur","Buxar","Darbhanga","East Champaran","Gaya","Gopalganj","Jamui","Jehanabad","Kaimur","Katihar","Khagaria","Kishanganj","Lakhisarai","Madhepura","Madhubani","Munger","Muzaffarpur","Nalanda","Nawada","Pashchim Champaran","Patna","Purba Champaran","Purnia","Rohtas","Saharsa","Samastipur","Saran","Sheikhpura","Sheohar","Sitamarhi","Siwan","Supaul","Vaishali","West Champaran"],
  "Chandigarh": ["Chandigarh"],
  "Chhattisgarh": ["Balod","Baloda Bazar","Balrampur","Bastar","Bemetara","Bijapur","Bilaspur","Dakshin Bastar (Dantewada)","Dhamtari","Durg","Gariaband","Janjgir-Champa","Jashpur","Kabirdham","Kanker","Kondagaon","Korba","Koriya","Mahasamund","Mungeli","Narayanpur","Raigarh","Raipur","Rajnandgaon","Sukma","Surajpur","Surguja"],
  "Dadra & Nagar Haveli and Daman & Diu": ["Dadra & Nagar Haveli","Daman","Diu"],
  "Delhi": ["Central Delhi","East Delhi","New Delhi","North Delhi","North East Delhi","North West Delhi","Shahdara","South Delhi","South East Delhi","South West Delhi","West Delhi"],
  "Goa": ["North Goa","South Goa"],
  "Gujarat": ["Ahmedabad","Amreli","Anand","Aravalli","Banaskantha","Bharuch","Bhavnagar","Botad","Chhota Udaipur","Dahod","Dang","Devbhoomi Dwarka","Gandhinagar","Gir Somnath","Jamnagar","Junagadh","Kheda","Kutch","Mahisagar","Mehsana","Morbi","Narmada","Navsari","Panchmahal","Patan","Porbandar","Rajkot","Sabarkantha","Surat","Surendranagar","Tapi","Vadodara","Valsad"],
  "Haryana": ["Ambala","Bhiwani","Charkhi Dadri","Faridabad","Fatehabad","Gurugram","Hisar","Jhajjar","Jind","Kaithal","Kurukshetra","Mahendragarh","Nuh","Palwal","Panchkula","Panipat","Rewari","Rohtak","Sirsa","Sonipat","Yamunanagar"],
  "Himachal Pradesh": ["Bilaspur","Chamba","Hamirpur","Kangra","Kinnaur","Kullu","Lahaul & Spiti","Mandi","Shimla","Sirmaur","Solan","Una"],
  "Jammu & Kashmir": ["Anantnag","Bandipora","Baramulla","Budgam","Doda","Ganderbal","Kulgam","Kupwara","Kishtwar","Poonch","Pulwama","Ramban","Reasi","Samba","Shopian","Srinagar","Udhampur","Rajouri","Kathua"],
  "Jharkhand": ["Bokaro","Chatra","Deoghar","Dhanbad","Dumka","East Singhbhum","Garhwa","Giridih","Godda","Gumla","Hazaribagh","Jamtara","Khunti","Koderma","Latehar","Lohardaga","Pakur","Palamu","Ramgarh","Ranchi","Sahibganj","Seraikela Kharsawan","Simdega","West Singhbhum"],
  "Karnataka": ["Bagalkot","Ballari","Belagavi","Bengaluru Rural","Bengaluru Urban","Bidar","Chamarajanagar","Chikkaballapura","Chikkamagaluru","Chitradurga","Dakshina Kannada","Davanagere","Dharwad","Gadag","Hassan","Haveri","Kalaburagi","Kodagu","Kolar","Mandya","Mysuru","Raichur","Ramanagara","Shivamogga","Tumakuru","Udupi","Uttara Kannada","Vijayapura","Yadgir"],
  "Kerala": ["Alappuzha","Ernakulam","Idukki","Kannur","Kasaragod","Kollam","Kottayam","Kozhikode","Malappuram","Palakkad","Pathanamthitta","Thiruvananthapuram","Thrissur","Wayanad"],
  "Lakshadweep": ["Lakshadweep"],
  "Madhya Pradesh": ["Agar Malwa","Alirajpur","Anuppur","Ashoknagar","Balaghat","Barwani","Betul","Bhind","Bhopal","Burhanpur","Chhatarpur","Chhindwara","Damoh","Datia","Dewas","Dhar","Dindori","Guna","Gwalior","Harda","Hoshangabad","Indore","Jabalpur","Jhabua","Katni","Khandwa","Khargone","Mandla","Mandsaur","Morena","Narsinghpur","Neemuch","Panna","Rajgarh","Ratlam","Rewa","Sagar","Satna","Sehore","Seoni","Shahdol","Shajapur","Sheopur","Shivpuri","Singrauli","Tikamgarh","Ujjain"],
  "Maharashtra": ["Ahmednagar","Akola","Amravati","Aurangabad","Beed","Bhandara","Buldhana","Chandrapur","Dhule","Gadchiroli","Gondia","Hingoli","Jalgaon","Jalna","Kolhapur","Latur","Mumbai City","Mumbai Suburban","Nagpur","Nanded","Nandurbar","Nashik","Osmanabad","Palghar","Parbhani","Pune","Raigad","Ratnagiri","Sangli","Satara","Sindhudurg","Solapur","Thane","Wardha","Washim","Yavatmal"],
  "Manipur": ["Bishnupur","Chandel","Churachandpur","Imphal East","Imphal West","Jiribam","Kakching","Kamjong","Kangpokpi","Noney","Pherzawl","Senapati","Tamenglong","Tengnoupal","Thoubal","Ukhrul"],
  "Meghalaya": ["East Garo Hills","East Jaintia Hills","East Khasi Hills","North Garo Hills","Ri Bhoi","South Garo Hills","South West Garo Hills","West Garo Hills","West Jaintia Hills","West Khasi Hills"],
  "Mizoram": ["Aizawl","Champhai","Hnahthial","Khawzawl","Kolasib","Lawngtlai","Lunglei","Mamit","Siaha","Serchhip"],
  "Nagaland": ["Dimapur","Kiphire","Kohima","Longleng","Mokokchung","Mon","Niuland","Noklak","Peren","Phek","Tuensang","Wokha","Z√É∆í√Ç¬ºnheboto"],
  "Odisha": ["Angul","Balangir","Balasore","Bargarh","Bhadrak","Boudh","Cuttack","Deogarh","Dhenkanal","Gajapati","Ganjam","Jagatsinghpur","Jajpur","Jharsuguda","Kalahandi","Kandhamal","Kendrapara","Kendujhar","Khordha","Koraput","Malkangiri","Mayurbhanj","Nabarangpur","Nayagarh","Nuapada","Puri","Rayagada","Sambalpur","Sonepur","Sundergarh"],
  "Puducherry": ["Karaikal","Mahe","Puducherry","Yanam"],
  "Punjab": ["Amritsar","Barnala","Bathinda","Faridkot","Fatehgarh Sahib","Fazilka","Firozpur","Gurdaspur","Hoshiarpur","Jalandhar","Kapurthala","Ludhiana","Mansa","Moga","Pathankot","Patiala","Rupnagar","Sahibzada Ajit Singh Nagar (Mohali)","Sangrur","Tarn Taran"],
  "Rajasthan": ["Ajmer","Alwar","Banswara","Baran","Barmer","Bharatpur","Bhilwara","Bikaner","Bundi","Chittorgarh","Churu","Dausa","Dholpur","Dungarpur","Hanumangarh","Jaipur","Jaisalmer","Jalore","Jhalawar","Jhunjhunu","Jodhpur","Karauli","Kota","Nagaur","Pali","Pratapgarh","Rajsamand","Sawai Madhopur","Sikar","Sirohi","Sri Ganganagar","Tonk","Udaipur"],
  "Sikkim": ["East Sikkim","North Sikkim","South Sikkim","West Sikkim"],
  "Tamil Nadu": ["Ariyalur","Chengalpattu","Chennai","Coimbatore","Cuddalore","Dharmapuri","Dindigul","Erode","Kallakurichi","Kanchipuram","Kanyakumari","Karur","Krishnagiri","Madurai","Nagapattinam","Namakkal","Nilgiris","Perambalur","Pudukkottai","Ramanathapuram","Ranipet","Salem","Sivaganga","Tenkasi","Thanjavur","Theni","Thoothukudi","Tiruchirappalli","Tirunelveli","Tirupathur","Tiruppur","Tiruvallur","Tiruvannamalai","Tiruvarur","Vellore","Viluppuram","Virudhunagar"],
  "Telangana": ["Adilabad","Bhadradri Kothagudem","Hyderabad","Jagtial","Jangaon","Jayashankar Bhupalpally","Jogulamba Gadwal","Kamareddy","Karimnagar","Khammam","Kumuram Bheem Asifabad","Mahabubabad","Mahabubnagar","Mancherial","Medak","Medchal-Malkajgiri","Mulugu","Nagarkurnool","Nalgonda","Narayanpet","Nizamabad","Peddapalli","Rajanna Sircilla","Ranga Reddy","Sangareddy","Siddipet","Suryapet","Vikarabad","Wanaparthy","Warangal (Urban)","Warangal (Rural)","Yadadri Bhuvanagiri"],
  "Tripura": ["Dhalai","Gomati","Khowai","North Tripura","Sepahijala","South Tripura","Unakoti","West Tripura"],
  "Uttarakhand": ["Almora","Bageshwar","Chamoli","Champawat","Dehradun","Haridwar","Nainital","Pauri Garhwal","Pithoragarh","Rudraprayag","Tehri Garhwal","Udham Singh Nagar","Uttarkashi"],
  "Uttar Pradesh": ["Agra","Aligarh","Ambedkar Nagar","Amethi","Amroha","Auraiya","Ayodhya","Azamgarh","Baghpat","Bahraich","Ballia","Banda","Barabanki","Bareilly","Basti","Bijnor","Bulandshahr","Chandauli","Chitrakoot","Deoria","Etah","Etawah","Farrukhabad","Fatehpur","Firozabad","Gautam Buddha Nagar","Ghaziabad","Ghazipur","Hardoi","Hathras","Jalaun","Jaunpur","Jhansi","Kannauj","Kanpur Dehat","Kanpur Nagar","Kasganj","Kaushambi","Kushinagar","Lalitpur","Lucknow","Maharajganj","Mahoba","Mainpuri","Mathura","Mau","Meerut","Mirzapur","Moradabad","Muzaffarnagar","Pilibhit","Pratapgarh","Rae Bareli","Rampur","Saharanpur","Sambhal","Sant Kabir Nagar","Shahjahanpur","Shamli","Shravasti","Siddharthnagar","Sitapur","Sonbhadra","Sultanpur","Unnao","Varanasi"],
  "West Bengal": ["Alipurduar","Bankura","Birbhum","Cooch Behar","Dakshin Dinajpur","Darjeeling","Hooghly","Howrah","Jalpaiguri","Jhargram","Kalimpong","Kolkata","Malda","Murshidabad","Nadia","North 24 Parganas","Paschim Medinipur","Purba Medinipur","Purulia","South 24 Parganas","Uttar Dinajpur"]
};


  const areaData = {
  // DELHI (All 11 Districts)
  "Central Delhi": ["Connaught Place", "Karol Bagh", "Paharganj", "Rajinder Nagar", "Patel Nagar"],
  "South Delhi": ["Hauz Khas", "Saket", "Greater Kailash", "Lajpat Nagar", "Nehru Place", "Defence Colony"],
  "West Delhi": ["Rajouri Garden", "Janakpuri", "Punjabi Bagh", "Vikaspuri", "Tilak Nagar"],
  "New Delhi": ["Lodhi Road", "Chanakyapuri", "RK Puram", "Khan Market", "Vasant Vihar"],
  "North Delhi": ["Civil Lines", "Kamla Nagar", "Model Town", "Kashmere Gate", "Shakti Nagar"],
  "East Delhi": ["Preet Vihar", "Laxmi Nagar", "Mayur Vihar", "Gandhi Nagar", "Krishna Nagar"],
  "North East Delhi": ["Seelampur", "Shahdara", "Dilshad Garden", "Nand Nagri", "Yamuna Vihar"],
  "North West Delhi": ["Rohini", "Pitampura", "Shalimar Bagh", "Model Town", "Saraswati Vihar"],
  "South East Delhi": ["Kalkaji", "Okhla", "Jamia Nagar", "Govindpuri", "Sarita Vihar"],
  "South West Delhi": ["Dwarka", "Vasant Kunj", "Najafgarh", "Uttam Nagar", "Kapashera"],
  "Shahdara": ["Dilshad Garden", "Karkardooma", "Vivek Vihar", "Jhilmil", "Nand Nagri"],

  // MUMBAI
  "Mumbai City": ["Colaba", "Fort", "Marine Drive", "Churchgate", "Nariman Point", "Girgaon"],
  "Mumbai Suburban": ["Andheri", "Bandra", "Borivali", "Dadar", "Kurla", "Mulund", "Goregaon"],

  // BANGALORE
  "Bengaluru Urban": ["Koramangala", "Whitefield", "Indiranagar", "Jayanagar", "Electronic City", "BTM Layout"],
  "Bengaluru Rural": ["Nelamangala", "Doddaballapura", "Devanahalli", "Hosakote"],

  // CHENNAI
  "Chennai": ["T Nagar", "Anna Nagar", "Velachery", "Adyar", "Mylapore", "Egmore", "Nungambakkam"],

  // KOLKATA
  "Kolkata": ["Salt Lake", "Park Street", "Ballygunge", "Alipore", "New Town", "Behala", "Tollygunge"],
  "Howrah": ["Shibpur", "Liluah", "Bally", "Santragachi", "Howrah Maidan"],

  // HYDERABAD
  "Hyderabad": ["Banjara Hills", "Jubilee Hills", "HITEC City", "Gachibowli", "Madhapur", "Secunderabad"],

  // PUNE
  "Pune": ["Koregaon Park", "Shivaji Nagar", "Kothrud", "Hinjewadi", "Viman Nagar", "Aundh", "Deccan"],

  // AHMEDABAD
  "Ahmedabad": ["Satellite", "Vastrapur", "CG Road", "Maninagar", "Navrangpura", "Bopal"],

  // JAIPUR
  "Jaipur": ["Malviya Nagar", "C-Scheme", "MI Road", "Vaishali Nagar", "Mansarovar", "Raja Park"],

  // LUCKNOW
  "Lucknow": ["Hazratganj", "Gomti Nagar", "Alambagh", "Aliganj", "Indira Nagar", "Mahanagar"],

  // KANPUR
  "Kanpur Nagar": ["Civil Lines", "Swaroop Nagar", "Kakadeo", "Panki", "GTB Nagar"],

  // NAGPUR
  "Nagpur": ["Sitabuldi", "Dharampeth", "Sadar", "Civil Lines", "Khamla", "Wardha Road"],

  // INDORE
  "Indore": ["Vijay Nagar", "Palasia", "MG Road", "Rau", "Sanwer Road", "AB Road"],

  // BHOPAL
  "Bhopal": ["New Market", "MP Nagar", "Arera Colony", "Kolar", "Berasia Road"],

  // PATNA
  "Patna": ["Boring Road", "Fraser Road", "Kankarbagh", "Rajendra Nagar", "Patliputra", "Gandhi Maidan"],

  // SURAT
  "Surat": ["Adajan", "Vesu", "Piplod", "Athwa", "Katargam", "Rander"],

  // VISAKHAPATNAM
  "Visakhapatnam": ["MVP Colony", "Dwaraka Nagar", "Gajuwaka", "Madhurawada", "Rushikonda"],

  // VADODARA
  "Vadodara": ["Alkapuri", "Sayajigunj", "Fatehgunj", "Manjalpur", "Gotri", "Akota"],

  // CHANDIGARH
  "Chandigarh": ["Sector 17", "Sector 22", "Sector 35", "Elante Mall", "Sukhna Lake"],

  // GUWAHATI
  "Guwahati": ["Fancy Bazar", "Paltan Bazar", "Pan Bazaar", "Ulubari", "Six Mile", "Beltola", "Ganeshguri"],
  "Kamrup Metropolitan": ["Dispur", "Bharalumukh", "Maligaon", "Khanapara", "Basistha"],
  
  // GOALPARA
  "Goalpara": ["Seven Sister Hospital","Goalpara Railway Station","Near Transport","Pragati-Nagar","Bara Bazar","Lakhipur","Dudhnoi","Matia","Rangjuli","Balijana","Agia","Krishnai","Civil Hospital Goalpara","Goalpara Circuit House","DC Office Road","Goalpara College","Mission Chariali","Kachugaon","Jaleswar","Goalpara Stadium","Old Bus Stand","New Market Area","Goalpara Police Station","Block Development Office","Goalpara Post Office","NH-17 Road","Goalpara Medical College Area"],


  // COIMBATORE
  "Coimbatore": ["RS Puram", "Gandhipuram", "Peelamedu", "Saibaba Colony", "Race Course"],

  // KOCHI/ERNAKULAM
  "Ernakulam": ["Marine Drive", "MG Road", "Kadavanthra", "Kaloor", "Edappally", "Kakkanad"],

  // THIRUVANANTHAPURAM
  "Thiruvananthapuram": ["Vellayambalam", "Pattom", "Vazhuthacaud", "Sasthamangalam", "Medical College"],

  // KOZHIKODE
  "Kozhikode": ["SM Street", "Mavoor Road", "West Hill", "Kallai", "Beach Road"],

  // MYSURU
  "Mysuru": ["Chamundipuram", "Saraswathipuram", "Kuvempunagar", "Vijayanagar", "Yadavagiri"],

  // MADURAI
  "Madurai": ["Anna Nagar", "KK Nagar", "Sellur", "Villapuram", "Goripalayam"],

  // AGRA
  "Agra": ["Sadar Bazaar", "Kamla Nagar", "Sikandra", "Dayal Bagh", "Tajganj", "Sanjay Place"],

  // VARANASI
  "Varanasi": ["Godowlia", "Lanka", "Sigra", "Bhelupur", "Maidagin", "Lahurabir"],

  // RANCHI
  "Ranchi": ["Albert Ekka Chowk", "Harmu", "Doranda", "Kanke", "Hinoo", "Lalpur"],

  // JODHPUR
  "Jodhpur": ["Paota", "Sardarpura", "Shastri Nagar", "Ratanada", "Chopasni"],

  // GWALIOR
  "Gwalior": ["Lashkar", "Morar", "City Centre", "Thatipur", "Kampoo"],

  // GURUGRAM
  "Gurugram": ["DLF Phase 1", "Sector 14", "MG Road", "Sohna Road", "Golf Course Road", "Cyber City"],

  // FARIDABAD
  "Faridabad": ["Sector 15", "NIT", "Old Faridabad", "Sector 21", "Ballabhgarh"],

  // AMRITSAR
  "Amritsar": ["Ranjit Avenue", "Mall Road", "Lawrence Road", "Golden Temple", "Majitha Road"],

  // LUDHIANA
  "Ludhiana": ["Sarabha Nagar", "Civil Lines", "Model Town", "Dugri", "Ferozepur Road"],

  // JALANDHAR
  "Jalandhar": ["Model Town", "Civil Lines", "Cantt Area", "Ladowali Road", "Kapurthala Road"],

  // DEHRADUN
  "Dehradun": ["Rajpur Road", "Mussoorie Road", "Sahastradhara Road", "Clock Tower", "Clement Town"],

  // HARIDWAR
  "Haridwar": ["Har Ki Pauri", "BHEL", "Jwalapur", "Ranipur", "Kankhal"],

  // SILIGURI
  "Darjeeling": ["Chowrasta", "Mall Road", "Ghoom", "Lebong", "Happy Valley"],

  // RAIPUR
  "Raipur": ["Shankar Nagar", "Civil Lines", "Devendra Nagar", "Pandri", "Telibandha"],

  // BILASPUR (Chhattisgarh)
  "Bilaspur": ["Vyapar Vihar", "Nehru Nagar", "Link Road", "Torwa", "Seepat Road"],

  // JAMMU
  "Jammu": ["Gandhi Nagar", "Bahu Plaza", "Residency Road", "Raghunath Bazar", "Canal Road"],

  // SRINAGAR
  "Srinagar": ["Lal Chowk", "Dal Lake", "Residency Road", "Rajbagh", "Jawahar Nagar"],

  // GUWAHATI OTHER AREAS
  "Dibrugarh": ["Graham Bazar", "Mancotta Road", "Chowkidingee", "Lahowal"],
  "Jorhat": ["AT Road", "Gar Ali", "Mithapukhuri", "Tarajan"],
  "Tinsukia": ["Rangagora", "Bordumsa", "Makum", "Panitola"],
  "Silchar": ["Tarapur", "Rangirkhari", "Premtala", "Ambicapatty"],

  // WEST BENGAL
  "North 24 Parganas": ["Barasat", "Barrackpore", "Dum Dum", "Madhyamgram", "New Town"],
  "South 24 Parganas": ["Sonarpur", "Baruipur", "Diamond Harbour", "Canning"],

  // TELANGANA
  "Warangal (Urban)": ["Kazipet", "Hanamkonda", "Subedari", "Nakkalagutta"],
  "Karimnagar": ["Mankammathota", "Mukarampura", "Bhagathnagar", "Ramnagar"],

  // ANDHRA PRADESH
  "Guntur": ["Lakshmipuram", "Arundelpet", "Brodipet", "Kothapet"],
  "Vijayawada": ["Benz Circle", "Governorpet", "Patamata", "Auto Nagar"],

  // KERALA
  "Kannur": ["Fort Road", "Thalassery", "Payyambalam", "Thana"],
  "Kollam": ["Chinnakada", "Kilikollur", "Asramam", "Sakthikulangara"],

  // RAJASTHAN
  "Udaipur": ["City Palace", "Lake Pichola", "Fateh Sagar", "Bapu Bazar"],
  "Bikaner": ["Karni Nagar", "Rani Bazar", "Ganganagar Road"],
  "Ajmer": ["Pushkar", "Vaishali Nagar", "Nasirabad", "Beawar"],

  // MADHYA PRADESH
  "Jabalpur": ["Napier Town", "Civil Lines", "Russell Chowk", "Vijay Nagar"],
  "Ujjain": ["Freeganj", "Dewas Gate", "Mahakal Temple", "Dhanvantri Nagar"],

  // UTTAR PRADESH
  "Allahabad": ["Civil Lines", "Georgetown", "Katra", "Lukerganj"],
  "Meerut": ["Shastri Nagar", "Brahmpuri", "Sadar Bazar", "Pallavpuram"],
  "Bareilly": ["Civil Lines", "Pilibhit Road", "CB Ganj", "Subhash Nagar"],

  // BIHAR
  "Gaya": ["Town Hall", "Rampur", "Tikari", "Manpur"],
  "Bhagalpur": ["Nathnagar", "Tilkamanjhi", "Sabour", "Kahalgaon"],
  "Muzaffarpur": ["Juran Chhapra", "Motipur", "Brahampur"],

  // GOA
  "North Goa": ["Panaji", "Mapusa", "Candolim", "Calangute", "Baga", "Anjuna"],
  "South Goa": ["Margao", "Colva", "Benaulim", "Palolem", "Vasco da Gama"],

  // JHARKHAND
  "Dhanbad": ["Bank More", "Hirapur", "Saraidhela", "Jharia"],
  "Jamshedpur": ["Bistupur", "Sakchi", "Mango", "Kadma", "Sonari"],

  // ODISHA
  "Bhubaneswar": ["Kharavel Nagar", "Sahid Nagar", "Patia", "Chandrasekharpur"],
  "Cuttack": ["Buxi Bazar", "Badambadi", "Link Road", "College Square"],
  "Puri": ["Swargadwar", "Grand Road", "Sea Beach", "Balighai"],

  // ASSAM (More Districts)
  "Nagaon": ["Ward No 1", "Haiborgaon", "Bamungaon", "Juria"],
  "Barpeta": ["Barpeta Road", "Pathsala", "Sarthebari", "Baghbar"],
  "Sivasagar": ["AT Road", "Gaurisagar", "Nazira", "Amguri"],
  
  // ADDITIONAL COVERAGE
  "Dharwad": ["Vidyanagar", "Navoday Nagar", "Tolnur", "Hubli"],
  "Belgaum": ["Tilakwadi", "Camp Area", "Shahu Nagar", "Hindalga"],
  "Mangalore": ["Hampankatta", "Bunts Hostel", "Kadri", "Kankanady"],
  "Aurangabad": ["Town Centre", "Cidco", "Garkheda", "MIDC"],
  "Nashik": ["College Road", "Gangapur Road", "Satpur", "Mumbai Nagar"],
  "Kolhapur": ["Shahupuri", "Rajarampuri", "New Shahupuri", "Station Road"],
  "Solapur": ["Sakhar Peth", "Sidheshwar Peth", "Railway Lines", "Hotgi Road"],
  "Salem": ["Fairlands", "Hasthampatty", "Fort", "Ammapet"],
  "Tirupur": ["Kumaran Road", "Big Bazaar", "Gandhi Nagar", "Kangeyam Road"],
  "Trichy": ["Thillai Nagar", "Cantonment", "Srirangam", "K K Nagar"],
  "Tiruvallur": ["Redhills", "Poonamallee", "Avadi", "Ambattur"],
  "Vellore": ["Officer's Line", "Sathuvachari", "Gandhi Nagar", "Thorapadi"],
  "Tirunelveli": ["Palayamkottai", "Vannarpet", "High Ground", "Melapalayam"],
  "Wayanad": ["Kalpetta", "Mananthavady", "Sulthan Bathery", "Meppadi"],
  "Malappuram": ["Mini Bypass", "Down Hill", "Manjeri", "Tirur"],
  "Thrissur": ["Round", "Swaraj Round", "East Fort", "Vadakkumnathan"],
  "Alappuzha": ["Beach Road", "Iron Bridge", "Mullackal", "Thathampally"],
  "Shimla": ["Mall Road", "Lakkar Bazar", "Sanjauli", "Jakhoo"],
  "Dharamshala": ["McLeod Ganj", "Lower Dharamshala", "Kotwali Bazar", "Naddi"],
  "Gangtok": ["MG Marg", "Lal Bazar", "Tadong", "Deorali"],
  "Imphal": ["Paona Bazar", "Thangal Bazar", "Singjamei", "Uripok"],
  "Kohima": ["Aradurah Hill", "PR Hill", "High School", "New Market"],
  "Aizawl": ["Bara Bazar", "Zarkawt", "Dawrpui", "Thuampui"],
  "Shillong": ["Police Bazar", "Laitumkhrah", "Laban", "Mawlai"],
  "Agartala": ["Battala", "Palace Compound", "GB Road", "Abhoynagar"],
  "Port Blair": ["Aberdeen Bazaar", "Haddo", "Phoenix Bay", "Atlanta Point"],

  // CONTINUE FROM WHERE WE LEFT OFF - ADD THESE TO YOUR areaData:

// ========== ASSAM (Missing Districts) ==========
"Baksa": ["Mushalpur", "Tamulpur", "Barama", "Tihu"],
"Chirang": ["Kajalgaon", "Bijni", "Sidli", "Runikhata"],
"Dhemaji": ["Dhemaji Town", "Jonai", "Silapathar", "Sissiborgaon"],
"Dhubri": ["Dhubri Town", "Bilasipara", "Gauripur", "South Salmara"],
"Dima Hasao": ["Haflong", "Maibang", "Mahur", "Umrangso"],
"Hojai": ["Hojai Town", "Lanka", "Lumding", "Doboka"],
"Karimganj": ["Karimganj Town", "Badarpur", "Patharkandi", "Ramkrishna Nagar"],
"Kokrajhar": ["Kokrajhar Town", "Gossaigaon", "Dotma", "Fakirganj"],
"Lakhimpur": ["North Lakhimpur", "Dhakuakhana", "Bihpuria", "Narayanpur"],
"Majuli": ["Garamur", "Kamalabari", "Jengraimukh", "Phuloni"],
"Morigaon": ["Morigaon Town", "Jagiroad", "Laharighat", "Moirabari"],
"Nalbari": ["Nalbari Town", "Tihu", "Mukalmua", "Barbari"],
"Udalguri": ["Udalguri Town", "Bhergaon", "Mazbat", "Kalaigaon"],
"West Karbi Anglong": ["Hamren", "Donka", "Baithalangso", "Lumbajong"],
"Cachar": ["Silchar Town", "Udharbond", "Sonai", "Lakhipur"],
"Charaideo": ["Sonari", "Sapekhati", "Mahmora", "Rajgarh"],
"Darrang": ["Mangaldoi", "Dalgaon", "Kalaigaon", "Sipajhar"],
"Golaghat": ["Golaghat Town", "Bokakhat", "Sarupathar", "Dergaon"],
"Hailakandi": ["Hailakandi Town", "Katlicherra", "Lala", "Algapur"],
"Kamrup": ["Rangia", "Hajo", "Chhaygaon", "Boko"],
"Karbi Anglong": ["Diphu", "Bokajan", "Howraghat", "Donka"],
"Sonitpur": ["Tezpur", "Biswanath Chariali", "Rangapara", "Dhekiajuli"],
"Bongaigaon":["New Bongaigaon","North Bongaigaon","Mulagaon","Mayapuri","Dalaigaon","Jelkajhar"],
// ========== BIHAR (Missing Districts) ==========
"Araria": ["Araria Town", "Forbesganj", "Raniganj", "Jokihat"],
"Arwal": ["Arwal Town", "Kurtha", "Kaler", "Karpi"],
"Aurangabad": ["Aurangabad Town", "Daudnagar", "Goh", "Rafiganj"],
"Banka": ["Banka Town", "Katoria", "Amarpur", "Barahat"],
"Begusarai": ["Begusarai Town", "Barauni", "Khudhabandpur", "Teghra"],
"Bhojpur": ["Ara Town", "Jagdishpur", "Piro", "Shahpur"],
"Buxar": ["Buxar Town", "Dumraon", "Chausa", "Rajpur"],
"Darbhanga": ["Darbhanga Town", "Benipur", "Jale", "Kusheshwar Asthan"],
"East Champaran": ["Motihari", "Dhaka", "Raxaul", "Chakia"],
"Gopalganj": ["Gopalganj Town", "Barauli", "Kateya", "Sidhwalia"],
"Jamui": ["Jamui Town", "Jhajha", "Sono", "Barhat"],
"Jehanabad": ["Jehanabad Town", "Makhdumpur", "Kako", "Ghoshi"],
"Kaimur": ["Bhabua", "Mohania", "Adhaura", "Bhagwanpur"],
"Katihar": ["Katihar Town", "Manihari", "Barari", "Kadwa"],
"Khagaria": ["Khagaria Town", "Parbatta", "Beldaur", "Mansi"],
"Kishanganj": ["Kishanganj Town", "Bahadurganj", "Dighalbank", "Thakurganj"],
"Lakhisarai": ["Lakhisarai Town", "Halsi", "Surajgarha", "Ramgarh Chowk"],
"Madhepura": ["Madhepura Town", "Udakishanganj", "Murliganj", "Singheshwar"],
"Madhubani": ["Madhubani Town", "Jhanjharpur", "Benipatti", "Jainagar"],
"Munger": ["Munger Town", "Jamalpur", "Kharagpur", "Tarapur"],
"Nalanda": ["Bihar Sharif", "Rajgir", "Hilsa", "Islampur"],
"Nawada": ["Nawada Town", "Warsaliganj", "Rajauli", "Hisua"],
"Pashchim Champaran": ["Bettiah", "Bagaha", "Ramnagar", "Sikta"],
"Purba Champaran": ["Motihari", "Dhaka", "Raxaul", "Adapur"],
"Purnia": ["Purnia Town", "Dhamdaha", "Baisi", "Krityanand Nagar"],
"Rohtas": ["Sasaram", "Dehri", "Bikramganj", "Nokha"],
"Saharsa": ["Saharsa Town", "Sonbarsa", "Simri Bakhtiarpur", "Mahishi"],
"Samastipur": ["Samastipur Town", "Dalsinghsarai", "Rosera", "Patori"],
"Saran": ["Chapra", "Marhaura", "Sonepur", "Amnour"],
"Sheikhpura": ["Sheikhpura Town", "Ariari", "Barbigha", "Chewara"],
"Sheohar": ["Sheohar Town", "Dumri Katsari", "Piprahi", "Tariani Chowk"],
"Sitamarhi": ["Sitamarhi Town", "Dumra", "Pupri", "Parsauni"],
"Siwan": ["Siwan Town", "Maharajganj", "Mairwa", "Hussainganj"],
"Supaul": ["Supaul Town", "Triveniganj", "Nirmali", "Chhatapur"],
"Vaishali": ["Hajipur", "Mahua", "Lalganj", "Raghopur"],
"West Champaran": ["Bettiah", "Bagaha", "Narkatiaganj", "Chanpatia"],

// ========== UTTAR PRADESH (Additional Districts) ==========
"Aligarh": ["Civil Lines", "University Area", "Ramghat Road", "Dodhpur"],
"Ambedkar Nagar": ["Akbarpur", "Tanda", "Jalalpur", "Bhiyaon"],
"Amethi": ["Gauriganj", "Jagdishpur", "Musafirkhana", "Sangrampur"],
"Amroha": ["Amroha City", "Gajraula", "Hasanpur", "Dhanaura"],
"Auraiya": ["Auraiya Town", "Bidhuna", "Achchalda", "Dibiyapur"],
"Ayodhya": ["Ram Janmabhoomi", "Naya Ghat", "Civil Lines", "Goshainganj"],
"Azamgarh": ["Azamgarh Town", "Mubarakpur", "Lalganj", "Nizamabad"],
"Baghpat": ["Baghpat Town", "Baraut", "Pilana", "Khekada"],
"Bahraich": ["Bahraich Town", "Nanpara", "Kaiserganj", "Mahasi"],
"Ballia": ["Ballia Town", "Rasra", "Bansdih", "Bairiya"],
"Banda": ["Banda Town", "Atarra", "Naraini", "Baberu"],
"Barabanki": ["Barabanki Town", "Nawabganj", "Fatehpur", "Haidergarh"],
"Basti": ["Basti Town", "Harraiya", "Rudhauli", "Kaptanganj"],
"Bijnor": ["Bijnor Town", "Najibabad", "Chandpur", "Nagina"],
"Bulandshahr": ["Bulandshahr Town", "Khurja", "Sikandrabad", "Jahangirabad"],
"Chandauli": ["Chandauli Town", "Mughalsarai", "Sakaldiha", "Chakia"],
"Chitrakoot": ["Karvi", "Manikpur", "Mau", "Rajapur"],
"Deoria": ["Deoria Town", "Salempur", "Barhaj", "Pathardeva"],
"Etah": ["Etah Town", "Kasganj", "Jalesar", "Aliganj"],
"Etawah": ["Etawah Town", "Bharthana", "Saifai", "Basrehar"],
"Farrukhabad": ["Farrukhabad Town", "Fatehgarh", "Kamalganj", "Mohammadabad"],
"Fatehpur": ["Fatehpur Town", "Bindki", "Khaga", "Jahanabad"],
"Firozabad": ["Firozabad Town", "Shikohabad", "Tundla", "Jasrana"],
"Gautam Buddha Nagar": ["Noida", "Greater Noida", "Dadri", "Jewar"],
"Ghaziabad": ["Ghaziabad City", "Indirapuram", "Vasundhara", "Modinagar"],
"Ghazipur": ["Ghazipur Town", "Zamania", "Saidpur", "Mohammadabad"],
"Hardoi": ["Hardoi Town", "Shahabad", "Sandila", "Sawayajpur"],
"Hathras": ["Hathras Town", "Sadabad", "Sikandra Rao", "Sasni"],
"Jalaun": ["Orai", "Jalaun Town", "Kalpi", "Konch"],
"Jaunpur": ["Jaunpur Town", "Mariahu", "Shahganj", "Badlapur"],
"Jhansi": ["Jhansi City", "Mauranipur", "Garautha", "Moth"],
"Kannauj": ["Kannauj Town", "Tirwa", "Chhibramau", "Talgram"],
"Kanpur Dehat": ["Akbarpur", "Bhognipur", "Rasulabad", "Derapur"],
"Kasganj": ["Kasganj Town", "Sahawar", "Sidhpura", "Soron"],
"Kaushambi": ["Manjhanpur", "Bharwari", "Sirathu", "Chail"],
"Kushinagar": ["Padrauna", "Kasya", "Tamkuhi Raj", "Khadda"],
"Lalitpur": ["Lalitpur Town", "Mahroni", "Talbehat", "Bar"],
"Maharajganj": ["Maharajganj Town", "Nautanwa", "Pharenda", "Nichlaul"],
"Mahoba": ["Mahoba Town", "Kulpahar", "Charkhari", "Panwari"],
"Mainpuri": ["Mainpuri Town", "Bhongaon", "Ghiror", "Karhal"],
"Mathura": ["Mathura City", "Vrindavan", "Govardhan", "Chhata"],
"Mau": ["Mau Town", "Madhuban", "Mohammadabad", "Ghosi"],
"Mirzapur": ["Mirzapur Town", "Chunar", "Vindhyachal", "Marihan"],
"Moradabad": ["Moradabad City", "Sambhal", "Thakurdwara", "Bilari"],
"Muzaffarnagar": ["Muzaffarnagar Town", "Shamli", "Kairana", "Charthawal"],
"Pilibhit": ["Pilibhit Town", "Puranpur", "Bisalpur", "Barkhera"],
"Pratapgarh": ["Pratapgarh Town", "Kunda", "Lalganj", "Patti"],
"Rae Bareli": ["Rae Bareli Town", "Lalganj", "Salon", "Dalmau"],
"Rampur": ["Rampur Town", "Milak", "Swar", "Shahabad"],
"Saharanpur": ["Saharanpur Town", "Deoband", "Nakur", "Gangoh"],
"Sambhal": ["Sambhal Town", "Chandausi", "Bahjoi", "Gunnaur"],
"Sant Kabir Nagar": ["Khalilabad", "Mehdawal", "Dhanghata", "Haldi"],
"Shahjahanpur": ["Shahjahanpur Town", "Tilhar", "Jalalabad", "Powayan"],
"Shamli": ["Shamli Town", "Kairana", "Thanabhawan", "Un"],
"Shravasti": ["Bhinga", "Gilaula", "Ikauna", "Jamunaha"],
"Siddharthnagar": ["Naugarh", "Bansi", "Domariyaganj", "Itwa"],
"Sitapur": ["Sitapur Town", "Biswan", "Mahmudabad", "Laharpur"],
"Sonbhadra": ["Robertsganj", "Obra", "Duddhi", "Chopan"],
"Sultanpur": ["Sultanpur Town", "Kadipur", "Lambhua", "Dostpur"],
"Unnao": ["Unnao Town", "Purwa", "Hasanganj", "Safipur"],

// ========== MADHYA PRADESH (Additional Districts) ==========
"Agar Malwa": ["Agar", "Susner", "Nalkheda", "Barod"],
"Alirajpur": ["Alirajpur Town", "Jobat", "Bhabra", "Katthiwara"],
"Anuppur": ["Anuppur Town", "Jaithari", "Kotma", "Pushprajgarh"],
"Ashoknagar": ["Ashoknagar Town", "Chanderi", "Mungaoli", "Isagarh"],
"Balaghat": ["Balaghat Town", "Waraseoni", "Katangi", "Khairlanji"],
"Barwani": ["Barwani Town", "Sendhwa", "Rajpur", "Pansemal"],
"Betul": ["Betul Town", "Multai", "Bhainsdehi", "Amla"],
"Bhind": ["Bhind Town", "Gohad", "Lahar", "Mehgaon"],
"Burhanpur": ["Burhanpur Town", "Nepanagar", "Shahpur", "Khaknar"],
"Chhatarpur": ["Chhatarpur Town", "Nowgong", "Bijawar", "Rajnagar"],
"Chhindwara": ["Chhindwara Town", "Parasia", "Sausar", "Pandhurna"],
"Damoh": ["Damoh Town", "Hata", "Patharia", "Tendukheda"],
"Datia": ["Datia Town", "Seondha", "Bhander", "Indergarh"],
"Dewas": ["Dewas Town", "Khategaon", "Bagli", "Tonk Khurd"],
"Dhar": ["Dhar Town", "Manawar", "Sardarpur", "Kukshi"],
"Dindori": ["Dindori Town", "Shahpura", "Amarpur", "Karanjia"],
"Guna": ["Guna Town", "Ashok Nagar", "Raghogarh", "Chachoda"],
"Harda": ["Harda Town", "Timarni", "Khirkiya", "Rehatgaon"],
"Hoshangabad": ["Hoshangabad Town", "Itarsi", "Sohagpur", "Pipariya"],
"Katni": ["Katni Town", "Vijayraghogarh", "Murwara", "Barhi"],
"Khandwa": ["Khandwa Town", "Pandhana", "Harsud", "Khalwa"],
"Khargone": ["Khargone Town", "Maheshwar", "Bhikangaon", "Kasrawad"],
"Mandla": ["Mandla Town", "Nainpur", "Bichhiya", "Niwas"],
"Mandsaur": ["Mandsaur Town", "Sitamau", "Malhargarh", "Garoth"],
"Morena": ["Morena Town", "Sabalgarh", "Ambah", "Joura"],
"Narsinghpur": ["Narsinghpur Town", "Gadarwara", "Kareli", "Gotegaon"],
"Neemuch": ["Neemuch Town", "Manasa", "Jawad", "Rampura"],
"Panna": ["Panna Town", "Ajaigarh", "Pawai", "Amanganj"],
"Rajgarh": ["Rajgarh Town", "Biaora", "Narsingarh", "Khilchipur"],
"Ratlam": ["Ratlam Town", "Alot", "Jaora", "Sailana"],
"Rewa": ["Rewa Town", "Sirmour", "Mauganj", "Teonthar"],
"Sagar": ["Sagar Town", "Khurai", "Rehli", "Bina"],
"Satna": ["Satna Town", "Maihar", "Nagod", "Rampur Baghelan"],
"Sehore": ["Sehore Town", "Nasrullaganj", "Budni", "Ashta"],
"Seoni": ["Seoni Town", "Lakhnadon", "Barghat", "Keolari"],
"Shahdol": ["Shahdol Town", "Beohari", "Jaisinghnagar", "Burhar"],
"Shajapur": ["Shajapur Town", "Shujalpur", "Kalapipal", "Moman Badodiya"],
"Sheopur": ["Sheopur Town", "Vijaypur", "Karahal", "Badoda"],
"Shivpuri": ["Shivpuri Town", "Kolaras", "Karera", "Pichhore"],
"Singrauli": ["Waidhan", "Chitrangi", "Deosar", "Singrauli Town"],
"Tikamgarh": ["Tikamgarh Town", "Jatara", "Niwari", "Palera"],

// ========== RAJASTHAN (Additional Districts) ==========
"Alwar": ["Alwar City", "Behror", "Tijara", "Rajgarh"],
"Banswara": ["Banswara Town", "Kushalgarh", "Ghatol", "Bagidora"],
"Baran": ["Baran Town", "Atru", "Chhabra", "Kishanganj"],
"Barmer": ["Barmer Town", "Balotra", "Pachpadra", "Siwana"],
"Bharatpur": ["Bharatpur City", "Bayana", "Kaman", "Deeg"],
"Bhilwara": ["Bhilwara Town", "Shahpura", "Mandal", "Asind"],
"Bundi": ["Bundi Town", "Keshoraipatan", "Nainwa", "Hindoli"],
"Chittorgarh": ["Chittorgarh Town", "Nimbahera", "Begun", "Kapasan"],
"Churu": ["Churu Town", "Ratangarh", "Sardarshahar", "Taranagar"],
"Dausa": ["Dausa Town", "Lalsot", "Bandikui", "Baswa"],
"Dholpur": ["Dholpur Town", "Bari", "Baseri", "Rajakhera"],
"Dungarpur": ["Dungarpur Town", "Sagwara", "Aspur", "Simalwara"],
"Hanumangarh": ["Hanumangarh Town", "Nohar", "Pilibanga", "Sangaria"],
"Jaisalmer": ["Jaisalmer City", "Pokaran", "Sam Sand Dunes", "Ramgarh"],
"Jalore": ["Jalore Town", "Bhinmal", "Sanchore", "Ahore"],
"Jhalawar": ["Jhalawar Town", "Khanpur", "Jhalrapatan", "Aklera"],
"Jhunjhunu": ["Jhunjhunu Town", "Nawalgarh", "Chirawa", "Pilani"],
"Karauli": ["Karauli Town", "Hindaun", "Todabhim", "Sapotra"],
"Kota": ["Kota City", "Ramganj Mandi", "Sangod", "Ladpura"],
"Nagaur": ["Nagaur Town", "Merta City", "Didwana", "Makrana"],
"Pali": ["Pali Town", "Sojat", "Jaitaran", "Sumerpur"],
"Pratapgarh": ["Pratapgarh Town", "Arnod", "Chhoti Sadri", "Dhariawad"],
"Rajsamand": ["Kankroli", "Nathdwara", "Rajsamand Town", "Amet"],
"Sawai Madhopur": ["Sawai Madhopur Town", "Gangapur City", "Bonli", "Malarna Dungar"],
"Sikar": ["Sikar Town", "Fatehpur", "Ramgarh", "Sri Madhopur"],
"Sirohi": ["Sirohi Town", "Mount Abu", "Pindwara", "Sheoganj"],
"Sri Ganganagar": ["Sri Ganganagar Town", "Suratgarh", "Anupgarh", "Raisinghnagar"],
"Tonk": ["Tonk Town", "Newai", "Uniara", "Deoli"],

// ========== MAHARASHTRA (Additional Districts) ==========
"Ahmednagar": ["Ahmednagar City", "Sangamner", "Shrirampur", "Nevasa"],
"Akola": ["Akola City", "Balapur", "Akot", "Barshitakli"],
"Amravati": ["Amravati City", "Chandur Railway", "Morshi", "Dhamangaon"],
"Beed": ["Beed Town", "Ambejogai", "Georai", "Majalgaon"],
"Bhandara": ["Bhandara Town", "Tumsar", "Pauni", "Mohadi"],
"Buldhana": ["Buldhana Town", "Malkapur", "Chikhli", "Khamgaon"],
"Chandrapur": ["Chandrapur Town", "Ballarpur", "Warora", "Rajura"],
"Dhule": ["Dhule City", "Sakri", "Sindkheda", "Shirpur"],
"Gadchiroli": ["Gadchiroli Town", "Aheri", "Dhanora", "Kurkheda"],
"Gondia": ["Gondia Town", "Tirora", "Goregaon", "Sadak Arjuni"],
"Hingoli": ["Hingoli Town", "Kalamnuri", "Aundha Nagnath", "Basmath"],
"Jalgaon": ["Jalgaon City", "Bhusawal", "Jamner", "Amalner"],
"Jalna": ["Jalna Town", "Bhokardan", "Partur", "Ambad"],
"Latur": ["Latur City", "Ausa", "Nilanga", "Ahmadpur"],
"Nanded": ["Nanded City", "Kinwat", "Mukhed", "Deglur"],
"Nandurbar": ["Nandurbar Town", "Shahada", "Taloda", "Akkalkuwa"],
"Osmanabad": ["Osmanabad Town", "Tuljapur", "Kalamb", "Bhum"],
"Palghar": ["Palghar Town", "Vasai", "Virar", "Dahanu"],
"Parbhani": ["Parbhani Town", "Gangakhed", "Jintur", "Pathri"],
"Raigad": ["Alibag", "Panvel", "Pen", "Karjat"],
"Ratnagiri": ["Ratnagiri City", "Chiplun", "Dapoli", "Mandangad"],
"Sangli": ["Sangli City", "Miraj", "Tasgaon", "Islampur"],
"Satara": ["Satara City", "Karad", "Wai", "Phaltan"],
"Sindhudurg": ["Oras", "Malvan", "Kudal", "Sawantwadi"],
"Thane": ["Thane City", "Kalyan", "Dombivli", "Bhiwandi"],
"Wardha": ["Wardha Town", "Hinganghat", "Arvi", "Deoli"],
"Washim": ["Washim Town", "Karanja", "Malegaon", "Risod"],
"Yavatmal": ["Yavatmal Town", "Pusad", "Darwha", "Wani"]


};

  function loadDistricts() {
    const state = document.getElementById('stateInput').value;
    const districtSelect = document.getElementById('districtInput');
    const areaSelect = document.getElementById('areaInput');
    
    districtSelect.innerHTML = '<option value="">Select District</option>';
    areaSelect.innerHTML = '<option value="">Select Area</option>';
    areaSelect.disabled = true;
    
    if (state && districtData[state]) {
      districtSelect.disabled = false;
      districtData[state].forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });
    } else {
      districtSelect.disabled = true;
    }
  }

  function loadAreas() {
    const district = document.getElementById('districtInput').value;
    const areaSelect = document.getElementById('areaInput');
    
    areaSelect.innerHTML = '<option value="">Select Area</option>';
    
    if (district && areaData[district]) {
      areaSelect.disabled = false;
      areaData[district].forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.textContent = area;
        areaSelect.appendChild(option);
      });
    } else {
      areaSelect.disabled = true;
    }
  }

  async function saveUserLocation() {
    const state = document.getElementById('stateInput').value;
    const district = document.getElementById('districtInput').value;
    const area = document.getElementById('areaInput').value;
    
    if (!state || !district || !area) {
      alert("‚ùó Please fill all location fields!");
      return;
    }
    
    const locationData = {
      state: state,
      district: district,
      area: area,
      timestamp: new Date().toISOString()
    };
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/save-user-location`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(locationData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        localStorage.setItem('userLocation', JSON.stringify(locationData));
        localStorage.setItem('nearestHospital', JSON.stringify(result.hospital));
        
        displaySavedLocation(locationData, result.hospital);
        
       showEmergencyModal('success', '‚úÖ Location Saved!', 'Your nearest hospital has been configured successfully. Emergency button is now ready to use.');

      } else {
        alert("‚ùó Failed to save location: " + result.message);
      }
      
    } catch (error) {
      console.error('Error:', error);
      alert("√É¬¢√Ç¬ù√Ö‚Äô Server error. Please check if backend is running.");
    }
  }

  function displaySavedLocation(location, hospitalData) {
    console.log("Displaying saved location:", location);
    console.log("Hospital data received:", hospitalData);
    
    const title = document.getElementById('hospitalSectionTitle');
    if (title) title.style.display = 'none';
    document.getElementById('locationForm').style.display = 'none';
    
    const savedDisplay = document.getElementById('savedLocationDisplay');
    savedDisplay.style.display = 'block';
    
    let hospitals = Array.isArray(hospitalData) ? hospitalData : [hospitalData];
    
    let html = `
      <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e5e7eb; margin-bottom: 15px;">
        <p style="font-weight: bold; margin-bottom: 15px; color: #2563eb; font-size: 1rem;">
          üè• Your Nearest Hospitals (${hospitals.length})
        </p>
    `;
    
    hospitals.forEach((hospital, index) => {
      const isPrimary = index === 0;
      const bgColor = isPrimary ? '#d1fae5' : '#f9fafb';
      const borderColor = isPrimary ? '#10b981' : '#e5e7eb';
      
      let mapsLink = '#';
      if (hospital.coordinates) {
        mapsLink = `https://www.google.com/maps/search/?api=1&query=${hospital.coordinates.lat},${hospital.coordinates.lng}`;
      }
      
      html += `
        <div style="
          background: ${bgColor}; 
          padding: 12px; 
          border-radius: 8px; 
          border: 2px solid ${borderColor};
          margin-bottom: 10px;
        ">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <p style="font-weight: bold; color: #333; font-size: 0.95rem; margin-bottom: 5px;">
                ${index + 1}. ${hospital.hospital}
              </p>
              <p style="font-size: 0.85rem; color: #666; margin: 3px 0;">
                √¢¬ù‚Ä¢${hospital.phone}
              </p>
              <p style="font-size: 0.85rem; color: #10b981; margin: 3px 0;">
                üöë ${hospital.distance}
              </p>
              ${hospital.coordinates ? `
                <a href="${mapsLink}" target="_blank" style="
                  display: inline-block;
                  margin-top: 8px;
                  padding: 6px 12px;
                  background: #2563eb;
                  color: white;
                  text-decoration: none;
                  border-radius: 5px;
                  font-size: 0.8rem;
                  font-weight: bold;
                  transition: 0.2s;
                " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
                  üìç View on Map
                </a>
              ` : ''}
            </div>
            ${isPrimary ? `
              <div style="
                background: #10b981; 
                color: white; 
                padding: 4px 10px; 
                border-radius: 5px; 
                font-size: 0.75rem;
                font-weight: bold;
                white-space: nowrap;
              ">
                PRIMARY
              </div>
            ` : ''}
          </div>
          ${isPrimary ? `
            <p style="
              font-size: 0.8rem; 
              color: #065f46; 
              margin-top: 8px; 
              font-style: italic;
            ">
              ‚ùóEmergency alerts will be sent here
            </p>
          ` : ''}
        </div>
      `;
    });
    
    html += `
      </div>
      
      <button onclick="editLocation()" style="
        width: 100%;
        background: #2563eb; 
        color: white; 
        border: none;
        padding: 12px 15px; 
        border-radius: 8px; 
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: bold;
        transition: 0.2s;
      " onmouseover="this.style.background='#1d4ed8'" onmouseout="this.style.background='#2563eb'">
       ‚úçÔ∏èEdit Location
      </button>
    `;
    
    savedDisplay.innerHTML = html;
  }

  function editLocation() {
    const title = document.getElementById('hospitalSectionTitle');
    if (title) title.style.display = 'block';
    
    document.getElementById('locationForm').style.display = 'block';
    document.getElementById('savedLocationDisplay').style.display = 'none';
    
    localStorage.removeItem('userLocation');
    localStorage.removeItem('nearestHospital');
  }

  // ========== EMERGENCY BUTTON ==========

  async function triggerEmergency() {
  const savedLocation = localStorage.getItem('userLocation');
  const savedHospital = localStorage.getItem('nearestHospital');
  
  if (!savedLocation || !savedHospital) {
    showEmergencyModal('error', '‚ùå Location Not Set', 'Please set your nearest hospital in the right sidebar before using the Emergency button.');
    return;
  }
  
  const location = JSON.parse(savedLocation);
  const hospital = JSON.parse(savedHospital);
  
  // Show sending modal
  showEmergencyModal('sending', 'üö® Sending Emergency Alert...', 'Please wait while we contact the hospital.');
  
  try {
    const response = await fetch(`${BACKEND_URL}/api/emergency`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        state: location.state,
        district: location.district,
        area: location.area,
        hospital: hospital
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showEmergencyModal('success', '‚úÖ Emergency Alert Sent!', `Your SOS has been successfully sent to <strong>${hospital}</strong>. Help is on the way! Stay calm and stay where you are.`);
    } else {
      showEmergencyModal('error', '‚ùó Failed to Send Alert', result.message || 'Unable to send emergency alert. Please try again or call 108 directly.');
    }
  } catch (error) {
    console.error('Emergency error:', error);
    showEmergencyModal('error', '‚ùó Connection Failed', 'Unable to reach emergency services. Please call 108 immediately for assistance.');
  }
}

// Function to Open the About Modal
function showAboutModal() {
  const modal = document.getElementById('aboutModal');
  if (modal) {
    modal.style.display = 'block'; // Or 'flex' if you prefer centering
  } else {
    console.error("Error: aboutModal not found in HTML");
  }
}

// Function to Close the About Modal
function closeAbout() {
  const modal = document.getElementById('aboutModal');
  if (modal) {
    modal.style.display = 'none';
  }
}




// Custom Emergency Modal System
function showEmergencyModal(type, title, message) {
  // Remove any existing modal
  const existingModal = document.getElementById('emergencyModalOverlay');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Create overlay
  const overlay = document.createElement('div');
  overlay.id = 'emergencyModalOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20000;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
  `;
  
  let backgroundColor, iconColor, icon, showCloseButton;
  
  if (type === 'sending') {
    backgroundColor = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
    iconColor = '#ffffff';
    icon = `
      <div style="width: 80px; height: 80px; border: 6px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px auto;"></div>
    `;
    showCloseButton = false;
  } else if (type === 'success') {
    backgroundColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    iconColor = '#ffffff';
    icon = '<div style="font-size: 5rem; margin-bottom: 15px;">‚úÖ</div>';
    showCloseButton = true;
  } else {
    backgroundColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    iconColor = '#ffffff';
    icon = '<div style="font-size: 5rem; margin-bottom: 15px;">‚ùó</div>';
    showCloseButton = true;
  }
  
  const modalHTML = `
    <div style="background: white; padding: 0; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: modalSlideUp 0.4s ease-out; overflow: hidden;">
      <div style="background: ${backgroundColor}; padding: 40px 30px; text-align: center;">
        ${icon}
        <h2 style="color: white; margin: 0; font-size: 1.8rem;">${title}</h2>
      </div>
      <div style="padding: 30px; text-align: center;">
        <p style="color: #374151; font-size: 1.1rem; line-height: 1.7; margin: 0;">${message}</p>
        ${showCloseButton ? `
          <button onclick="document.getElementById('emergencyModalOverlay').remove()" style="margin-top: 25px; padding: 14px 40px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(37,99,235,0.3);">
            Close
          </button>
        ` : ''}
      </div>
    </div>
  `;
  
  overlay.innerHTML = modalHTML;
  document.body.appendChild(overlay);
  
  // Auto-close sending modal after response
  if (type === 'sending') {
    // Keep it open until replaced by success/error
  }
}


  // ========== CHAT HISTORY FEATURE ==========

  let chatHistory = [];

  function loadChatHistory() {
    const saved = localStorage.getItem('chatHistory');
    if (saved) {
      chatHistory = JSON.parse(saved);
    }
  }

  function saveChatHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }

 async function addToHistory(firstQuestion) {
  const greetingWords = ['hi', 'hello', 'hey', 'good morning', 'good evening', 'good afternoon'];
  const isGreeting = greetingWords.some(word => firstQuestion.toLowerCase().includes(word));
  
  if (!firstQuestion || isGreeting) {
    return;
  }
  
  const historyItem = {
    id: Date.now(),
    title: firstQuestion,
    timestamp: new Date().toISOString(),
    date: new Date()
  };
  
  chatHistory.unshift(historyItem);
  
  if (chatHistory.length > 20) {
    chatHistory = chatHistory.slice(0, 20);
  }
  
  saveChatHistory();
  
  // ‚úÖ NEW: Sync to Firebase for cross-device access
  try {
    if (window.firebaseDB) {
      const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
      
      // Get or create user ID
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      
      await addDoc(collection(window.firebaseDB, 'chatHistory'), {
        userId: userId,
        question: firstQuestion,
        timestamp: serverTimestamp()
      });
      
      console.log('‚úÖ Chat history synced to Firebase');
    }
  } catch (error) {
    console.error('‚ùó Failed to sync chat history:', error);
    // Continue anyway - localStorage backup exists
  }
}


// Add this after your initializePeerJS() function
function keepPeerAlive() {
    if (window.peer) {
        window.peer.on('disconnected', function() {
            console.log('‚ö†Ô∏è PeerJS disconnected, attempting to reconnect...');
            
            // Try to reconnect after 2 seconds
            setTimeout(() => {
                if (window.peer.destroyed) {
                    console.log('üîÑ Peer was destroyed, reinitializing...');
                    initializePeerJS();
                } else {
                    window.peer.reconnect();
                    console.log('üîÑ Attempting manual reconnect...');
                }
            }, 2000);
        });
        
        window.peer.on('error', function(error) {
            console.error('‚ùó PeerJS error:', error);
            if (error.type === 'network' || error.type === 'server-error') {
                console.log('üîÑ Network error, will reinitialize...');
                setTimeout(() => initializePeerJS(), 3000);
            }
        });
    }
}

// Call this after initializing PeerJS
initializePeerJS();
keepPeerAlive();



 function toggleChatHistory() {
  const panel = document.getElementById('chatHistoryPanel');
  const sidebar = document.getElementById('sidebar');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
  } else {
    panel.classList.add('open');
    sidebar.classList.remove('open');
    displayChatHistory();
  }
}

// ‚úÖ NEW: Close history independently
function closeChatHistory() {
  const panel = document.getElementById('chatHistoryPanel');
  panel.classList.remove('open');
}

  function displayChatHistory() {
    const historyList = document.getElementById('historyList');
    
    if (chatHistory.length === 0) {
      historyList.innerHTML = '<div class="no-history">No chat history yet.<br>Start a conversation!</div>';
      return;
    }
    
    let html = '';
    chatHistory.forEach(item => {
      const timeAgo = getTimeAgo(new Date(item.timestamp));
      
      html += `
        <div class="history-item" onclick="loadConversation('${item.id}')">
          <div class="history-title">${item.title}</div>
          <div class="history-time">${timeAgo}</div>
        </div>
      `;
    });
    
    historyList.innerHTML = html;
  }

  function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return date.toLocaleDateString();
  }

  function loadConversation(id) {
    alert('Conversation loading feature coming soon!\n\nConversation ID: ' + id);
  }

  function clearChatHistory() {
    const confirmed = confirm('Are you sure you want to clear all chat history?');
    if (confirmed) {
      chatHistory = [];
      saveChatHistory();
      displayChatHistory();
    }
  }

  // Add this function to your JavaScript section
async function sendPasswordResetEmail(email) {
  try {
    const { collection, query, where, getDocs } = window.firestoreFunctions;
    const doctorsRef = collection(window.firebaseDB, 'doctors');
    const q = query(doctorsRef, where('email', '==', email));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      alert('‚ùó No account found with this email');
      return;
    }
    
    // Generate a reset token (6-digit code)
    const resetToken = Math.floor(100000 + Math.random() * 900000);
    const resetExpiry = Date.now() + (30 * 60 * 1000); // 30 minutes
    
    // Store reset token in Firestore
    const doctorDoc = snapshot.docs[0];
    const { updateDoc, doc } = window.firestoreFunctions;
    await updateDoc(doc(window.firebaseDB, 'doctors', doctorDoc.id), {
      resetToken: resetToken.toString(),
      resetExpiry: resetExpiry
    });
    
    // Show the reset code (in production, send via email)
    alert(`‚úÖ Reset Code: ${resetToken}\n\nShare this code with the doctor.\nValid for 30 minutes.`);
    console.log('Password Reset Code:', resetToken);
    
    return resetToken;
  } catch (error) {
    console.error('Reset error:', error);
    alert('‚ùó Error generating reset code');
  }
}

// Function to verify reset code and set new password
async function resetPassword(email, resetCode, newPassword) {
  try {
    const { collection, query, where, getDocs, updateDoc, doc } = window.firestoreFunctions;
    const doctorsRef = collection(window.firebaseDB, 'doctors');
    const q = query(doctorsRef, where('email', '==', email));
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
      alert('‚ùó No account found');
      return false;
    }
    
    const doctorDoc = snapshot.docs[0];
    const doctorData = doctorDoc.data();
    
    // Verify reset code and expiry
    if (doctorData.resetToken !== resetCode.toString()) {
      alert('‚ùó Invalid reset code');
      return false;
    }
    
    if (Date.now() > doctorData.resetExpiry) {
      alert('‚ùó Reset code expired. Request a new one.');
      return false;
    }
    
    // Update password and clear reset token
    await updateDoc(doc(window.firebaseDB, 'doctors', doctorDoc.id), {
      password: newPassword,
      resetToken: null,
      resetExpiry: null
    });
    
    alert('‚úÖ Password reset successful!');
    return true;
  } catch (error) {
    console.error('Reset error:', error);
    alert('‚ùó Error resetting password');
    return false;
  }
}


  // ========== CHATBOT FUNCTIONS ==========

  const userInputField = document.getElementById('userInput');
  const topTypingBox = document.getElementById('topTypingBox');
  const topTypingContent = document.getElementById('topTypingContent');
  const suggestionsBox = document.getElementById('suggestionsBox');
  const suggestionsList = document.getElementById('suggestionsList');
  const chatWindow = document.getElementById('chatWindow');

 function toggleMenu() {
  const sidebar = document.getElementById("sidebar");
  const historyPanel = document.getElementById("chatHistoryPanel");
  
  // Toggle sidebar
  sidebar.classList.toggle("open");
  
  // ‚úÖ NEW: Auto-close history when sidebar closes
  if (!sidebar.classList.contains("open")) {
    historyPanel.classList.remove("open");
  }
}


  userInputField.addEventListener('input', function() {
    const text = userInputField.value.trim();
    
    if (text.length > 0) {
      topTypingBox.classList.add('active');
      topTypingContent.textContent = text;
    } else {
      topTypingBox.classList.remove('active');
      suggestionsBox.classList.remove('active');
      return;
    }
    
    if (text.length >= 1) {
      getSuggestions(text);
    } else {
      suggestionsBox.classList.remove('active');
    }
  });

  async function getSuggestions(text) {
    try {
      const response = await fetch(`${BACKEND_URL}/api/get-suggestions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: text })
      });
      
      const data = await response.json();
      showSuggestions(data.suggestions);
    } catch (error) {
      console.error('Error:', error);
      suggestionsList.innerHTML = '<div class="no-suggestions">√É¬¢√Ö¬° √É¬Ø√Ç¬∏√Ç¬è  Connection error....</div>';
      suggestionsBox.classList.add('active');
    }
  }

  function showSuggestions(suggestions) {
    suggestionsList.innerHTML = '';
    
    if (suggestions.length > 0) {
      suggestions.forEach(question => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = question;
        
        div.addEventListener('click', function() {
          userInputField.value = question;
          topTypingBox.classList.remove('active');
          suggestionsBox.classList.remove('active');
          userInputField.focus();
        });
        
        suggestionsList.appendChild(div);
      });
      
      suggestionsBox.classList.add('active');
    } else {
      suggestionsList.innerHTML = '<div class="no-suggestions">No matching questions found.</div>';
      suggestionsBox.classList.add('active');
    }
  }

  async function sendMessage() {
    const userText = userInputField.value.trim();
    if (!userText) return;
    
    // ‚úÖ Doctor sending to patient
    if (localStorage.getItem('userMode') === 'doctor' && activePatientId) {
      await sendDoctorMessage(activePatientId, userText);
      userInputField.value = '';
      return;
    }
    
    // ‚úÖ Patient sending to doctor
    if (activePatientConversation) {
      await sendPatientMessage(activePatientConversation, userText);
      userInputField.value = '';
      return;
    }

    // Regular chatbot (existing code below)
    topTypingBox.classList.remove('active');
    suggestionsBox.classList.remove('active');
    


    const userMsg = document.createElement("div");
    userMsg.className = "user-msg";
    userMsg.textContent = userText;
    chatWindow.appendChild(userMsg);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    userInputField.value = '';

    // √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ TRACK FIRST REAL QUESTION (FIXED VERSION)
    if (!window.currentSessionFirstQuestion) {
      const greetingWords = ['hi', 'hello', 'hey', 'good morning', 'good evening', 'good afternoon', 'hii', 'hlo', 'namaste'];
      const isGreeting = greetingWords.some(word => userText.toLowerCase().trim() === word || userText.toLowerCase().includes(word));
      
      if (!isGreeting && userText.length > 5) {
        window.currentSessionFirstQuestion = userText;
        addToHistory(userText);
      }
    }

    const loadingMsg = document.createElement("div");
    loadingMsg.className = "bot-msg";
    loadingMsg.textContent = "‚åõ Finding answer...";
    loadingMsg.id = "loading-msg";
    chatWindow.appendChild(loadingMsg);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
      const response = await fetch(`${BACKEND_URL}/api/get-answer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: userText })
      });
      
      const data = await response.json();
      
      const loading = document.getElementById("loading-msg");
      if (loading) loading.remove();

      const botMsg = document.createElement("div");
      botMsg.className = "bot-msg";
      chatWindow.appendChild(botMsg);
      
      let i = 0;
      function typeWriter() {
        if (i < data.answer.length) {
          botMsg.textContent += data.answer.charAt(i);
          i++;
          setTimeout(typeWriter, 20);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      }
      typeWriter();
      
    } catch (error) {
      const loading = document.getElementById("loading-msg");
      if (loading) loading.remove();
      
      const botMsg = document.createElement("div");
      botMsg.className = "bot-msg";
      botMsg.textContent = "√É¬¢√Ö¬° √É¬Ø√Ç¬∏√Ç¬è Server down!";
      chatWindow.appendChild(botMsg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
  }

  userInputField.addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      sendMessage();
    }
  });

  function toggleSettings() {
    const submenu = document.getElementById('settingsSubmenu');
    if (submenu.style.display === 'none') {
      submenu.style.display = 'block';
    } else {
      submenu.style.display = 'none';
    }
  }

  function openAbout() {
    document.getElementById('aboutModal').style.display = 'block';
  }

  function closeAbout() {
    document.getElementById('aboutModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const aboutModal = document.getElementById('aboutModal');
    if (event.target == aboutModal) {
      aboutModal.style.display = 'none';
    }
  }

  // ========== DOCTOR CONNECT ==========
  
  // ========== DOCTOR CONNECT (FIXED) ==========

// Load real doctors from Firebase
async function loadRealDoctors() {
  const doctorList = document.getElementById('doctorList');
  doctorList.innerHTML = '<p class="loading-doctors">Loading doctors...</p>';
  
  try {
    if (!window.firebaseDB) {
      doctorList.innerHTML = '<p class="loading-doctors">‚ùó Firebase not initialized</p>';
      return;
    }
    
    const { collection, getDocs } = window.firestoreFunctions;
    const doctorsRef = collection(window.firebaseDB, 'doctors');
    const querySnapshot = await getDocs(doctorsRef);
    
    if (querySnapshot.empty) {
      doctorList.innerHTML = '<p style="text-align: center; color: #666;">No doctors available yet.</p>';
      return;
    }
    
    // Convert to array and display
    const doctors = [];
    querySnapshot.forEach((doc) => {
      doctors.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${doctors.length} doctors from Firebase`);
    displayDoctors(doctors);
    
  } catch (error) {
    console.error('Error loading doctors:', error);
    doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùó Error loading doctors</p>';
  }
}


// Toggle doctor list
function toggleDoctorList() {
  const container = document.getElementById('doctorListContainer');
  const btn = document.getElementById('connectDoctorBtn');
  
  if (!doctorListVisible) {
    container.classList.add('expanded');
    btn.textContent = '‚ùåClose Doctor List';
    loadRealDoctors(); // √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Call the REAL function
    doctorListVisible = true;
  } else {
    container.classList.remove('expanded');
    btn.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctors';
    doctorListVisible = false;
  }
}


// ========== PATIENT REQUEST SYSTEM ==========

function requestDoctorConsultation(doctorId, doctorData) {
  // Check if already in doctor mode
  if (localStorage.getItem('userMode') === 'doctor') {
    alert('You are logged in as a doctor. Please logout to request consultation as a patient.');
    return;
  }
  
  // Show urgency selection modal
  showUrgencySelectionModal(doctorId, doctorData);
}


function showUrgencySelectionModal(doctorId, doctorData) {
  const overlay = document.createElement('div');
  overlay.id = 'urgencyModalOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20000;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
  `;
  
  overlay.innerHTML = `
    <div style="background: white; padding: 0; border-radius: 20px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: modalSlideUp 0.4s ease-out; overflow: hidden;">
      
      <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); padding: 30px; text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 10px;">üë®‚Äç‚öïÔ∏è</div>
        <h2 style="color: white; margin: 0; font-size: 1.5rem;">Request Consultation</h2>
        <p style="color: #e0f2fe; margin: 10px 0 0 0; font-size: 0.95rem;">Dr. ${doctorData.name} - ${doctorData.specialty}</p>
      </div>
      
      <div style="padding: 30px;">
        <p style="color: #374151; margin-bottom: 20px; font-size: 0.95rem; text-align: center; font-weight: 600;">Please fill your details first:</p>
        
        <div id="patientInfoForm" style="margin-bottom: 20px;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">Your Name: <span style="color: #ef4444;">*</span></label>
            <input type="text" id="patientNameInput" placeholder="Enter your full name" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" required>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem;">Your Age: <span style="color: #ef4444;">*</span></label>
            <input type="number" id="patientAgeInput" placeholder="Enter your age" min="1" max="120" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" required>
          </div>
        </div>
        
        <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9rem; text-align: center;">Now select urgency level:</p>
        
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
          
          <button onclick="validateAndSubmit('${doctorId}', ${JSON.stringify(doctorData).replace(/"/g, '&quot;')}, 'red')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(239,68,68,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            ‚ùó Emergency - Urgent Response Needed
          </button>
          
          <button onclick="validateAndSubmit('${doctorId}', ${JSON.stringify(doctorData).replace(/"/g, '&quot;')}, 'blue')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(59,130,246,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
           üì´ Priority - First Available Slot
          </button>
          
          <button onclick="validateAndSubmit('${doctorId}', ${JSON.stringify(doctorData).replace(/"/g, '&quot;')}, 'green')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(16,185,129,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
            ‚úÖ Normal - When Doctor is Free
          </button>
          
        </div>
        
        <button onclick="document.getElementById('urgencyModalOverlay').remove()" style="width: 100%; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer;">
          Cancel
        </button>
      </div>
      
    </div>
  `;
  
  document.body.appendChild(overlay);
  
  // Close on outside click
  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
}


// ‚úÖ VALIDATION FUNCTION (SEPARATE - NOT INSIDE submitPatientRequest)
function validateAndSubmit(doctorId, doctorData, urgency) {
  // Get inputs
  const nameInput = document.getElementById('patientNameInput');
  const ageInput = document.getElementById('patientAgeInput');
  
  const patientName = nameInput.value.trim();
  const patientAge = ageInput.value.trim();
  
  // ‚úÖ VALIDATE NAME
  if (!patientName) {
    alert('‚ùó Please enter your name');
    nameInput.focus();
    nameInput.style.border = '2px solid #ef4444';
    return;
  }
  
  // ‚úÖ VALIDATE AGE
  if (!patientAge) {
    alert('‚ùó Please enter your age');
    ageInput.focus();
    ageInput.style.border = '2px solid #ef4444';
    return;
  }
  
  const age = parseInt(patientAge);
  if (age < 1 || age > 120) {
    alert('‚ùó Please enter a valid age (10-90)');
    ageInput.focus();
    ageInput.style.border = '2px solid #ef4444';
    return;
  }
  
  // ‚úÖ ALL VALID - NOW SUBMIT
  submitPatientRequest(doctorId, doctorData, urgency);
}


// ‚úÖ SUBMIT FUNCTION (RUNS AFTER VALIDATION PASSES)
async function submitPatientRequest(doctorId, doctorData, urgency) {
  // Get patient info from modal inputs
  const patientName = document.getElementById('patientNameInput').value.trim();
  const patientAge = document.getElementById('patientAgeInput').value.trim();
  
  // Remove modal
  document.getElementById('urgencyModalOverlay').remove();
  
  // Show loading
  showEmergencyModal('sending', 'Sending Request...', 'Please wait while we notify the doctor.');
  
  try {
    if (!window.firebaseDB) {
      throw new Error('Firebase not initialized');
    }
    
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    
    // ‚úÖ CREATE PATIENT REQUEST WITH ALL DATA
    const patientRequest = {
      doctorId: doctorId,
      doctorName: doctorData.name || 'Unknown',
      doctorSpecialty: doctorData.specialty || 'General',
      name: patientName,
      age: patientAge,
      urgency: urgency,
      status: 'pending',
      timestamp: serverTimestamp(),
      message: `${patientName} (Age: ${patientAge}) wants to consult.`
    };
    
    // Save to Firebase
    const docRef = await addDoc(collection(window.firebaseDB, 'patientRequests'), patientRequest);
    
    console.log('‚úÖ Patient request created with ID:', docRef.id);
    
    // Close loading and show success
    closeEmergencyModal();
    showEmergencyModal('success', 'Request Sent!', `Your consultation request has been sent to Dr. ${doctorData.name}. Please wait for the doctor to respond.`);
    
    // Auto-close success modal after 3 seconds
    setTimeout(() => {
      closeEmergencyModal();
    }, 3000);
    
  } catch (error) {
    console.error('‚ùó Error submitting request:', error);
    closeEmergencyModal();
    showEmergencyModal('error', 'Request Failed', 'Failed to send request. Please try again.');
  }
}

// ========== END PATIENT REQUEST SYSTEM ==========

// ========== PHASE 3: ACTIVE CONVERSATION AREA ==========

// ========== PHASE 3: ACTIVE CONVERSATION AREA ==========

let activePatientId = null;
let conversationInterval = null;

// ========== MODE INITIALIZATION FUNCTIONS ==========

// Initialize Doctor Mode
async function initializeDoctorMode() {
  console.log('ü©∫ DOCTOR MODE INITIALIZED');
  
  // ‚úÖ CRITICAL FIX: Load currentDoctor from storage
  const doctorSession = sessionStorage.getItem('doctorSession') || localStorage.getItem('activeDoctorSession');
  if (doctorSession) {
    currentDoctor = JSON.parse(doctorSession);
    console.log('‚úÖ currentDoctor loaded from storage:', currentDoctor.name);
  } else {
    console.error('‚ùå No doctor session in storage!');
  }
  
  // ‚úÖ HIDE EMERGENCY BUTTON
  const emergencyBtn = document.querySelector('.emergency');
  if (emergencyBtn) {
    emergencyBtn.style.display = 'none';
  }
  
  // ... rest of your existing code


  // ‚úÖ HIDE HOSPITAL SECTION
  const hospitalSection = document.querySelector('.hospital-section');
  if (hospitalSection) {
    hospitalSection.style.display = 'none';
  }
  
  // ‚úÖ CLEAR DOCTOR LIST CONTAINER
  const doctorListContainer = document.getElementById('doctorListContainer');
  if (doctorListContainer) {
    doctorListContainer.classList.remove('expanded');
    doctorListContainer.innerHTML = '<div id="doctorList"></div>'; // ‚úÖ Create doctorList element
  }
  
  // ‚úÖ UPDATE BUTTON TO "PATIENT LIST"
  const btn = document.getElementById('connectDoctorBtn');
  const btnText = document.getElementById('patientBtnText');
  const badge = document.getElementById('patientCountBadge');
  
  if (btnText) {
    btnText.textContent = 'üë§ Patient List';
  } else if (btn) {
    btn.textContent = 'üë§ Patient List';
  }
  
  if (btn) {
    btn.onclick = togglePatientList;
  }
  
  // ‚úÖ SHOW DOCTOR CHAT GREETING
  initializeDoctorChatArea();
  
  // ‚úÖ CLEAR ANY EXISTING INTERVALS
  if (window.doctorRefreshInterval) {
    clearInterval(window.doctorRefreshInterval);
    window.doctorRefreshInterval = null;
  }
  
  // ‚úÖ AUTO-REFRESH WITH SAFETY CHECKS
  window.doctorRefreshInterval = setInterval(() => {
    // Only refresh if:
    // 1. Still in doctor mode
    // 2. Patient list is visible
    // 3. Not currently loading
    if (localStorage.getItem('userMode') === 'doctor' && 
        patientListVisible && 
        !window.isLoadingPatients) {
      
      // Check if container exists before loading
      const doctorList = document.getElementById('doctorList');
      if (doctorList) {
        console.log('√∞≈∏‚Äù‚Äû Auto-refreshing patient list...');
        loadPatientList();
      } else {
        console.warn('‚ùå doctorList not found, skipping auto-refresh');
      }
    }
  }, 5000); // 5 seconds for faster updates
  
  console.log('‚úÖ Doctor mode fully activated');
}


// Initialize Patient/Guest Mode
// Initialize Patient/Guest Mode
function initializePatientMode() {
  console.log('üë§ PATIENT MODE INITIALIZED');
  
  // ============================================================
  // ‚úÖ FIX: FORCE CLOSE ALL AUTH MODALS
  // This ensures the screen unlocks after login!
  // ============================================================
  const modalsToClose = [
    'patientAuthModal', 
    'doctorLoginModal', 
    'doctorRegModal', 
    'roleModal',      // <--- The "Doctor vs Patient" screen
    'authModal'       // <--- The "Login vs Register" screen
  ];
  
  modalsToClose.forEach(id => {
    const modal = document.getElementById(id);
    if (modal) modal.style.display = 'none';
  });
  // ============================================================

  // ‚úÖ SHOW EMERGENCY BUTTON
  const emergencyBtn = document.querySelector('.emergency');
  if (emergencyBtn) {
    emergencyBtn.style.display = 'block';
  }
  
  // ‚úÖ SHOW HOSPITAL SECTION
  const hospitalSection = document.querySelector('.hospital-section');
  if (hospitalSection) {
    hospitalSection.style.display = 'block';
  }
  
  // ‚úÖ CLEAR PATIENT LIST CONTAINER AND CREATE doctorList element
  const patientListContainer = document.getElementById('doctorListContainer');
  if (patientListContainer) {
    patientListContainer.classList.remove('expanded');
    patientListContainer.innerHTML = '<div id="doctorList"></div>';
  }
  
  // ‚úÖ UPDATE BUTTON TO "CONNECT TO DOCTOR"
  const btn = document.getElementById('connectDoctorBtn');
  const btnText = document.getElementById('patientBtnText');
  
  if (btnText) {
    btnText.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctor';
  } else if (btn) {
    btn.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctor';
  }
  
  if (btn) {
    btn.onclick = togglePatientList;
  }
  
  // ‚úÖ RESET CHAT WINDOW TO DEFAULT
  const chatWindow = document.getElementById('chatWindow');
  if (chatWindow) {
    chatWindow.innerHTML = '<div class="bot-msg">üëãHello dear! ‚¨áÔ∏èType your health question below and I\'ll help you find answers.</div>';
  }
  
  // ‚úÖ SHOW SEARCH BAR
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'flex';
  }
  
  // ‚úÖ CLEAR ANY EXISTING INTERVALS
  if (window.patientRefreshInterval) {
    clearInterval(window.patientRefreshInterval);
    window.patientRefreshInterval = null;
  }
  
  console.log('‚úÖ Patient mode fully activated');
}



function selectPatient(patientId, patientData) {
  activePatientId = patientId;
  activateConversationArea(patientId, patientData);

  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'flex';

  const userInput = document.getElementById('userInput');
  if (userInput) {
    userInput.placeholder = `Type your message to ${patientData.name || 'patient'}...`;
  }

  loadConversationHistory(patientId);
  startConversationPolling(patientId);

  console.log('‚úÖ Conversation activated with patient:', patientId);
}

function activateConversationArea(patientId, patientData) {
  const chatWindow = document.getElementById('chatWindow');   // ‚úÖ fixed

  // Determine urgency display and color
  let urgencyColor = '#10b981'; // Green default
  let urgencyLabel = 'üü¢ Routine';

  if (patientData.urgency === 'red') {
    urgencyColor = '#ef4444';
    urgencyLabel = 'üî¥ Critical';
  } else if (patientData.urgency === 'blue') {
    urgencyColor = '#3b82f6';
    urgencyLabel = 'üîµ Priority';
  }

  chatWindow.innerHTML = `
    <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                border-left: 5px solid ${urgencyColor}">
      <div style="text-align: center; margin-bottom: 15px;">
        <div style="font-size: 3rem;">‚ùó</div>
      </div>
      <div style="text-align: center;">
        <h3 style="margin: 0 0 10px 0; color: #111827; font-size: 1.3rem; font-weight: bold;">
          ${patientData.name || 'Anonymous Patient'}
        </h3>
        <p style="margin: 5px 0; color: #6b7280; font-size: 1rem;">
          <strong>Age:</strong> ${patientData.age || 'N/A'} years
        </p>
        <p style="margin: 10px 0 0 0; font-size: 1.1rem; font-weight: 600; color: ${urgencyColor};">
          ${urgencyLabel}
        </p>
      </div>
    </div>

    <div id="conversationMessages" style="min-height: 300px;"></div>
  `;

  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.style.display = 'flex';

  const userInput = document.getElementById('userInput');
  if (userInput) {
    userInput.placeholder = `Type your message to ${patientData.name || 'patient'}...`;
  }

  // Hide top typing box and suggestions (now INSIDE function)
  const topTypingBoxEl = document.getElementById('topTypingBox');
  const suggestionsBoxEl = document.getElementById('suggestionsBox');
  if (topTypingBoxEl) topTypingBoxEl.classList.remove('active');
  if (suggestionsBoxEl) suggestionsBoxEl.classList.remove('active');

  loadConversationHistory(patientId);
  startConversationPolling(patientId);

  console.log('‚úÖ Conversation header rendered for patient:', patientId);
   }

async function loadConversationHistory(patientId) {
  const messagesContainer = document.getElementById('conversationMessages');
  if (!messagesContainer) return;
  
  messagesContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Loading conversation...</p>';
  
  try {
    if (!window.firebaseDB) {
      messagesContainer.innerHTML = '<p style="text-align: center; color: #dc2626;">Firebase not initialized</p>';
      return;
    }
    
    const { collection, query, where, orderBy, getDocs } = window.firestoreFunctions;
    const messagesRef = collection(window.firebaseDB, 'conversations');
    const q = query(
      messagesRef,
      where('patientRequestId', '==', patientId),
      orderBy('timestamp', 'asc')
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      messagesContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No messages yet. Start the conversation!</p>';
      return;
    }
    
    let html = '';
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      html += formatMessage(msg);
    });
    
    messagesContainer.innerHTML = html;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
  } catch (error) {
    console.error('‚ùó Error loading conversation:', error);
    messagesContainer.innerHTML = '<p style="text-align: center; color: #dc2626;">Error loading messages</p>';
  }
}

function formatMessage(msg) {
  const isDoctor = msg.sender === 'doctor';
  const bgColor = isDoctor ? '#2563eb' : 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
  const alignment = isDoctor ? 'right' : 'left';
  const marginStyle = isDoctor ? 'margin-left: auto;' : 'margin-right: auto;';
  
  return `
    <div style="max-width: 70%; ${marginStyle} padding: 12px 15px; border-radius: 15px; background: ${bgColor}; color: white; margin-bottom: 12px; text-align: ${alignment}; line-height: 1.4;">
      <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 3px;">${msg.senderName}</div>
      <div style="font-size: 0.95rem;">${msg.message}</div>
    </div>
  `;
}

function startConversationPolling(patientId) {
  // Clear existing interval
  if (conversationInterval) {
    clearInterval(conversationInterval);
  }
  
  // Poll for new messages every 3 seconds
  conversationInterval = setInterval(() => {
    if (activePatientId === patientId) {
      loadConversationHistory(patientId);
    }
  }, 3000);
}

// Cancel patient consultation
async function cancelPatient(patientId) {
  if (!confirm('‚ùå Cancel this patient consultation?\n\nThe patient will be notified.')) {
    return;
  }
  
  try {
    if (!window.firebaseDB) {
      alert('‚ùå Firebase not initialized');
      return;
    }
    
    const { doc, deleteDoc } = window.firestoreFunctions;
    const patientRef = doc(window.firebaseDB, 'patientRequests', patientId);
    await deleteDoc(patientRef);
    
    console.log('‚úÖ Patient consultation cancelled');
    alert('‚úÖ Patient consultation cancelled');
    
    // Reload patient list
    loadPatientList();
    
  } catch (error) {
    console.error('‚ùó Error cancelling patient:', error);
    alert('‚ùó Failed to cancel: ' + error.message);
  }
}

function updatePatientCountBadge(count) {
  const badge = document.getElementById('patientCountBadge');
  const btnText = document.getElementById('patientBtnText');
  
  // ‚úÖ CHECK IF ELEMENTS EXIST
  if (!badge || !btnText) {
    console.warn('‚ùå Badge elements not found');
    return;
  }
  
  // ‚úÖ ALWAYS SHOW BADGE IF COUNT > 0 (persistent notification)
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'flex';
    
    // ‚úÖ UPDATE TEXT ONLY IF LIST IS CLOSED
    if (!doctorListVisible) {
      btnText.textContent = `üì´ ${count} Patient${count > 1 ? 's' : ''} Waiting`;
    }
  } else {
    badge.style.display = 'none';
    if (!doctorListVisible) {
      btnText.textContent = 'üë§ Patient List';
    }
  }
}




// ========== END PHASE 3 ==========

// Toggle Settings Sub-menu
function toggleSettingsMenu() {
  const menu = document.getElementById('settingsSubMenu');
  if (menu.style.display === 'none') {
    menu.style.display = 'block';
  } else {
    menu.style.display = 'none';
  }
}


// ========== PHASE 4: PATIENT CONVERSATION INTERFACE ==========

let activePatientConversation = null;
let patientConversationInterval = null;

// Check for active patient request on page load
function checkActivePatientRequest() {
  const requestData = localStorage.getItem('activePatientRequest');
  if (requestData && localStorage.getItem('userMode') !== 'doctor') {
    const request = JSON.parse(requestData);
    showWaitingForDoctor(request);
    
    // Poll to check if doctor has responded
    startPatientRequestPolling(request.id);
  }
}

function showWaitingForDoctor(request) {
  const chatWindow = document.getElementById('chatWindow');
  
  let urgencyColor = '#10b981';
  if (request.urgency === 'red') urgencyColor = '#ef4444';
  if (request.urgency === 'blue') urgencyColor = '#3b82f6';
  
  chatWindow.innerHTML = `
    <div style="text-align: center; padding: 40px 20px;">
      <div style="font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite;">√¢¬è¬≥</div>
      <h2 style="color: #2563eb; margin-bottom: 15px;">Waiting for Doctor Response...</h2>
      <p style="color: #6b7280; font-size: 1rem; margin-bottom: 25px;">
        Your request has been sent to <strong>Dr. ${request.doctorName}</strong>
      </p>
      
      <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 12px; border-left: 5px solid ${urgencyColor}; margin-bottom: 20px;">
        <p style="color: #374151; margin: 0; font-size: 0.95rem;">
          <strong>Status:</strong> Pending<br>
          <strong>Urgency:</strong> ${request.urgency.toUpperCase()}<br>
          <strong>Estimated Wait:</strong> 5-15 minutes
        </p>
      </div>
      
      <p style="color: #9ca3af; font-size: 0.85rem;">
        Please stay on this page. You'll be notified when the doctor accepts your request.
      </p>
      
      <button onclick="cancelPatientRequest()" style="margin-top: 20px; padding: 12px 30px; background: #dc2626; color: white; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: 0.3s;">
        Cancel Request
      </button>
    </div>
  `;
  
  // Hide user input while waiting
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'none';
  }
}

function startPatientRequestPolling(requestId) {
  // Clear existing interval
  if (patientConversationInterval) {
    clearInterval(patientConversationInterval);
  }
  
  // Check every 3 seconds if conversation has started
  patientConversationInterval = setInterval(async () => {
    try {
      if (!window.firebaseDB) return;
      
      const { collection, query, where, getDocs } = window.firestoreFunctions;
      const convRef = collection(window.firebaseDB, 'conversations');
      const q = query(convRef, where('patientRequestId', '==', requestId));
      const snapshot = await getDocs(q);
      
      if (!snapshot.empty) {
        // Conversation started!
        clearInterval(patientConversationInterval);
        const requestData = JSON.parse(localStorage.getItem('activePatientRequest'));
        activatePatientConversation(requestId, requestData);
      }
      
    } catch (error) {
      console.error('Error checking conversation:', error);
    }
  }, 3000);
}

function activatePatientConversation(requestId, requestData) {
  const chatWindow = document.getElementById('chatWindow');
  activePatientConversation = requestId;
  
  let urgencyColor = '#10b981';
  if (requestData.urgency === 'red') urgencyColor = '#ef4444';
  if (requestData.urgency === 'blue') urgencyColor = '#3b82f6';
  
  chatWindow.innerHTML = `
    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid ${urgencyColor};">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h3 style="margin: 0; color: #111827; font-size: 1.2rem;">üå¨Ô∏è Dr. ${requestData.doctorName}</h3>
          <p style="margin: 5px 0 0 0; color: #1e40af; font-size: 0.9rem;">‚úÖ Doctor is now attending to you</p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="patientStartVideoCall()" style="background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
            üìπ Video
          </button>
          <button onclick="patientStartVoiceCall()" style="background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
           üìû Voice
          </button>
        </div>
      </div>
    </div>
    <div id="patientConversationMessages" style="min-height: 300px;"></div>
  `;
  
  // Show input for patient to reply
  const searchBar = document.querySelector('.search-bar');
  const userInput = document.getElementById('userInput');
  if (searchBar) {
    searchBar.style.display = 'flex';
  }
  if (userInput) {
    userInput.placeholder = 'Type your message to the doctor...';
  }
  
  // Load conversation
  loadPatientConversation(requestId);
  
  // Start polling for new messages
  startPatientConversationPolling(requestId);
  
  // Show notification
  showEmergencyModal('success', '‚úÖ Doctor Connected!', 'Dr. ' + requestData.doctorName + ' has accepted your consultation request. You can now chat with the doctor.');
}

async function loadPatientConversation(requestId) {
  const messagesContainer = document.getElementById('patientConversationMessages');
  if (!messagesContainer) return;
  
  try {
    if (!window.firebaseDB) {
      messagesContainer.innerHTML = '<p style="text-align: center; color: #dc2626;">Firebase not initialized</p>';
      return;
    }
    
    const { collection, query, where, orderBy, getDocs } = window.firestoreFunctions;
    const messagesRef = collection(window.firebaseDB, 'conversations');
    const q = query(
      messagesRef,
      where('patientRequestId', '==', requestId),
      orderBy('timestamp', 'asc')
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      messagesContainer.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Conversation started. Send a message!</p>';
      return;
    }
    
    let html = '';
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      html += formatPatientMessage(msg);
    });
    
    messagesContainer.innerHTML = html;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
  } catch (error) {
    console.error('‚ùó Error loading conversation:', error);
    messagesContainer.innerHTML = '<p style="text-align: center; color: #dc2626;">Error loading messages</p>';
  }
}

function formatPatientMessage(msg) {
  const isPatient = msg.sender === 'patient';
  const bgColor = isPatient ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : '#2563eb';
  const alignment = isPatient ? 'right' : 'left';
  const marginStyle = isPatient ? 'margin-left: auto;' : 'margin-right: auto;';
  
  return `
    <div style="max-width: 70%; ${marginStyle} padding: 12px 15px; border-radius: 15px; background: ${bgColor}; color: white; margin-bottom: 12px; text-align: ${alignment}; line-height: 1.4;">
      <div style="font-size: 0.75rem; opacity: 0.8; margin-bottom: 3px;">${msg.senderName}</div>
      <div style="font-size: 0.95rem;">${msg.message}</div>
    </div>
  `;
}

function startPatientConversationPolling(requestId) {
  // Clear existing
  if (patientConversationInterval) {
    clearInterval(patientConversationInterval);
  }
  
  // Poll every 3 seconds
  patientConversationInterval = setInterval(() => {
    if (activePatientConversation === requestId) {
      loadPatientConversation(requestId);
    }
  }, 3000);
}

function cancelPatientRequest() {
  if (!confirm('Cancel your consultation request?')) {
    return;
  }
  
  // Clear intervals
  if (patientConversationInterval) {
    clearInterval(patientConversationInterval);
  }
  
  // Clear storage
  localStorage.removeItem('activePatientRequest');
  activePatientConversation = null;
  
  // Reload page
  location.reload();
}

// ============================================
// ‚úÖ FIXED PATIENT CALL FUNCTIONS (Replace old versions)
// ============================================

// ============================================
// ‚úÖ PATIENT-INITIATED CALLS
// ============================================

// Patient starts VIDEO call
async function patientStartVideoCall() {
  const requestData = JSON.parse(localStorage.getItem('activePatientRequest') || sessionStorage.getItem('activeRequestId'));
  
  if (!requestData) {
    alert("‚ùå Error: No active consultation found.");
    return;
  }

  try {
    console.log("Patient starting video call...");

    // Check if PeerJS is ready
    if (!peer || !peer.id) {
      alert("‚ö†Ô∏è Connection establishing... please try again in a moment.");
      return;
    }

    // Get local stream (Video + Audio)
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });

    // Show calling UI
    showCallingUI("Doctor", "video");

    console.log("üìû Patient ready to receive call from doctor");

  } catch (err) {
    console.error("Call failed:", err);
    alert("‚ùå Call failed: " + err.message);
  }
}

// Patient starts VOICE call
async function patientStartVoiceCall() {
  const requestData = JSON.parse(localStorage.getItem('activePatientRequest') || sessionStorage.getItem('activeRequestId'));
  
  if (!requestData) {
    alert("‚ùå Error: No active consultation found.");
    return;
  }

  try {
    console.log("Patient starting voice call...");

    // Check PeerJS
    if (!peer || !peer.id) {
      alert("‚ö†Ô∏è Connection establishing... please try again.");
      return;
    }

    // Get local stream (Audio Only)
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

    // Show calling UI
    showCallingUI("Doctor", "voice");

    console.log("üìû Patient ready to receive call from doctor");

  } catch (err) {
    console.error("Call failed:", err);
    alert("‚ùå Call failed: " + err.message);
  }
}


// 3. Helper to handle UI when YOU start a call
function handleOutgoingCall(call, type, name) {
    currentCall = call;
    showCallingUI(name, type); // Reuses your existing UI function
    
    call.on('stream', (remoteStream) => {
        handleRemoteStream(remoteStream, type); // Reuses your existing stream handler
    });
    
    call.on('close', () => endCall());
    call.on('error', (err) => {
        console.error("PeerJS Call Error:", err);
        endCall();
    });
}


// ========== END PHASE 4 ==========


// Placeholder function - hospitals loaded from backend API instead of Firebase
function loadHospitalsFromFirebase() {
  console.log('‚ÑπÔ∏è Hospitals are loaded from backend /api/emergency');
}



 // ========== PAGE LOAD INITIALIZATION ==========
window.addEventListener('load', async () => {
  console.log('√∞≈∏≈°‚Ç¨ Page loaded');
  
  // ‚úÖ CHECK FIREBASE AUTH STATE FIRST
  const { onAuthStateChanged } = window.authFunctions;
  
  onAuthStateChanged(window.firebaseAuth, async (user) => {
    if (user) {
      // User is logged in
      console.log('‚úÖ User authenticated:', user.uid);

      // ‚úÖ INITIALIZE PEERJS
    initializePeerJS(user.uid);
    
    // ‚úÖ LISTEN FOR CALL INVITATIONS
    listenForCallInvitations();
      
      // Check if user is doctor or patient
      const userMode = await checkUserRole(user.uid);
      
      if (userMode === 'doctor') {
        // Initialize doctor mode
        const doctorData = await getDoctorData(user.uid);
        if (doctorData) {
          localStorage.setItem('activeDoctorSession', JSON.stringify(doctorData));
          localStorage.setItem('userMode', 'doctor');
          initializeDoctorMode();
        }
      } else if (userMode === 'patient') {
        // Initialize patient mode
        localStorage.setItem('userMode', 'patient');
        initializePatientMode();
      }
    } else {
      // No user logged in - show role modal
      console.log('‚ùó No user authenticated');
      
      // Check for existing session (doctor only - they use custom auth)
      const doctorSession = localStorage.getItem('activeDoctorSession');
      const userMode = localStorage.getItem('userMode');
      
      if (userMode === 'doctor' && doctorSession) {
        console.log('‚úÖ Doctor session restored');
        initializeDoctorMode();
      } else if (userMode === 'guest') {
        console.log('‚úÖ Guest mode active');
        initializePatientMode();
      } else {
        // First visit - show role selection
        document.getElementById('roleModal').style.display = 'flex';
      }
    }
  });
  
  // Load hospitals
  loadHospitalsFromFirebase();
});

// ‚úÖ CHECK USER ROLE (doctor or patient)
async function checkUserRole(userId) {
  try {
    const { collection, query, where, getDocs } = window.firestoreFunctions;
    
    // Check if user is a doctor
    const doctorQuery = query(
      collection(window.firebaseDB, 'doctors'),
      where('userId', '==', userId)
    );
    const doctorSnapshot = await getDocs(doctorQuery);
    
    if (!doctorSnapshot.empty) {
      return 'doctor';
    }
    
    // Check if user is a patient
    const patientQuery = query(
      collection(window.firebaseDB, 'patients'),
      where('userId', '==', userId)
    );
    const patientSnapshot = await getDocs(patientQuery);
    
    if (!patientSnapshot.empty) {
      return 'patient';
    }
    
    return null;
    
  } catch (error) {
    console.error('‚ùó Error checking user role:', error);
    return null;
  }
}

// ‚úÖ GET DOCTOR DATA BY USER ID
async function getDoctorData(userId) {
  try {
    const { collection, query, where, getDocs } = window.firestoreFunctions;
    
    const q = query(
      collection(window.firebaseDB, 'doctors'),
      where('userId', '==', userId)
    );
    
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      const doc = snapshot.docs[0];
      return {
        id: doc.id,
        userId: userId,
        ...doc.data()
      };
    }
    
    return null;
    
  } catch (error) {
    console.error('‚ùó Error getting doctor data:', error);
    return null;
  }
}

</script>



<script>
// Toggle rightbar on mobile
function toggleSuggestions() {
  const rightbar = document.querySelector('.rightbar');
  rightbar.classList.toggle('mobile-active');
}

// Close rightbar when clicking outside (optional)
document.addEventListener('click', function(e) {
  if (window.innerWidth <= 768) {
    const rightbar = document.querySelector('.rightbar');
    const toggleBtn = document.querySelector('.suggestions-toggle-btn');
    if (!rightbar.contains(e.target) && e.target !== toggleBtn) {
      rightbar.classList.remove('mobile-active');
    }
  }
});

// ========== DOCTOR AUTHENTICATION SYSTEM ==========

let currentDoctor = null; // Store logged-in doctor data

// Check if doctor is already logged in (session storage)
function checkDoctorSession() {
  // Check sessionStorage first
  let doctorSession = sessionStorage.getItem('doctorSession');
  
  // If not in sessionStorage, check localStorage
  if (!doctorSession) {
    doctorSession = localStorage.getItem('activeDoctorSession');
  }
  
  if (doctorSession) {
    currentDoctor = JSON.parse(doctorSession);
    console.log('‚úÖ Doctor session found:', currentDoctor.name);
    return true;
  }
  return false;
}

// Show role selection modal on first visit
function showRoleModalOnFirstVisit() {
  const hasVisited = localStorage.getItem('hasVisited');
  const hasSession = checkDoctorSession();
  
  if (!hasVisited && !hasSession) {
    setTimeout(() => {
      document.getElementById('roleModal').style.display = 'flex';
    }, 1000); // Show after 1 second
    localStorage.setItem('hasVisited', 'true');
  }
}

// Continue as guest (no login)
function continueAsGuest() {
  document.getElementById('roleModal').style.display = 'none';
  localStorage.setItem('userMode', 'guest');
  initializePatientMode();
  console.log('‚úÖ Guest mode active');
}


// Show doctor registration form
function showDoctorRegister() {
  document.getElementById('roleModal').style.display = 'none';
  document.getElementById('doctorLoginModal').style.display = 'none';
  document.getElementById('doctorRegModal').style.display = 'flex';
}

// Close doctor registration
function closeDoctorRegister() {
  document.getElementById('doctorRegModal').style.display = 'none';
  document.getElementById('doctorRegForm').reset();
}

// Show doctor login modal
function showDoctorLogin() {
  document.getElementById('roleModal').style.display = 'none';
  document.getElementById('doctorRegModal').style.display = 'none';
  document.getElementById('doctorLoginModal').style.display = 'flex';
}

// Close doctor login
function closeDoctorLogin() {
  document.getElementById('doctorLoginModal').style.display = 'none';
  document.getElementById('doctorLoginForm').reset();
}

// ‚úÖ DOCTOR REGISTRATION WITH FIREBASE AUTH
async function registerDoctor(event) {
  event.preventDefault();
  
  const name = document.getElementById('docName').value.trim();
  const email = document.getElementById('docEmail').value.trim();
  const password = document.getElementById('docPassword').value;
  const specialty = document.getElementById('docSpecialty').value;
  const phone = document.getElementById('docPhone').value.trim();
  const license = document.getElementById('docLicense').value.trim();
  
  // Show loading
  document.getElementById('regBtnText').style.display = 'none';
  document.getElementById('regBtnLoader').style.display = 'inline';
  
  try {
    // ‚úÖ Create Firebase Auth account
    const { createUserWithEmailAndPassword } = window.authFunctions;
    const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
    const user = userCredential.user;
    
    // ‚úÖ Save doctor data to Firestore
    const { collection, addDoc, serverTimestamp } = window.firestoreFunctions;
    const docRef = await addDoc(collection(window.firebaseDB, 'doctors'), {
      userId: user.uid,  // ‚úÖ Link to Firebase Auth
      name: name,
      email: email,
      specialty: specialty,
      phone: phone,
      license: license,
      status: 'available',
      registeredAt: serverTimestamp(),
      verified: false,  // Admin must verify
      role: 'doctor'
    });
    
    console.log('‚úÖ Doctor registered:', docRef.id);
    alert('‚úÖ Registration successful! You are now logged in.');
    
    // Save session and initialize
    const doctorData = {
      id: docRef.id,
      userId: user.uid,
      name: name,
      email: email,
      specialty: specialty,
      phone: phone,
      license: license,
      status: 'available'
    };
    
    localStorage.setItem('activeDoctorSession', JSON.stringify(doctorData));
    localStorage.setItem('userMode', 'doctor');
    
    // Close modal and initialize doctor mode
    closeDoctorRegister();
    initializeDoctorMode();
    
  } catch (error) {
    console.error('‚ùó Registration error:', error);
    
    if (error.code === 'auth/email-already-in-use') {
      alert('‚ùó This email is already registered. Please login instead.');
    } else if (error.code === 'auth/weak-password') {
      alert('‚ùó Password should be at least 6 characters.');
    } else {
      alert('‚ùó Registration failed: ' + error.message);
    }
  } finally {
    // Hide loading
    document.getElementById('regBtnText').style.display = 'inline';
    document.getElementById('regBtnLoader').style.display = 'none';
  }
}


// ‚úÖ DOCTOR LOGIN WITH FIREBASE AUTH
async function loginDoctor(event) {
  event.preventDefault();
  
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  
  // Show loading
  document.getElementById('loginBtnText').style.display = 'none';
  document.getElementById('loginBtnLoader').style.display = 'inline';
  
  try {
    // ‚úÖ Sign in with Firebase Auth
    const { signInWithEmailAndPassword } = window.authFunctions;
    const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
    const user = userCredential.user;
    
    // ‚úÖ Get doctor data from Firestore
    const doctorData = await getDoctorData(user.uid);
    
    if (!doctorData) {
      alert('‚ùó No doctor account found. Please register first.');
      await window.authFunctions.signOut(window.firebaseAuth);
      return;
    }
    
   console.log('‚úÖ Doctor logged in:', doctorData.id);
alert('‚úÖ Welcome back, Dr. ' + doctorData.name + '!');

// ‚úÖ FIX: Save to BOTH localStorage AND sessionStorage with correct keys
localStorage.setItem('activeDoctorSession', JSON.stringify(doctorData));
localStorage.setItem('userMode', 'doctor');

// ‚úÖ ADD THESE LINES:
sessionStorage.setItem('doctorSession', JSON.stringify(doctorData));
currentDoctor = doctorData;  // Set the global variable
console.log('‚úÖ currentDoctor set:', currentDoctor);

// Close modal and initialize
closeDoctorLogin();
initializeDoctorMode();

    
  } catch (error) {
    console.error('‚ùó Login error:', error);
    
    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
      alert('‚ùó Invalid email or password.');
    } else if (error.code === 'auth/invalid-credential') {
      alert('‚ùó Invalid credentials. Please check your email and password.');
    } else {
      alert('‚ùó Login failed: ' + error.message);
    }
  } finally {
    // Hide loading
    document.getElementById('loginBtnText').style.display = 'inline';
    document.getElementById('loginBtnLoader').style.display = 'none';
  }
}




// ========== DOCTOR MODE INTERFACE ==========

function switchToDoctorMode(doctorData) {
  // Store doctor mode flag
  localStorage.setItem('userMode', 'doctor');
  localStorage.setItem('activeDoctorSession', JSON.stringify(doctorData));
  
  // Hide emergency button permanently for doctors
  const emergencyBtn = document.querySelector('.emergency');
  if (emergencyBtn) {
    emergencyBtn.style.display = 'none';
  }
  
  // Change "Connect to Doctors" to "Patient List"
  const connectBtn = document.getElementById('connectDoctorBtn');
  if (connectBtn) {
    connectBtn.textContent = 'üë§ Patient List';
    connectBtn.onclick = togglePatientList; // New function
  }
  
  // Transform chatbot area to patient conversation area
  initializeDoctorChatArea();
  
  // Hide location setup for doctors
  const hospitalSection = document.querySelector('.hospital-section');
  if (hospitalSection) {
    hospitalSection.style.display = 'none';
  }
   // Hide patient buttons, show doctor buttons
  const patientBtn = document.getElementById('patientActionBtn');
  const videoBtn = document.getElementById('doctorVideoBtn');
  const voiceBtn = document.getElementById('doctorVoiceBtn');
  
  if (patientBtn) patientBtn.style.display = 'none';
  if (videoBtn) videoBtn.style.display = 'flex';
  if (voiceBtn) voiceBtn.style.display = 'flex';
  
  console.log('‚úÖ Switched to Doctor Mode');
}

// Initialize Doctor Chat Area with Welcome Message
function initializeDoctorChatArea() {
  console.log('‚úÖ Doctor chat area initialized');
  
  const chatWindow = document.getElementById('chatWindow');
  if (!chatWindow) return;
  
  // ‚úÖ Get patient count
  const patientCount = document.querySelectorAll('.doctor-card').length || 0;
  
  // ‚úÖ Show welcome banner with patient count
  chatWindow.innerHTML = `
    <div class="bot-msg" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white;">
      <strong>ü§ùWelcome, Dr. ${currentDoctor?.name || 'Doctor'}!</strong><br>
      Ready to help patients today.<br>
      <span style="font-size: 1.1rem; font-weight: bold;">‚ñ∂Ô∏è ${patientCount} patient(s) waiting</span>
    </div>
    <div class="bot-msg">
     ü§ù Hello Doctor! While you wait for patients, feel free to ask me any medical questions or use me to research symptoms and conditions.
    </div>
  `;
  
  // ‚úÖ IMPORTANT: Make sure search bar is visible and working
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'flex';
  }
  
  console.log(`‚úÖ Doctor chat area initialized (${patientCount} patients waiting)`);
}


// Global flag to track visibility
let patientListVisible = false;
let doctorListVisible = false;

// Toggle Patient List (Doctor Mode) / Doctor List (Patient Mode)
function togglePatientList() {
  const container = document.getElementById('doctorListContainer');
  const btn = document.getElementById('connectDoctorBtn');
  const btnText = document.getElementById('patientBtnText');
  const badge = document.getElementById('patientCountBadge');
  
  if (!container) {
    console.error('‚ùó doctorListContainer not found');
    return;
  }
  
  if (!btn) {
    console.error('‚ùó connectDoctorBtn not found');
    return;
  }
  
  // Check if we're in doctor mode or patient mode
  const isDoctor = (localStorage.getItem('userMode') === 'doctor');
  
  if (isDoctor) {
    // DOCTOR MODE - Toggle Patient List
    if (!patientListVisible) {
      // OPEN patient list
      container.classList.add('expanded');
      if (btnText) btnText.textContent = '‚ùå Close Patient List';
      loadPatientList(); // Load patients
      patientListVisible = true;
    } else {
      // CLOSE patient list
      container.classList.remove('expanded');
      if (btnText) btnText.textContent = 'üë§ Patient List';
      patientListVisible = false;
    }
  } else {
    // PATIENT MODE - Toggle Doctor List
    if (!doctorListVisible) {
      // OPEN doctor list
      container.classList.add('expanded');
      if (btnText) btnText.textContent = '‚ùå Close Doctor List';
      loadRealDoctors(); // Load doctors
      doctorListVisible = true;
    } else {
      // CLOSE doctor list
      container.classList.remove('expanded');
      if (btnText) btnText.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctor';
      doctorListVisible = false;
    }
  }
}


// Load Patient List (Doctor Mode)
async function loadPatientList() {
  console.log('‚åõ Loading patient list...');
  
  // ‚úÖ PREVENT MULTIPLE SIMULTANEOUS LOADS
  if (window.isLoadingPatients) {
    console.log('üü¢Already loading patients, skipping...');
    return;
  }
  
  window.isLoadingPatients = true;
  
  // ‚úÖ FIND THE CONTAINER
  const doctorList = document.getElementById('doctorList');
  
  if (!doctorList) {
    console.error('‚ùó doctorList element not found in loadPatientList');
    window.isLoadingPatients = false;
    return; // ‚úÖ EXIT EARLY - DON'T CONTINUE
  }
  
  doctorList.innerHTML = '<p class="loading-doctors">‚è≥ Loading patients...</p>';
  
  try {
    if (!window.firebaseDB) {
      doctorList.innerHTML = '<p class="loading-doctors">‚ùó Firebase not initialized</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    if (!currentDoctor || !currentDoctor.id) {
      doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùó Doctor session not found</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    const { collection, getDocs, query, where } = window.firestoreFunctions;
    const requestsRef = collection(window.firebaseDB, 'patientRequests');
    const q = query(
      requestsRef,
      where('doctorId', '==', currentDoctor.id),
      where('status', '==', 'pending')
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‚ñ∂Ô∏è¬≠ No patients waiting</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    const patients = [];
    querySnapshot.forEach((doc) => {
      patients.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`‚úÖ Loaded ${patients.length} patient(s)`);
    displayPatients(patients);
    
  } catch (error) {
    console.error('‚ùó Error loading patients:', error);
    if (doctorList) {
      doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùå Error loading patients</p>';
    }
  } finally {
    window.isLoadingPatients = false;
  }
}


// Toggle Doctor List (for patients)
function toggleDoctorList() {
  const container = document.getElementById('doctorListContainer');
  const btn = document.getElementById('connectDoctorBtn');
  const btnText = document.getElementById('patientBtnText');
  
  if (!container || !btn) {
    console.error('‚ùó Doctor list container or button not found');
    return;
  }
  
  if (!doctorListVisible) {
    // Open doctor list
    container.classList.add('expanded');
    if (btnText) {
      btnText.textContent = '‚ùå Close Doctor List';
    } else {
      btn.textContent = '‚ùå Close Doctor List';
    }
    loadRealDoctors(); // Load doctors when opening
    doctorListVisible = true;
  } else {
    // Close doctor list
    container.classList.remove('expanded');
    if (btnText) {
      btnText.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctor';
    } else {
      btn.textContent = 'üë®‚Äç‚öïÔ∏è Connect to Doctor';
    }
    doctorListVisible = false;
  }
}




// Load Patient List (Doctor Mode)
async function loadPatientList() {
  console.log('‚åõ Loading patient list...');
  
  // Prevent multiple loads
  if (window.isLoadingPatients) {
    console.log('üü¢ Already loading patients, skipping...');
    return;
  }
  
  window.isLoadingPatients = true;
  
  const doctorList = document.getElementById('doctorList');
  
  if (!doctorList) {
    console.error('‚ùó doctorList element not found');
    window.isLoadingPatients = false;
    return;
  }
  
  doctorList.innerHTML = '<p class="loading-doctors">‚è≥ Loading patients...</p>';
  
  try {
    if (!window.firebaseDB) {
      doctorList.innerHTML = '<p class="loading-doctors">‚ùó Firebase not initialized</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    if (!currentDoctor || !currentDoctor.id) {
      doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùó Doctor session not found</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    const { collection, getDocs, query, where } = window.firestoreFunctions;
    const requestsRef = collection(window.firebaseDB, 'patientRequests');
    const q = query(
      requestsRef,
      where('doctorId', '==', currentDoctor.id),
      where('status', '==', 'pending')
    );
    
    const querySnapshot = await getDocs(q);
    
    if (querySnapshot.empty) {
      doctorList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">üì™¬≠ No patients waiting</p>';
      window.isLoadingPatients = false;
      return;
    }
    
    const patients = [];
    querySnapshot.forEach((doc) => {
      patients.push({ id: doc.id, ...doc.data() });
    });
    
    console.log(`‚úÖ Loaded ${patients.length} patient(s)`);
    displayPatients(patients);
    
  } catch (error) {
    console.error('‚ùó Error loading patients:', error);
    if (doctorList) {
      doctorList.innerHTML = '<p style="text-align: center; color: #dc2626;">‚ùó Error loading patients</p>';
    }
  } finally {
    window.isLoadingPatients = false;
  }
}



function selectPatient(patientId, patientData) {
  // Set active patient
  activePatientId = patientId;

  // Build header + buttons + messages container
  activateConversationArea(patientId, patientData);

  // Show search bar
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) {
    searchBar.style.display = 'flex';
  }

  // Set placeholder
  const userInput = document.getElementById('userInput');
  if (userInput) {
    userInput.placeholder = `Type your message to ${patientData.name || 'patient'}...`;
  }

  // Load past messages and start polling
  loadConversationHistory(patientId);
  startConversationPolling(patientId);

  console.log('‚úÖ Conversation activated with patient:', patientId);
}

// ========== END DOCTOR MODE INTERFACE ==========



// Open doctor dashboard
function openDoctorDashboard() {
  if (!currentDoctor) {
    showDoctorLogin();
    return;
  }
  
  // Populate dashboard
  document.getElementById('dashboardName').textContent = currentDoctor.name;
  document.getElementById('dashboardSpecialty').textContent = currentDoctor.specialty;
  document.getElementById('dashboardEmail').textContent = currentDoctor.email;
  document.getElementById('doctorStatusSelect').value = currentDoctor.status;
  
  document.getElementById('doctorDashboard').style.display = 'flex';
}

// Close doctor dashboard
function closeDoctorDashboard() {
  document.getElementById('doctorDashboard').style.display = 'none';
}
async function updateDoctorSpecialty() {
  const newSpecialty = document.getElementById('profileSpecialty').value;
  
  if (!window.currentDoctor || !window.currentDoctor.id) return;

  if(!confirm(`Change specialty to ${newSpecialty}?`)) {
      // Revert if cancelled
      document.getElementById('profileSpecialty').value = window.currentDoctor.specialty;
      return;
  }

  try {
    const { doc, updateDoc } = window.firestoreFunctions;
    const doctorRef = doc(window.firebaseDB, "doctors", window.currentDoctor.id);

    await updateDoc(doctorRef, { specialty: newSpecialty });

    // Update local data
    window.currentDoctor.specialty = newSpecialty;
    localStorage.setItem('activeDoctorSession', JSON.stringify(window.currentDoctor));
    
    alert("Specialty updated successfully!");
  } catch (error) {
    console.error("Error:", error);
    alert("Failed to update specialty.");
  }
}



// Update doctor status in Firebase
// ‚úÖ Corrected: Update Doctor Status (Fixes the "reverting" bug)
async function updateDoctorStatus(newStatus) {
  // If no status passed, try to get it from the dropdown
  if (!newStatus) {
      newStatus = document.getElementById('doctorStatusSelect').value;
  }

  // Check for doctor session (supports both global var and localStorage)
  let docData = window.currentDoctor;
  if (!docData) {
      try {
          docData = JSON.parse(localStorage.getItem('activeDoctorSession'));
      } catch(e) {}
  }

  if (!docData || !docData.id) {
    alert('‚ùó Error: Doctor session not active. Please login again.');
    return;
  }

  try {
    const { doc, updateDoc } = window.firestoreFunctions;
    const doctorRef = doc(window.firebaseDB, 'doctors', docData.id);
    // 1. Update in Firebase
    await updateDoc(doctorRef, { 
      status: newStatus 
    });

    // 2. Update Global Variable
    if (window.currentDoctor) {
        window.currentDoctor.status = newStatus;
    }

    // 3. Update LocalStorage (Crucial! This saves it for page reloads)
    // We update 'docData' with the new status and save it back
    docData.status = newStatus;
    localStorage.setItem('activeDoctorSession', JSON.stringify(docData));
    
    // 4. Also update sessionStorage just in case legacy code uses it
    sessionStorage.setItem('doctorSession', JSON.stringify(docData));

    console.log(`‚úÖ Status successfully changed to: ${newStatus}`);
    
    // Optional: Only show alert if it's an error, otherwise just let it change smoothly
    // alert('Status updated!'); 

  } catch (error) {
    console.error("‚ùó Status update failed:", error);
    alert("Failed to update status. Please check your internet connection.");
    
    // If it failed, revert the dropdown to the old status
    document.getElementById('doctorStatusSelect').value = docData.status;
  }
}



// Update toggleDoctorList to use real doctors
function toggleDoctorList() {
  const container = document.getElementById('doctorListContainer');
  const btn = document.getElementById('connectDoctorBtn');
  
  if (!doctorListVisible) {
    container.classList.add('expanded');
    btn.textContent = '‚ùå Close Doctor List';
    loadRealDoctors(); // √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Load real doctors from database
    doctorListVisible = true;
  } else {
    container.classList.remove('expanded');
    btn.textContent = 'üë®‚Äç‚öïÔ∏èConnect to Doctors';
    doctorListVisible = false;
  }
}



// ========== BRAIN HEALTH GALLERY FEATURE ==========

function toggleGallery() {
  const panel = document.getElementById('galleryPanel');
  const sidebar = document.getElementById('sidebar');
  const historyPanel = document.getElementById('chatHistoryPanel');
  
  if (panel.classList.contains('open')) {
    panel.classList.remove('open');
  } else {
    panel.classList.add('open');
    sidebar.classList.remove('open');
    historyPanel.classList.remove('open');
  }
}

function closeGallery() {
  const panel = document.getElementById('galleryPanel');
  panel.classList.remove('open');
}

function showImageInfo(title, description) {
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  `;

  overlay.innerHTML = `
    <div style=" background : white ; padding : 30px ; border-radius : 15px ; max-width : 500px ; box-shadow : 0 10px 40px rgba(0,0,0,0.3) ; " >
      <h3 style=" color : #2563eb ; margin-bottom : 15px ; font-size : 1.3rem ; " >${title}</h3>
      <p style=" color : #666 ; font-size : 1rem ; line-height : 1.6 ; margin-bottom : 20px ; ">${description}</p>
      <button onclick=" this.parentElement.parentElement.remove ()"
              style="background: #2563eb; color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;">
        Close
      </button>
    </div>
  `; 

  document.body.appendChild(overlay);

  overlay.addEventListener('click', function(e) {
    if (e.target === overlay) {
      overlay.remove();
    }
  });
}


// Update toggleMenu to also close gallery
function toggleMenu() {
  const sidebar = document.getElementById("sidebar");
  const historyPanel = document.getElementById("chatHistoryPanel");
  const galleryPanel = document.getElementById("galleryPanel");
  
  sidebar.classList.toggle("open");
  
  // Auto-close both panels when sidebar closes
  if (!sidebar.classList.contains("open")) {
    historyPanel.classList.remove("open");
    galleryPanel.classList.remove("open");
  }
}

// ‚úÖ FORCE CACHE CLEAR - ADD THIS
console.log('√∞≈∏‚Äù‚Äû Script version: 2.0 - ' + new Date().toISOString());

// Verify functions exist
console.log('‚úÖ Functions loaded:', {
  startDoctorChat: typeof startDoctorChat,
  sendDoctorMessage: typeof sendDoctorMessage,
  loadPatientList: typeof loadPatientList
});

// Function to handle the Login/Logout button click
function handleAuthClick() {
  const user = window.firebaseAuth.currentUser;
  
  if (user) {
    // If user is logged in -> Ask to Logout
    if (confirm("Are you sure you want to logout?")) {
      logoutUser(); // This calls your unified logout function
    }
  } else {
    // If user is NOT logged in -> Show Login Options
    // This opens the "Doctor, Patient, or Guest" choice modal
    const roleModal = document.getElementById('roleModal');
    if (roleModal) {
      roleModal.style.display = 'flex';
    } else {
      console.error("Error: roleModal not found!");
    }
  }
}

// Unified Logout Function (if you don't have it yet)
async function logoutUser() {
  try {
    await window.authFunctions.signOut(window.firebaseAuth);
    localStorage.removeItem('userMode'); // Clear role
    
    // Reset UI immediately
    location.reload(); 
  } catch (error) {
    console.error("Logout failed:", error);
    alert("Logout failed. Please try again.");
  }
}

// PUT THIS INSIDE YOUR EXISTING onAuthStateChanged BLOCK
// usually at the very bottom of your script
// ‚úÖ NO IMPORT STATEMENT HERE!

// ‚úÖ SAFE AUTH LISTENER (Waits for Firebase to load)
const authCheckInterval = setInterval(() => {
  if (window.authFunctions && window.authFunctions.onAuthStateChanged) {
    clearInterval(authCheckInterval); // Stop checking
    
    // Now it is safe to call
    window.authFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
      const profileBtn = document.getElementById('myProfileBtn');
      const authBtn = document.getElementById('authBtn');
      
      if (user) {
        // Logged In
        if (profileBtn) profileBtn.style.display = 'block'; 
        if (authBtn) {
          authBtn.innerHTML = 'üö™ Logout';
          authBtn.style.color = '#dc2626';
        }
      } else {
        // Guest
        if (profileBtn) profileBtn.style.display = 'none';
        if (authBtn) {
          authBtn.innerHTML = 'üîê Login';
          authBtn.style.color = '#333';
        }
      }
    });
  }
}, 100); // Check every 100ms


// Show About Modal
function showAboutModal() {
  const modal = document.getElementById('aboutModal');
  if (modal) {
    modal.style.display = 'block';
  } else {
    console.error("About Modal not found!");
  }
}

// Close About Modal
function closeAbout() {
  const modal = document.getElementById('aboutModal');
  if (modal) {
    modal.style.display = 'none';
  }
}




// ‚úÖ CORRECTED: Open Profile Modal Function
async function openUserProfile() {
  const modal = document.getElementById('userProfileModal');
  
  // 1. Safety Check: Does the modal exist in HTML?
  if (!modal) {
      console.error("‚ùå Error: 'userProfileModal' not found in HTML!");
      alert("Profile modal is missing from the page code. Please check index.html");
      return;
  }

  const userMode = localStorage.getItem('userMode');
  const user = window.firebaseAuth.currentUser;
  
  // 2. Get UI Elements
  const nameEl = document.getElementById('profileName');
  const emailEl = document.getElementById('profileEmail');
  const roleEl = document.getElementById('profileRoleBadge');
  const docDetails = document.getElementById('doctorProfileDetails'); // This is the new section

  // 3. Logic for PATIENTS / GUESTS
  if (userMode === 'patient' || userMode === 'guest') {
    if (nameEl) nameEl.textContent = user ? (user.displayName || "Patient") : "Guest User";
    if (emailEl) emailEl.textContent = user ? user.email : "Not logged in";
    if (roleEl) roleEl.textContent = "Patient";
    
    // Hide doctor-specific fields
    if (docDetails) docDetails.style.display = 'none';
  } 
  
  // 4. Logic for DOCTORS
  else if (userMode === 'doctor') {
    // Get latest doctor data
    let docData = window.currentDoctor;
    
    // Fallback: Try to get from storage if global var is empty
    if (!docData) {
        try {
            docData = JSON.parse(localStorage.getItem('activeDoctorSession'));
        } catch(e) {
            console.log("No doctor session found in storage");
        }
    }

    if (docData) {
      if (nameEl) nameEl.textContent = docData.name;
      if (emailEl) emailEl.textContent = docData.email;
      if (roleEl) roleEl.textContent = "Doctor";
      
      // SHOW DOCTOR FIELDS (ID, Phone, Specialty)
      if (docDetails) {
          docDetails.style.display = 'block';
          
          // Fill the inputs safely
          if(document.getElementById('profileDocId')) 
             document.getElementById('profileDocId').value = docData.id || "N/A";
             
          if(document.getElementById('profilePhone')) 
             document.getElementById('profilePhone').value = docData.phone || "N/A";
             
          if(document.getElementById('profileSpecialty')) 
             document.getElementById('profileSpecialty').value = docData.specialty || "General";
             
          if(document.getElementById('doctorStatusSelect')) 
             document.getElementById('doctorStatusSelect').value = docData.status || "available";
      }
    }
  }

  // 5. Finally, show the modal
  modal.style.display = 'flex';
}

// ‚úÖ Close Function (Keep this separate)
function closeUserProfile() {
  const modal = document.getElementById('userProfileModal');
  if (modal) modal.style.display = 'none';
}


async function setupDoctorProfile(uid) {
  document.getElementById('doctorFields').style.display = 'block';
  document.getElementById('patientFields').style.display = 'none';
  
  try {
    const { doc, getDoc } = window.firestoreFunctions;
    const docSnap = await getDoc(doc(window.firebaseDB, 'doctors', uid));
    
    if (docSnap.exists()) {
      const data = docSnap.data();
      document.getElementById('profileName').textContent = data.name;
      document.getElementById('profileExperience').textContent = (data.experience || '--') + ' Years';
      
      // SPECIALTY EDITING FEATURE
      const specialtyContainer = document.getElementById('profileSpecialty');
      specialtyContainer.innerHTML = `
        <input type="text" id="editSpecialtyInput" value="${data.specialty}" 
         style="border: 1px solid #ccc; padding: 5px; width: 120px; border-radius: 5px;">
        <button onclick="saveSpecialty('${uid}')" style="background:#2563eb; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">üíæ Save</button>
      `;
      
      document.getElementById('doctorStatusSelect').value = data.status || 'available';
    }
  } catch (e) { console.error(e); }
}

// Function to Save New Specialty
async function saveSpecialty(uid) {
    const newSpec = document.getElementById('editSpecialtyInput').value;
    try {
        const { doc, updateDoc } = window.firestoreFunctions;
        await updateDoc(doc(window.firebaseDB, 'doctors', uid), {
            specialty: newSpec
        });
        alert("Specialty Updated!");
    } catch(e) {
        alert("Update failed");
    }
}


async function setupPatientProfile(uid) {
  // Show Patient Fields, Hide Doctor Fields
  document.getElementById('doctorFields').style.display = 'none';
  document.getElementById('patientFields').style.display = 'block';
  
  // Set Role Badge
  const roleLabel = document.getElementById('profileRole');
  if (roleLabel) roleLabel.textContent = 'Patient';

  try {
    const { collection, query, where, getDocs } = window.firestoreFunctions;
    
    // Query the 'patients' collection for this user ID
    const q = query(collection(window.firebaseDB, 'patients'), where('userId', '==', uid));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
      const data = querySnapshot.docs[0].data();
      
      // Fill the HTML fields
      const nameEl = document.getElementById('profileName');
      const ageEl = document.getElementById('profileAge'); // Ensure you have this ID in your HTML
      
      if (nameEl) nameEl.textContent = data.name || 'Anonymous';
      if (ageEl) ageEl.textContent = (data.age || '--') + ' Years Old';
      
    } else {
      console.log("No patient profile found in Firestore.");
      // Fallback: Use Email nickname
      const user = window.firebaseAuth.currentUser;
      if (user) {
         document.getElementById('profileName').textContent = user.email.split('@')[0];
      }
    }
  } catch (error) {
    console.error("Error loading patient profile:", error);
    document.getElementById('profileName').textContent = "Error loading data";
  }
}





</script>
</body>
</html>